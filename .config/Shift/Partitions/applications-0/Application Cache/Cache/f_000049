webpackJsonp([17],{1630:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i(1631)},1631:function(e,t,i){"use strict";var n=this&&this.__assign||function(){return(n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++){t=arguments[i];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=teamspace.services,r=i(1632),s=i(1637),d=function(){function e(e,t,i,n,o,r,s){var d=this;this.constants=e,this.storageService=t,this.loggingService=i,this.$window=n,this.settingsService=o,this.shellService=r,this.$injector=s,this.enabled=!0,this.loaded=!0,this.logger=i.newLogger("MW::MultiWindowServiceLazy"),n.desktopSettings&&n.desktopSettings.enableMultiWindowForceClose||n.addEventListener("beforeunload",function(){return d.closeAllWindows()})}return e.$inject=["constants","storageService","loggingService","$window","settingsService","shellService","$injector"],Object.defineProperty(e.prototype,"numChildWindows",{get:function(){return this.windowManager?this.windowManager.numChildWindows:0},enumerable:!0,configurable:!0}),e.prototype.openWindow=function(e,t){if(!e||!e.isValid())return this.logger.error("Attempted to create new child window but invalid parameters were given."),Promise.resolve(void 0);var i,r=e.createWindowDefinition();return this.logger.info("Opening new window of type="+r.type+" with id="+r.windowId+", contentId="+(r.content&&r.content.id)+"."),r&&(i=n({},r,{isFocused:!1,state:o.WindowState.Initializing}),this.windowManager.launchNewWindow(i,t),this.notifyListeners(i)),Promise.resolve(i)},e.prototype.findWindow=function(e){var t=this.windowManager.findWindow(e);return t?this.logger.debug("findWindow found window "+t.windowId):this.logger.debug("findWindow did not find window matching params: "+(e?JSON.stringify(e):"")),t},e.prototype.broadcastToAllWindows=function(e){e&&e.eventId&&this.windowManager.executeOnEachWindow(function(t){t.windowRef.postMessage(e)})},e.prototype.requestToAllWindows=function(e,t){var i=this;return new Promise(function(n,r){if(e&&e.eventId){var s=[];i.windowManager.executeOnEachWindow(function(i){i.state!==o.WindowState.Crashed&&i.state!==o.WindowState.Closed&&s.push(i.windowRef.requestMessage(e,t).then(function(e){return{event:e,childWindow:i}}))}),i.$window.setTimeout(function(){r("Request timed out to child windows.")},2*t),Promise.all(s).then(function(e){n(e)}).catch(function(e){var t="Unknown error occurred during requestToAllWindows: error="+e+".";i.logger.error(t),r(t)})}else r("Invalid parameters given.")})},e.prototype.closeAllWindows=function(e){var t=this;void 0===e&&(e=!0);return this.logger.info("Starting to close all child windows and will persist: "+e+"."),new Promise(function(i){if(0!==t.windowManager.numChildWindows){var n=t.$window.setInterval(function(){var e=!t.windowManager,o=e||0===t.windowManager.numChildWindows;(e||o)&&(t.$window.clearInterval(n),e&&t.logger.warn("Could not confirm all child windows were closed before resources freed."),o&&t.logger.info("All windows confirmed closed."),i())},100);t.$window.setTimeout(function(){i()},5e3),e&&(t.windowManager.persistOpenWindowsToStorage(!0),t.windowManager.persistDuringTearingDown=!0),t.windowManager.executeOnEachWindow(function(e){e.windowRef.close()}),t.windowManager.persistDuringTearingDown=!1}else i()})},e.prototype.subscribeForNewWindowEvents=function(e,t){t&&(this.registeredNewWindowListeners.push(t),this.logger.info("New subscriber for new window events registers by "+e+", totalListeners="+this.registeredNewWindowListeners.length+"."))},e.prototype.initializeLazyService=function(){var e=this;this.additionalEntryPointsEnabled=this.settingsService.valueAsBoolean(this.constants.settings.names.enableMultiWindowAdditionalEntryPoints),this.serviceWrapper=new s.AngularServiceWrapper(this.constants,this.$injector),this.windowManager=new r.WindowManager(this.$window,this.constants,this.storageService,this.logger,this.shellService,this.serviceWrapper),o.WindowParams.settingsService=this.settingsService,o.WindowParams.constants=this.constants,o.WindowParams.generateUuid=function(){return e.serviceWrapper.generateUuid()};try{this.serviceWrapper.initialize(),this.windowManager.reloadPersistedWindows(function(t){return e.notifyListeners(t)})}catch(e){this.logger.error("Error hit recovering persisted windows: "+e)}},e.prototype.teardown=function(){var e=this;return this.logger.info("Commencing teardown."),this.closeAllWindows(!0).then(function(){e.additionalEntryPointsEnabled=!1,e.listenerBuffer=void 0,e.windowManager=void 0,e.serviceWrapper=void 0})},e.prototype.notifyListeners=function(e){if(e.windowRef)for(var t=0;t<this.registeredNewWindowListeners.length;t++)this.registeredNewWindowListeners[t](e)},Object.defineProperty(e.prototype,"registeredNewWindowListeners",{get:function(){return this.listenerBuffer||(this.listenerBuffer=[]),this.listenerBuffer},enumerable:!0,configurable:!0}),e}();t.MultiWindowServiceLazy=d,angular.module("teamspace.multiWindowServiceLazy",["teamspace.shellService","teamspace.constants"]).service("multiWindowServiceLazy",d)},1632:function(e,t,i){"use strict";var n=this&&this.__assign||function(){return(n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++){t=arguments[i];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=teamspace.services,r=i(1633),s=function(){function e(e,t,i,n,o,s){this.window=e,this.constants=t,this.storageService=i,this.logger=n,this.persistDuringTearingDown=!1,this.childrenWindows={},this.windowCount=0,this.windowProvider=new r.ElectronWindowProvider(e,t,this,s,n.service,o);this.debouncedPersistOpenWindowsToStorage=_.debounce(this.persistanceToStorageHelper.bind(this),1e3)}return Object.defineProperty(e.prototype,"numChildWindows",{get:function(){return this.windowCount},enumerable:!0,configurable:!0}),e.prototype.launchNewWindow=function(e,t,i){void 0===i&&(i=!1);var n=this.findWindow({contentId:e.content.id});n?i||n.windowRef.focus():(this.logger.info("Launching new window: id="+e.windowId+", type="+e.type+", entryPoint="+t+"."),this.windowProvider.createWindow(e,t),e.windowRef?(e.contentToRender&&e.windowRef.setBody(e.contentToRender),this.addWindow(e),i||this.persistOpenWindowsToStorage()):this.logger.error("ERROR: We expected a window handle to be created but there was a failure!"))},e.prototype.removeWindow=function(e,t){void 0===t&&(t=!this.persistDuringTearingDown),e&&this.childrenWindows[e.windowId]?(this.logger.info("Removing child window: id="+e.windowId+"."),this.logger.service.event(this.constants.events.multiWindow.close,{windowId:e.windowId}),delete this.childrenWindows[e.windowId],this.windowCount--,t&&this.persistOpenWindowsToStorage()):this.logger.warn("Tried to close window that isn't tracked "+(e?e.windowId:"undefined")+".")},e.prototype.getWindow=function(e){var t;return e&&(t=this.childrenWindows[e]),t},e.prototype.getValidWindow=function(e){if(e&&this.childrenWindows[e]){var t=this.childrenWindows[e];if(t.windowRef&&t.windowRef.isValid())return t;this.removeWindow(t)}},e.prototype.updateWindow=function(e,t){if(e&&t){if(this.logger.info("Child window updated, id="+t.newId+", type="+t.newType+"."),t.newId){var i=this.findWindow({contentId:t.newId});i&&i.windowId!==e.windowId&&i.windowRef.close(),e.content.id=t.newId,this.persistOpenWindowsToStorage()}t.newType&&(e.type=o.WindowParams.convertExperienceIdToString(t.newType))}},e.prototype.findWindow=function(e){var t;return e&&(e.windowId&&(t=this.getValidWindow(e.windowId)),!t&&e&&(t=this.searchWindowContent(e))),t},e.prototype.executeOnEachWindow=function(e){for(var t in this.childrenWindows){var i=this.getValidWindow(t);i&&e(i)}},e.prototype.persistOpenWindowsToStorage=function(e){void 0===e&&(e=!1),this.logger.info("Persisting current windows: immediate="+e+", windowCount="+this.numChildWindows+"."),e?this.persistanceToStorageHelper():this.debouncedPersistOpenWindowsToStorage()},e.prototype.reloadPersistedWindows=function(e){var t=this,i=this.loadOpenedWindowsFromStorage();if(i){var n=function(o){o?t.window.setTimeout(function(){o.timeOpened=Date.now(),t.launchNewWindow(o,t.constants.events.multiWindow.entryPoints.reloadPersistedWindows,!0),n(i.pop()),e&&e(o)},1e3):t.logger.info("Detected "+t.numChildWindows+" child windows from prior session and restored.")};n(i.pop())}},e.prototype.loadOpenedWindowsFromStorage=function(){var e,t=this.storageService.get(this.constants.multiWindow.storageKeys.multiWindowStorage);return t&&(e=[],_.forEach(t,function(t){e.push(n({},t,o.WindowParams.generateWindowArgs(t.type,t.content).createWindowDefinition(),{isFocused:!1,state:o.WindowState.Initializing}))})),e},e.prototype.addWindow=function(e){e&&e.windowId&&e.windowRef&&(this.logger.info("Adding child window: id="+e.windowId+"."),this.childrenWindows[e.windowId]=e,this.windowCount++)},e.prototype.persistanceToStorageHelper=function(){if(this.childrenWindows&&this.windowCount>0){var e=[];for(var t in this.childrenWindows){var i=this.childrenWindows[t];i&&i.shouldPersist&&e.push({type:i.type,timeOpened:i.timeOpened,width:i.width,height:i.height,left:i.left,top:i.top,content:i.content})}this.storageService.set(this.constants.multiWindow.storageKeys.multiWindowStorage,e)}else this.storageService.set(this.constants.multiWindow.storageKeys.multiWindowStorage,void 0)},e.prototype.searchWindowContent=function(e){if(e.hasFocus)return this.matchesCriteria(this.windowProvider.focusedChildWindow,e)?this.getValidWindow(this.windowProvider.focusedChildWindow.windowId):void 0;for(var t in this.childrenWindows){var i=this.childrenWindows[t];if(this.matchesCriteria(i,e)){var n=this.getValidWindow(t);if(n)return n}}},e.prototype.matchesCriteria=function(e,t){var i;return e&&(e.content&&t.contentId&&(i=!1!==i&&e.content.id===t.contentId),t.hasFocus&&(i=!1!==i&&e.isFocused===t.hasFocus),void 0!==t.windowState&&(i=!1!==i&&e.state===t.windowState)),!!i},e}();t.WindowManager=s},1633:function(e,t,i){"use strict";var n=this&&this.__assign||function(){return(n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++){t=arguments[i];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=teamspace.services,r=i(1634),s=i(1635),d=i(1636),a=function(){function e(t,i,n,o,r,s){this.mainRenderer=t,this.constants=i,this.windowManager=n,this.serviceWrapper=o,this.loggingService=r,this.childWindowOffsetX=e.INITIAL_NEW_WINDOW_OFFSET,this.childWindowOffsetY=e.INITIAL_NEW_WINDOW_OFFSET,this.logger=r.newLogger("MW::ElectronWindowProvider"),s?this.comms=new d.ShellWindowCommunicator(s,n,o,r):this.logger.error("Tried to create the Window Communication Provider but no communication provider was present!")}return e.prototype.createWindow=function(t,i){var n=this.logger.service.newScenario(this.constants.multiWindow.scenario.createNewWindow);n.appendEventData({entryPoint:i}),this.serviceWrapper.sendBiTelemetry(i,t.type);var o=this.mainRenderer.innerWidth,d=this.mainRenderer.innerHeight,a=this.serviceWrapper.getHostSettings(t);if(!t.initialBackgroundColor){var c=a&&a.hostSettings&&a.hostSettings.theme;this.setWindowDefBackgroundTheme(t,c)}var w={loadUrl:encodeURIComponent(t.url),usingCustomContent:!!t.contentToRender,windowId:t.windowId,windowType:t.type,controlledWindowShow:t.controlledWindowShow,hostSettings:a,perfMarkers:{windowCreateTimeFromMainRenderer:Date.now()}},h="teamsmw://"+this.constants.multiWindow.windowManager.launchWindowManager+","+JSON.stringify(w),l=this.getOpenWindowParameters(t);this.childWindowOffsetX+=e.NEW_WINDOW_OFFSET,this.childWindowOffsetX+this.constants.multiWindow.childWindow.width>o&&(this.childWindowOffsetX=e.INITIAL_NEW_WINDOW_OFFSET),this.childWindowOffsetY+=e.NEW_WINDOW_OFFSET,this.childWindowOffsetY+this.constants.multiWindow.childWindow.height>d&&(this.childWindowOffsetY=e.INITIAL_NEW_WINDOW_OFFSET);var u;try{(u=this.mainRenderer.open(h,"*",l))?(u.open?t.windowRef=new s.ElectronNativeWindowHandle(u,this.comms,t.windowId,this.constants,this.loggingService):t.windowRef=new r.ElectronChildWindowHandle(u,this.comms,t.windowId,this.constants,this.loggingService),this.registerForBaseEvents(t.windowRef,n),this.registerForTeardown(t),n.mark(this.constants.multiWindow.scenario.createNewWindowCreated,this.getTelemetryPayload(t))):this.logger.error("Error creating window: window.open returned undefined!")}catch(e){this.logger.error("Error creating window: "+e),u&&u.close()}},e.prototype.getOpenWindowParameters=function(t){t.width&&"number"==typeof t.width&&t.width>=this.constants.multiWindow.childWindow.minWidth||(t.width=(this.mainRenderer.innerWidth||1)*e.CHILD_PARENT_WIDTH_RATIO,t.width<this.constants.multiWindow.childWindow.width&&(t.width=this.constants.multiWindow.childWindow.width));var i=this.mainRenderer.screen.availWidth-e.INITIAL_NEW_WINDOW_OFFSET;if(t.width>i&&(t.width=i),!(t.height&&"number"==typeof t.height&&t.height>=this.constants.multiWindow.childWindow.minHeight)){var n=this.mainRenderer.innerHeight||1,o=t.width*e.CHILD_WIDTH_HEIGHT_RATIO,r=n*e.CHILD_HEIGHT_RATIO;t.height=Math.min(o,r);var s=t.height/e.CHILD_WIDTH_HEIGHT_RATIO;t.width>s&&(t.width=s),t.height<this.constants.multiWindow.childWindow.height&&(t.height=this.constants.multiWindow.childWindow.height),t.width<this.constants.multiWindow.childWindow.width&&(t.width=this.constants.multiWindow.childWindow.width)}var d=this.mainRenderer.screen.availHeight-e.INITIAL_NEW_WINDOW_OFFSET;return t.height>d&&(t.height=d),t.left=!isNaN(t.left)&&"number"==typeof t.left&&t.left>=0&&t.left+t.width/2<=this.mainRenderer.screen.availWidth?t.left:Math.max(this.mainRenderer.screenX,0)+this.childWindowOffsetX,t.top=!isNaN(t.top)&&"number"==typeof t.top&&t.top>=0&&t.top>=0&&t.top+t.height/2<=this.mainRenderer.screen.availHeight?t.top:Math.max(this.mainRenderer.screenY,0)+this.childWindowOffsetY,"width="+t.width+",height="+t.height+",minHeight="+this.constants.multiWindow.childWindow.minHeight+",minWidth="+this.constants.multiWindow.childWindow.minWidth+",left="+t.left+",top="+t.top+",backgroundColor="+t.initialBackgroundColor+",frame="+(t.frame?"yes":"no")+",autoHideMenuBar=yes,toolbar=no,location=yes,status=no,menubar=no,scrollbars=no"},e.prototype.getTelemetryPayload=function(e){return{elapsedTimeOpened:(new Date).getTime()-e.timeOpened,windowId:e.windowId,contentId:e.content?e.content.id:"unknown",success:!!e.windowRef,environment:"electron",type:e.type,newRenderer:!!e.contentToRender,windowsOpened:this.windowManager.numChildWindows}},e.prototype.registerForBaseEvents=function(e,t){var i=this;e&&(e.addEventListener(o.ChildWindowEventRequest.Focus,function(e,t){t.isFocused=!0,i.focusedChildWindow=t}),e.addEventListener(o.ChildWindowEventRequest.Blur,function(e,t){t.isFocused=!1,i.focusedChildWindow=void 0,e.payload&&(t.width=e.payload.width,t.height=e.payload.height,t.left=e.payload.left,t.top=e.payload.top,i.windowManager.persistOpenWindowsToStorage())}),e.addEventListener(o.ChildWindowEventRequest.WindowReady,function(e,n){i.logger.info("Child window has reported ready state: windowId:"+n.windowId+"."),n.state=o.WindowState.Active,t&&t.mark(i.constants.multiWindow.scenario.createNewWindowReady,i.getTelemetryPayload(n))}),e.addEventListener(o.ChildWindowEventRequest.WindowStart,function(e,n){t&&t.mark(i.constants.multiWindow.scenario.createNewWindowStart,i.getTelemetryPayload(n))}),e.addEventListener(o.ChildWindowEventRequest.WindowDomLoading,function(e,n){t&&t.mark(i.constants.multiWindow.scenario.createNewWindowDomLoad,i.getTelemetryPayload(n))}),e.addEventListener(o.ChildWindowEventRequest.WindowInitialized,function(e,n){i.logger.info("Child window has reported it is fully initialized: windowId:"+n.windowId+"."),t&&(t.stop(i.getTelemetryPayload(n)),t=void 0)}),e.addEventListener(o.ChildWindowEventRequest.WindowCrashed,function(e,r){var s=e.payload||{},d=e.payload&&e.payload.errorMsg;if(s.showOops){var a=s.logs&&Array.isArray(s.logs)&&s.logs.length>0,c=a?"\nLogs emitted for the child window crash:\n":"";i.logger.warn("Child window has hit an unrecovered errored state: windowId="+r.windowId+", type="+r.type+", errorMsg="+d+", errorCode="+s.errorCode+"."+c),s.errorStack&&i.logger.warn("Error Stack: "+s.errorStack),a&&s.logs.forEach(function(e){i.logger.warn(e.timeStamp+" "+e.levelName+" - "+e.message)})}r.state=o.WindowState.Crashed;var w=n({},i.getTelemetryPayload(r),{hadFocus:!!r.isFocused,killed:!!s.killed,errorMsg:d,errorCode:s.errorCode,errorDescription:s.errorDescription,errorContext:s.errorContext,errorSubContext:s.errorSubContext,errorStack:s.errorStack,showOops:!!s.showOops,experienceClientVersion:s.clientVersion,isDuringAlt:!!t,experienceType:o.WindowParams.convertExperienceIdToString(s.experienceId)});r.url&&!r.url.includes("dev.local")&&(i.logger.service.newScenario(i.constants.multiWindow.scenario.crashedWindow).stop(w),t&&s.showOops&&(t.fail(w),t=void 0))}),e.addEventListener(o.ChildWindowEventRequest.WillNavigate,function(e,t){i.logger.info("Child window tried to navigate to a new page (blocked): windowId:"+t.windowId+"!")}),e.addEventListener(o.ChildWindowEventRequest.DidNavigationInPage,function(e,t){var n=e.payload&&e.payload.url;n?i.logger.info("Child window navigated inplace: windowId:"+t.windowId+", url:"+n+"."):i.logger.error("We received a request to change inplace navigation but no url was provided.")}),e.addEventListener(o.ChildWindowEventRequest.NewWindow,function(e,t){i.logger.info("Child window requested to open new window directly (blocked): windowId:"+t.windowId+", url:"+(e.payload&&e.payload.url)+".")}),e.addEventListener(o.ChildWindowEventRequest.AadGetToken,function(e,t){var n=o.ChildWindowEventRequest.AadGetToken,r={eventId:n,correlationId:e.correlationId};if(e.correlationId&&e.payload){var s=e.payload.resource;i.logger.debug("Child window requested AAD token: windowId="+t.windowId+", resource="+s+", correlationId="+e.correlationId),i.serviceWrapper.getAadToken(s).then(function(e){r.payload={token:e},t.windowRef.postMessage(r)}).catch(function(n){i.logger.error("ERROR: failed to get auth token: windowId="+t.windowId+", correlationId="+e.correlationId+", error="+n),r.error={context:"AadGetToken",message:n},t.windowRef.postMessage(r)})}else{var d="Expected payload or correlationId for "+n+" but got none.";i.logger.error(d),r.error={context:"AadGetToken",message:d},t.windowRef.postMessage(r)}}),e.addEventListener(o.ChildWindowEventRequest.AadGetCurrentUser,function(e,t){var n={eventId:o.ChildWindowEventRequest.AadGetCurrentUser,correlationId:e.correlationId};if(e.correlationId)i.logger.info("Child window requested current logged in user: windowId="+t.windowId+", correlationId="+e.correlationId),i.serviceWrapper.getAuthUser().then(function(e){n.payload={authUser:e},t.windowRef.postMessage(n)}).catch(function(o){i.logger.debug("ERROR: failed to get current logged in user: windowId="+t.windowId+", correlationId="+e.correlationId+", error="+o),n.error={context:"AadGetCurrentUser",message:o},t.windowRef.postMessage(n)});else{var r="ERROR: AadGetCurrentUser request was made but no correlationId was given.";i.logger.error(r),n.error={context:"AadGetCurrentUser",message:r},t.windowRef.postMessage(n)}}),e.addEventListener(o.ChildWindowEventRequest.AadClearCache,function(e,t){if(e.payload){var n=e.payload.resource;i.logger.debug("Child window requested clear adal cache: windowId="+t.windowId+", resource="+n+", correlationId="+e.correlationId),i.serviceWrapper.clearAadCache(n)}else{var r=o.ChildWindowEventRequest.AadClearCache;i.logger.error("Expected data for "+r+" but got none.")}}),e.addEventListener(o.ChildWindowEventRequest.UpdateWindowState,function(e,t){if(e.payload&&e.payload.childSettings){var n=e.payload.childSettings;if(i.windowManager.updateWindow(t,n),n.appState){var r=n.appState,s=t.state;r!==o.ApplicationState.Inactive&&r!==o.ApplicationState.LongInactive||s!==o.WindowState.Active?r===o.ApplicationState.Interactive&&(t.state=o.WindowState.Active,i.serviceWrapper.emitMessage("IdleEnd")):t.state=o.WindowState.Idle}}else{var d=o.ChildWindowEventRequest.UpdateWindowState;i.logger.error("Expected data for "+d+" but got none.")}}),e.addEventListener(o.ChildWindowEventRequest.RequestShellToOpen,function(e,t){if(e.payload){var n=e.payload.openType,r=e.payload.openHandler,s=e.payload.handlerParams;if(void 0!==n&&void 0!==r){var d=!1;switch(i.logger.info("Child window "+t.windowId+" requesting to open new window: openType:"+n+", openHandler:"+r+"."),n){case o.OpenType.OpenInNewChildWindowFallBackToMain:(d=i.serviceWrapper.openWindow(r,s))||(d=i.serviceWrapper.navigateMainWindow(r,s));break;case o.OpenType.OpenInNewChildWindow:d=i.serviceWrapper.openWindow(r,s);break;case o.OpenType.OpenOnMainRenderer:d=i.serviceWrapper.navigateMainWindow(r,s)}d||i.logger.warn("No handlers found for "+r+" for openType="+n)}else i.logger.error("Expected data for "+event+" but got none.")}else{var a=o.ChildWindowEventRequest.RequestShellToOpen;i.logger.error("Expected data for "+a+" but got none.")}}),e.addEventListener(o.ChildWindowEventRequest.GetStateData,function(e,t){var n={eventId:o.ChildWindowEventRequest.GetStateData,correlationId:e.correlationId},r=Promise.resolve();switch(i.logger.info("Child window requested state data: windowId="+t.windowId+", correlationId="+e.correlationId+", requestType="+e.payload.requestType),e.payload.requestType){case"hostSettings":n.payload={hostSettings:i.serviceWrapper.getHostSettings(t)};break;case"skypeToken":r=i.serviceWrapper.getSkypeToken().then(function(e){n.payload={skypeTokenData:e}});break;default:n.error={context:"GetStateData",message:"requestType not supported"}}r.then(function(){t.windowRef.postMessage(n)}).catch(function(o){i.logger.error("GetStateData: Received error trying to process request: "+e.payload.requestType+", error="+(o.message?o.message:o)+"."),n.error={context:"GetStateData",message:o},t.windowRef.postMessage(n)})}))},e.prototype.registerForTeardown=function(e){var t=this;this.comms.registerForTeardown(e.windowId,function(){if(e){t.windowManager.removeWindow(e),e.state=o.WindowState.Closed,t.windowManager.numChildWindows<=0&&(t.logger.info("Focusing out from main window"),t.serviceWrapper.emitMessage(t.constants.events.desktopApp.windowIsFocused,!0));var i={elapsedTimeOpened:(new Date).getTime()-e.timeOpened,type:e.type,windowsOpened:t.windowManager.numChildWindows};t.logger.service.newScenario(t.constants.multiWindow.scenario.closedWindow).stop(i),t.mainRenderer.localStorage.removeItem("persistedDiagnostics-"+e.windowId)}})},e.prototype.setWindowDefBackgroundTheme=function(e,t){var i;switch(t){case"dark":i=this.constants.files.themes.darkPalette.neutralLight;break;case"contrast":i=this.constants.files.themes.contrastPalette.appBlackFull;break;default:i=this.constants.files.themes.default.neutralLighter}e.initialBackgroundColor=i},e.INITIAL_NEW_WINDOW_OFFSET=100,e.NEW_WINDOW_OFFSET=20,e.CHILD_WIDTH_HEIGHT_RATIO=1.125,e.CHILD_HEIGHT_RATIO=.72,e.CHILD_PARENT_WIDTH_RATIO=.4,e}();t.ElectronWindowProvider=a},1634:function(e,t,i){"use strict";var n=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++){t=arguments[i];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var r=teamspace.services,s=function(e){function t(t,i,n,o,r){var s=e.call(this,n,o)||this;return s.electronProxy=t,s.comms=i,s.logger=r.newLogger("MW::ElectronChildWindowHandle"),s}return n(t,e),t.prototype.blur=function(){var e=r.ChildWindowEventSendOnly.BlurChildWindow;this.recordAction(e),this.postMessage({eventId:e},void 0)},t.prototype.close=function(){this.recordAction(r.ChildWindowEventRequest.Closed),this.electronProxy&&!this.electronProxy.closed&&(this.electronProxy.close(),this.postMessage({eventId:r.ChildWindowEventSendOnly.CloseChildWindow},void 0))},t.prototype.focus=function(){var e=r.ChildWindowEventSendOnly.FocusChildWindow;this.recordAction(e,!0),this.postMessage({eventId:e},void 0)},t.prototype.flashTaskbarIcon=function(){var e=r.ChildWindowEventSendOnly.FlashChildWindowTaskbarIcon;this.recordAction(e,!0),this.postMessage({eventId:e},void 0)},t.prototype.unflashTaskbarIcon=function(){var e=r.ChildWindowEventSendOnly.UnflashChildWindowTaskbarIcon;this.recordAction(e,!0),this.postMessage({eventId:e},void 0)},t.prototype.postMessage=function(e,t){void 0===t&&(t=this.windowId);var i=o({windowId:t},e);this.comms.sendEvent(i)},t.prototype.requestMessage=function(e,t){void 0===t&&(t=this.defaultRequestTimeoutMs);var i=o({windowId:this.windowId},e);return this.comms.request(i,t)},t.prototype.setBody=function(e){},t.prototype.isValid=function(){return this.electronProxy&&!this.electronProxy.closed},t.prototype.addEventListener=function(e,t,i){var n=i&&i.once;this.comms.registerListener(this.windowId,e,t,n)},t.prototype.removeEventListener=function(e,t){this.comms.removeListener(this.windowId,e,t)},t}(i(201).BaseWindowHandle);t.ElectronChildWindowHandle=s},1635:function(e,t,i){"use strict";var n=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),o=this&&this.__assign||function(){return(o=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++){t=arguments[i];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var r=teamspace.services,s=function(e){function t(t,i,n,o,r){var s=e.call(this,n,o)||this;return s.windowRef=t,s.comms=i,s.logger=r.newLogger("MW::ElectronNativeWindowHandle"),s}return n(t,e),t.prototype.blur=function(){var e=r.ChildWindowEventSendOnly.BlurChildWindow;this.recordAction(e),this.postMessage({eventId:e},void 0)},t.prototype.close=function(){this.recordAction(r.ChildWindowEventRequest.Closed),this.windowRef.close(),this.postMessage({eventId:r.ChildWindowEventSendOnly.CloseChildWindow},void 0)},t.prototype.focus=function(){var e=r.ChildWindowEventSendOnly.FocusChildWindow;this.recordAction(e,!0),this.postMessage({eventId:e},void 0)},t.prototype.flashTaskbarIcon=function(){var e=r.ChildWindowEventSendOnly.FlashChildWindowTaskbarIcon;this.recordAction(e,!0),this.postMessage({eventId:e},void 0)},t.prototype.unflashTaskbarIcon=function(){var e=r.ChildWindowEventSendOnly.UnflashChildWindowTaskbarIcon;this.recordAction(e,!0),this.postMessage({eventId:e},void 0)},t.prototype.postMessage=function(e,t){void 0===t&&(t=this.windowId);var i=o({windowId:t},e);this.comms.sendEvent(i)},t.prototype.requestMessage=function(e,t,i){void 0===t&&(t=this.defaultRequestTimeoutMs),void 0===i&&(i=this.windowId);var n=o({windowId:i},e);return this.comms.request(n,t)},t.prototype.setBody=function(e){var t=this,i=function(){t.windowRef.document.body.appendChild(e)};"complete"!==this.windowRef.document.readyState?this.windowRef.document.addEventListener("DOMContentLoaded",function(){i()},{once:!0}):i()},t.prototype.isValid=function(){return!!this.windowRef},t.prototype.addEventListener=function(e,t,i){var n=i&&i.once;this.comms.registerListener(this.windowId,e,t,n)},t.prototype.removeEventListener=function(e,t){this.comms.removeListener(this.windowId,e,t)},t}(i(201).BaseWindowHandle);t.ElectronNativeWindowHandle=s},1636:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=teamspace.services,o=function(){function e(e,t,i,n){this.shellService=e,this.windowManager=t,this.serviceWrapper=i,this.logger=n.newLogger("MW::ShellWindowComms"),this.commsProvider=e.getCommunicationProvider(),this.subscriptionManager=e.RxJS.createSubject(),this.tearDownManager=e.RxJS.createSubject(),this.closeEventObservableCache=new Map}return e.prototype.sendEvent=function(e){this.commsProvider.getStream(e.eventId).next(e,e.windowId,this.shellService.MAIN_PROCESS_ID)},e.prototype.request=function(e,t){var i=this;return new Promise(function(n,o){var r,s=function(t){clearTimeout(r),t||i.logger.warn("Window request to child window failed to get event data back: event="+e.eventId+", windowId="+e.windowId+"."),n(t)};r=setTimeout(function(){i.removeListener(e.windowId,e.eventId,s),i.logger.warn("Window request to child window timeout: event="+e.eventId+", windowId="+e.windowId+"."),n(void 0)},t),i.registerListener(e.windowId,e.eventId,s,!0,e.correlationId),i.sendEvent(e)})},e.prototype.registerListener=function(e,t,i,o,r){var s=this;if(void 0===o&&(o=!1),e&&t&&i){var d=this.shellService.RxJS;this.logger.debug("Event subscribed: windowId="+e+", event="+t+".");var a=this.createStreamOnWindow(e,t),c=this.subscriptionManager.pipe(d.filter(function(n){return!(n.windowId!==e||void 0!==n.event&&n.event!==t||void 0!==n.correlationId&&n.correlationId!==r||void 0!==n.listener&&n.listener!==i)}),d.tap(function(){s.logger.debug("Event unsubscribed: windowId="+e+", event="+t+".")}));(o||t===n.ChildWindowEventRequest.Closed?a.pipe(d.first(),d.takeUntil(c)):a.pipe(d.takeUntil(c))).subscribe(function(t){var n=s.windowManager.getWindow(e);i(t,n)},function(e){s.logger.error("Subscribe encountered error: "+(e.message?e.message:e))})}},e.prototype.removeListener=function(e,t,i,n){this.subscriptionManager.next({windowId:e,event:t,listener:i,correlationId:n})},e.prototype.registerForTeardown=function(e,t){var i=this,n=this.shellService.RxJS;this.tearDownManager.asObservable().pipe(n.filter(function(t){return t===e}),n.first()).subscribe(function(){i.logger.info("Tearing down window: "+e),t(),i.subscriptionManager.next({windowId:e})})},e.prototype.createStreamOnWindow=function(e,t){var i,o=this,r=this.shellService.RxJS;if(t===n.ChildWindowEventRequest.Closed)this.closeEventObservableCache.has(e)?i=this.closeEventObservableCache.get(e):(i=(s=this.commsProvider.getStream(t).asObservable()).pipe(r.filter(function(t){return t.windowId===e}),r.finalize(function(){o.tearDownManager.next(e)}),r.share()),this.closeEventObservableCache.set(e,i));else{var s=this.commsProvider.getStream(t).asObservable();i=s.pipe(r.filter(function(t){return t.windowId===e}))}return i},e}();t.ShellWindowCommunicator=o},1637:function(e,t,i){"use strict";var n=this&&this.__assign||function(){return(n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++){t=arguments[i];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var o=teamspace.services,r=function(){function e(e,t){this.constants=e,this.$injector=t,this.maxPromiseDelayMs=2e4}return e.prototype.initialize=function(){this.eventingService=this.$injector.get("eventingService"),this.authenticationService=this.$injector.get("authenticationService"),this.navigationService=this.$injector.get("navigationService"),this.myUserPreferencesStore=this.$injector.get("myUserPreferencesStore"),this.multiWindowService=this.$injector.get("multiWindowService"),this.utilityService=this.$injector.get("utilityService"),this.brbFeedbackService=this.$injector.get("brbV2FeedbackService"),this.settingsService=this.$injector.get("settingsService"),this.conversationService=this.$injector.get("conversationsService"),this.localizationService=this.$injector.get("localizationService"),this.appStateService=this.$injector.get("appStateService"),this.messageHubService=this.$injector.get("messageHubService"),this.geoRoutingService=this.$injector.get("geoRoutingService"),this.immersiveReaderService=this.$injector.get("immersiveReaderService"),this.loggingService=this.$injector.get("loggingService"),this.sxConfig=this.$injector.get("sxConfig"),this.analyticsService=this.$injector.get("analyticsService"),this.logger=this.loggingService.newLogger("MW::ServiceWrapper")},e.prototype.emitMessage=function(e,t){this.eventingService.$emit(e,t)},e.prototype.sendBiTelemetry=function(e,t){var i={action:{gesture:void 0,outcome:teamspace.shared.AttributeHelper.tryGetEnumString(teamspace.components.PanelActionOutcome.popOutToNewWindow,teamspace.components.PanelActionOutcome),scenario:teamspace.components.PanelActionScenario.popOutChat,scenarioType:teamspace.components.PanelActionScenarioType.clickButton},panel:{type:e,uri:void 0,uriParams:void 0,viewId:t}};this.analyticsService.sendPanelAction(i)},e.prototype.getAadToken=function(e){return this.utilityService.getPromiseWithTimeout(this.authenticationService.getAuthTokens([e]),this.maxPromiseDelayMs,void 0,"Webclient Auth request reached maximum timeout.")},e.prototype.getSkypeToken=function(){var e=this;return this.utilityService.getPromiseWithTimeout(this.authenticationService.getSkypeTokens().then(function(t){return{token:t,regionGtms:e.geoRoutingService.getCurrentRoutingTable()}}),this.maxPromiseDelayMs,void 0,"Webclient Auth request reached maximum timeout.")},e.prototype.getAuthUser=function(){return this.utilityService.getPromiseWithTimeout(this.authenticationService.getUserInformation(),this.maxPromiseDelayMs,void 0,"Webclient Auth request reached maximum timeout.")},e.prototype.clearAadCache=function(e){e&&this.authenticationService.clearAdalCache(e)},e.prototype.generateUuid=function(){return this.utilityService.generateUUID()},e.prototype.getHostSettings=function(e){var t=this.settingsService.getSettings(),i=!t.runningscenariotests&&void 0;return{default:n({},t,{isLPCEnabled:i}),hostSettings:{keyboardLayoutLanguage:this.localizationService.getKeyboardLayout(),localeCode:this.settingsService.getCurrentLocale(),theme:this.settingsService.getActiveTheme(),performanceMode:this.settingsService.getPerformanceMode(),appState:this.appStateService.current,createdTime:e.timeOpened,windowTemplateData:e.content&&e.content.metaData,canGetSkypeToken:"mainRenderer",canGetAadToken:"mainRenderer",hostAppWebVersion:this.settingsService.getVersion().clientVersion,cdlSharedWorkerUrl:window.cdlSharedWorkerJsUrl},dataLayerSettings:n({},this.messageHubService&&this.messageHubService.getSupportedOperations?this.messageHubService.getSupportedOperations():{}),bootstrapData:this.getBootstrapData()}},e.prototype.navigateMainWindow=function(e,t){var i=this,n="multi-window-child-request";switch(e){case o.OpenHandler.Chat:return this.navigationService.navigateToChat(t.conversationId,n),!0;case o.OpenHandler.ChannelTab:return this.navigationService.navigateToChannel(t.channelId,n,t.tabId),!0;case o.OpenHandler.BRBFeedbackDialog:return this.brbFeedbackService.openDialog(void 0,void 0,t.feedbackCategory),!0;case o.OpenHandler.ChatWithUser:var r=this.getConversationFromMri(t.mri,!0);return!!r&&(this.navigationService.navigateToChat(r.id,n),!0);case o.OpenHandler.ImmersiveReader:return this.immersiveReaderService.launchImmersiveReaderRemote(t.conversationId,t.messageId).catch(function(e){i.logger.error("Unable to launch immersive reader from remote, reason: "+e)}),!0;case o.OpenHandler.OrgChart:return this.navigationService.navigateToPerson(t.mri,this.constants.peopleTab.panes.organization,!1),!0;default:return!1}},e.prototype.openWindow=function(e,t){switch(e){case o.OpenHandler.Chat:return this.multiWindowService.openWindow(new o.ChatChildWindowParams(t.coversationId),this.constants.events.multiWindow.entryPoints.childWindowRequest),!0;case o.OpenHandler.ChatWithUser:var i=this.getConversationFromMri(t.mri);return!(!i||!this.conversationService.canConversationPopOut(i))&&(this.multiWindowService.openWindow(new o.ChatChildWindowParams(i.id),this.constants.events.multiWindow.entryPoints.childWindowRequest),!0);default:return!1}},e.prototype.getConversationFromMri=function(e,t){void 0===t&&(t=!1);var i;return e&&!(i=this.conversationService.findConversationWith(e))&&t&&(i=this.conversationService.getConversationLieWith(e)),i},e.prototype.getBootstrapData=function(){var e=this.geoRoutingService.getCurrentRoutingTable(),t=e.regionName,i=this.sxConfig.getCurrentSkypeMri();return{readReceiptUserPreference:this.myUserPreferencesStore.getUserPreferences().readReceiptsEnabled,theme:this.settingsService.getActiveTheme(),userId:i,region:t,regionGtms:e}},e}();t.AngularServiceWrapper=r},201:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){this.windowId=e,this.constants=t,this.defaultRequestTimeoutMs=2e3}return e.prototype.recordAction=function(e,t){if(void 0===t&&(t=!1),this.logger.info("Window action performed; action="+e+" id="+this.windowId+"."),event){var i={windowId:this.windowId,action:e};this.logger.service.event(this.constants.events.multiWindow.action,i)}},e}();t.BaseWindowHandle=n}},[1630]);
//# sourceMappingURL=https://statics.teams.microsoft.com/hashedjs/lazy-ng1-mod-multi-window-services.min.js-9908bac8.map