webpackJsonp([3],{1588:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n(1589),n(1596),n(1597),n(1598),n(1599),n(1600),n(1601),n(1602),n(1603),n(1604),n(1605),n(1606),n(139),n(1607),n(1608),n(1609),n(1610),n(1611),n(1627),n(1628),n(1629),angular.module("teamspace.cortanaService",["teamspace.cortanaJSService"]).factory("cortanaService",["$injector",function(e){return e.get("cortanaJSService")}])},1589:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1590),o=n(195),r=function(){function e(e,t){var n=this;this.constants=e,this.loggingService=t,this.logger=t.newLogger("AudioMediaDeviceService"),this.devices=new Map,this.availableMediaDevices={},this.availableMediaDevices[o.SystemMediaDeviceKind.audioInput]=new Map,this.availableMediaDevices[o.SystemMediaDeviceKind.audioOutput]=new Map,this.availableMediaDevices[o.SystemMediaDeviceKind.videoInput]=new Map,this.updateCurrentDevice();var i=_.debounce(function(){return n.updateCurrentDevice()},250);navigator&&navigator.mediaDevices&&navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",function(){i()})}return e.$inject=["constants","loggingService"],e.prototype.getAudioMediaDevice=function(t,n){if(t=t||this.currentAudioSourceDeviceId||e.defaultDeviceId,n=n||this.currentAudioSinkDeviceId||e.defaultDeviceId,!t||!n)return this.logger.error("getAudioMediaDevice error: missing devices"),null;var o=this.getDeviceKey(t,n);if(this.devices.has(o))return this.devices.get(o);var r=new i.AudioMediaDevice(t,this.logger,this.availableMediaDevices);return r.setProperties(this.enableWorklet,this.enableSpeechMode),this.devices.set(o,r),r},e.prototype.setAudioProperties=function(e,t){var n=this;this.enableWorklet=e,this.enableSpeechMode=t,this.devices.forEach(function(e){e.setProperties(n.enableWorklet,n.enableSpeechMode)})},e.prototype.getDeviceKey=function(e,t){return e+"-"+t},e.prototype.updateCurrentDevice=function(){var t=this;navigator&&navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices&&navigator.mediaDevices.enumerateDevices().then(function(n){t.currentAudioSourceDeviceId=e.defaultDeviceId,t.currentAudioSinkDeviceId=e.defaultDeviceId,n&&0!==n.length&&n.some(function(e){return e.kind===o.SystemMediaDeviceKind.audioInput})||t.logger.error("failed to find any audio input devices"),t.updateDevicesList(o.SystemMediaDeviceKind.audioInput,n),t.updateDevicesList(o.SystemMediaDeviceKind.audioOutput,n),t.logger.info("Audio Input Devices: {0}",t.availableMediaDevices[o.SystemMediaDeviceKind.audioInput].toJSON()),t.logger.info("Audio Output Devices: {0}",t.availableMediaDevices[o.SystemMediaDeviceKind.audioOutput].toJSON()),t.loggingService.newScenario(t.constants.scenarios.cortana.audioDeviceUpdated).stop({audioIn:t.availableMediaDevices[o.SystemMediaDeviceKind.audioInput].size,audioOut:t.availableMediaDevices[o.SystemMediaDeviceKind.audioOutput].size})}).catch(function(e){t.logger.error("failed to enumerate media devices")})},e.prototype.updateDevicesList=function(t,n){var i=this;this.availableMediaDevices[t].clear();var o,r;if(n.forEach(function(n){if(n.kind===t){var s=n.deviceId.toLowerCase();if(s!==e.defaultDeviceId)if(s!==e.communicationsDeviceId){var a={deviceId:n.deviceId,groupId:n.groupId,kind:n.kind,label:n.label,isDefault:!1};i.availableMediaDevices[n.kind].set(n.label,a)}else r=n;else o=n}}),o&&(s=this.getDeviceByGroupId(o.kind,o.groupId))&&(s.isDefault=!0,this.availableMediaDevices[o.kind].set(o.label,s)),r){var s=this.getDeviceByGroupId(r.kind,r.groupId);s&&this.availableMediaDevices[o.kind].set(r.label,s)}},e.prototype.getDeviceByGroupId=function(e,t){for(var n=this.availableMediaDevices[e].values(),i=n.next();i&&!i.done;){if(i.value.groupId===t)return i.value;i=n.next()}return null},e.defaultDeviceId="default",e.communicationsDeviceId="communications",e}();t.AudioMediaDeviceService=r,angular.module("teamspace.audioMediaDeviceService",["teamspace.loggingService"]).service("audioMediaDeviceService",r)},1590:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(193),o=n(1591),r=n(195),s=n(1592),a=n(1594),c=function(){function e(e,t,n){this.deviceId=e,this.logger=t,this.availableDevices=n,this.audioStreamInput=null,this.recorder=null,this.enableAudioWorklet=!1,this.enableSpeechMode=!1,this.player=new a.PCMPlayer,navigator.mediaDevices&&navigator.mediaDevices.getSupportedConstraints?this.supportedConstraints=navigator.mediaDevices.getSupportedConstraints():this.supportedConstraints={}}return e.prototype.acquireAudioInputStream=function(){var e=this;return this.deviceId?navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?this.audioStreamInput?(this.logger.error("active input stream exists"),Promise.resolve(!1)):(this.logger.info("acquiring audio input stream"),this.audioStreamInput={audioCtx:null},new Promise(function(t,n){var i={echoCancellation:!0,noiseSuppression:!0};e.logger.info("MSFT speech mode supported: {0} enabled: {1}",!!e.supportedConstraints.msftSpeechMode,e.enableSpeechMode),e.supportedConstraints.msftSpeechMode&&(i.msftSpeechMode=e.enableSpeechMode),!i.msftSpeechMode&&e.supportedConstraints.echoCancellationType&&(i.echoCancellationType="system");var o=setTimeout(function(){e.logger.error("timeout getUserMedia"),t(!1)},15e3);navigator.mediaDevices.getUserMedia({audio:i,video:!1}).then(function(n){if(clearTimeout(o),n&&e.audioStreamInput){if(e.audioStreamInput.mediaStream=n,e.availableDevices[r.SystemMediaDeviceKind.audioInput].has("")&&navigator.mediaDevices.dispatchEvent){try{navigator.mediaDevices.dispatchEvent(new Event("devicechange"))}catch(n){e.logger.info("failed to dispatch devicechange event"),t(!0)}return setTimeout(function(){return t(!0)},500)}t(!0)}else t(!1)},function(n){clearTimeout(o),e.logger.error("getUserMedia: {0}",n&&n.message||""),e.cleanUpInputAudioStream(),t(!1)}).catch(function(n){clearTimeout(o),e.logger.error("getUserMedia exception: {0}",n&&n.message||""),t(!1)})})):(this.logger.error("navigator.mediaDevices or getUserMedia not available"),Promise.resolve(!1)):(this.logger.error("cannot get input stream: no device"),Promise.resolve(!1))},e.prototype.startListening=function(e){if(!this.audioStreamInput)return this.logger.error("no audio input stream available"),Promise.resolve(null);if(this.audioStreamInput&&this.audioStreamInput.audioCtx)return this.logger.error("active listening stream exists"),Promise.resolve(null);o.AudioSourceFormat.PCM16k16bitRiff;var t=this.createAudioContext();if(!t)return Promise.resolve(null);try{this.audioStreamInput.audioCtx=t,this.audioStreamInput.stream=new i.Stream(this.deviceId),this.recorder=new s.PCMRecorder(this.enableAudioWorklet);var n=this.getStreamBufferSize(t.sampleRate,.15);return this.logger.info("source sampling rate: {0} size: {1}",t.sampleRate,n),this.recorder.record(this.audioStreamInput,n),Promise.resolve(this.audioStreamInput.stream.getReader())}catch(e){return this.logger.error("startListening failed: {0}",e&&e.message||e),this.cleanUpInputAudioStream(),Promise.resolve(null)}},e.prototype.stopListening=function(){this.audioStreamInput&&this.cleanUpInputAudioStream()},e.prototype.playFromBuffer=function(e){var t=this;if(!this.player||!e||0===e.length)return Promise.resolve(!0);if(this.audioStreamOutput)return this.logger.warn("previous playback has not completed yet"),Promise.resolve(!1);var n=this.createAudioContext();return n?(this.audioStreamOutput={audioCtx:n},this.player.playFromBuffer(this.audioStreamOutput,e).then(function(){return t.cleanUpOutputAudioStream(),!0}).catch(function(){return t.cleanUpOutputAudioStream(),!1})):Promise.resolve(!1)},e.prototype.playFromStream=function(e){var t=this;if(!this.player||!e)return Promise.resolve(!1);if(this.audioStreamOutput)return this.logger.warn("previous playback has not completed yet"),Promise.resolve(!1);var n=this.createAudioContext();return n?(this.audioStreamOutput={audioCtx:n},this.player.playFromStream(this.audioStreamOutput,e,this.getStreamBufferSize(n.sampleRate,.5)).then(function(){return t.cleanUpOutputAudioStream(),!0}).catch(function(){return t.cleanUpOutputAudioStream(),!1})):Promise.resolve(!1)},e.prototype.stopPlaying=function(){this.player&&this.audioStreamOutput&&this.player.stop(this.audioStreamOutput)},e.prototype.getAudioInputMediaDeviceInfo=function(){if(this.audioInputDeviceInfo)return this.audioInputDeviceInfo;if(!this.audioStreamInput||!this.audioStreamInput.mediaStream)return null;var t=this.audioStreamInput.mediaStream.getAudioTracks();if(!t||0===t.length)return null;var n=t[0];if(n&&n.label&&this.availableDevices){var i=this.availableDevices[r.SystemMediaDeviceKind.audioInput].get(n.label);if(!i)return this.logger.info("cannot find device info from available devices"),null;var o=void 0,s=void 0,a=i.label.match(e.labelRegex);a&&a.length>2?(o=a[2],s=a[1]):o=a&&a.length>1?a[1]:i.label,this.audioInputDeviceInfo={model:o,type:s}}return this.audioInputDeviceInfo},e.prototype.setProperties=function(e,t){this.enableAudioWorklet=e,this.enableSpeechMode=t},e.prototype.cleanUpInputAudioStream=function(){this.cleanUpAudioStream(this.audioStreamInput,this.recorder,null),this.audioStreamInput=null,this.audioInputDeviceInfo=null,this.recorder=null},e.prototype.cleanUpOutputAudioStream=function(){this.cleanUpAudioStream(this.audioStreamOutput,null,this.player),this.audioStreamOutput=null},e.prototype.cleanUpAudioStream=function(e,t,n){e&&(e.stream&&(e.stream.getReader().close(),e.stream.close(),e.stream=null),e.scriptProcessorNode&&(e.scriptProcessorNode.disconnect(),e.scriptProcessorNode=null),e.mediaStreamSourceNode&&(e.mediaStreamSourceNode.disconnect(),e.mediaStreamSourceNode=null),e.audioWorkletNode&&(e.audioWorkletNode.disconnect(),e.audioWorkletNode=null),e.streamReader&&(e.streamReader.close(),e.streamReader=null),e.audioBufferSourceNode&&(e.audioBufferSourceNode.stop(),e.audioBufferSourceNode.disconnect(),e.audioBufferSourceNode=null),e.mediaStream&&(e.mediaStream.getTracks().forEach(function(e){"ended"!==e.readyState&&e.stop()}),e.mediaStream=null),this.closeAudioContext(e.audioCtx),e.audioCtx=null)},e.prototype.createAudioContext=function(){var e=window.AudioContext||window.webkitAudioContext||!1;return e?new e:(this.logger.error("failed to get AudioContext"),null)},e.prototype.closeAudioContext=function(e){e&&"close"in e&&e.close()},e.prototype.getStreamBufferSize=function(e,t){var n,i=32768;do{n=(i>>=1)/e}while(n>t&&i>=2048);return i},e.labelRegex=new RegExp("^([^\\(]+)\\s+\\(([^\\(\\)]+).*\\)"),e}();t.AudioMediaDevice=c},1591:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e[e.PCM16k16bitRiff=0]="PCM16k16bitRiff"}(t.AudioSourceFormat||(t.AudioSourceFormat={}))},1592:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1593),o=66,r=16e3,s=function(){function e(e){var t=new AudioWorkletNode(e.audioCtx,"teams-audiostream-processor",{processorOptions:{sourceSampleRate:e.audioCtx.sampleRate,desiredSampleRate:r}});return t.audioStream=e,t.port.onmessage=this.handleMessage.bind(t),t}return e.prototype.handleMessage=function(e){this.audioStream&&this.audioStream.stream&&e.data&&e.data.buffer&&this.audioStream.stream.write(e.data.buffer)},e}(),a=function(){function e(e){if(this.enableAudioWorklet=e,e){var t=navigator.userAgent.split(" ").find(function(e){return e.startsWith("Chrome/")}),n=t&&t.split("/")[1].split(".");t&&n&&n.length&&!(Number(n[0])<o)||(this.enableAudioWorklet=!1)}}return e.prototype.record=function(e,t){if(e.audioCtx){if(this.enableAudioWorklet){if(this.recordInternalWorklet(e))return;this.enableAudioWorklet=!1}var n=e.audioCtx.createScriptProcessor(t,1,1),o=new i.RiffPcmEncoder(e.audioCtx.sampleRate,r),s=!0;n.onaudioprocess=function(t){var n=t.inputBuffer.getChannelData(0);if(e.stream&&!e.stream.isClosed){var i=o.encode(n,s);i&&(e.stream.write(i),s=!1)}},e.mediaStreamSourceNode=e.audioCtx.createMediaStreamSource(e.mediaStream),e.scriptProcessorNode=n,e.mediaStreamSourceNode.connect(n),n.connect(e.audioCtx.destination)}},e.prototype.recordInternalWorklet=function(e){if(!e.audioCtx.audioWorklet)return!1;var t=["var RIFFConstants={headerLength:46,riffChunkId:'RIFF',dataChunkId:'data'};var RIFFHeadersOffset={riffHeaderId:0,fileSize:4,waveTag:8,waveFormatChunkLength:16,formatTag:20,channelCount:22,sampleRate:24,avgBytesPerSec:28,blockAlign:32,bitsPerSample:34,cbSize:36,dataChunkId:38,dataChunkLength:42};var RiffPcmEncoder=function(){function e(e,t){this.channelCount=1;this.actualSampleRate=e;this.desiredSampleRate=t}e.prototype.encode=function(e,t){if(!e){return null}e=this.downSampleAudioFrame(e,this.actualSampleRate,this.desiredSampleRate);var a=e.length*2;if(!t){var r=new ArrayBuffer(a);var n=new DataView(r);this.setFloatArrayToInt16(n,0,e);return r}var s=RIFFConstants.headerLength-2;var i=new ArrayBuffer(s+a);var f=16;var h=f/8;var d=0;var o=new DataView(i);this.setString(o,RIFFHeadersOffset.riffHeaderId,RIFFConstants.riffChunkId);o.setUint32(RIFFHeadersOffset.fileSize,d,true);this.setString(o,RIFFHeadersOffset.waveTag,'WAVEfmt ');o.setUint32(RIFFHeadersOffset.waveFormatChunkLength,16,true);o.setUint16(RIFFHeadersOffset.formatTag,1,true);o.setUint16(RIFFHeadersOffset.channelCount,this.channelCount,true);o.setUint32(RIFFHeadersOffset.sampleRate,this.desiredSampleRate,true);o.setUint32(RIFFHeadersOffset.avgBytesPerSec,this.desiredSampleRate*this.channelCount*h,true);o.setUint16(RIFFHeadersOffset.blockAlign,this.channelCount*h,true);o.setUint16(RIFFHeadersOffset.bitsPerSample,f,true);this.setString(o,RIFFHeadersOffset.dataChunkId-2,RIFFConstants.dataChunkId);o.setUint32(RIFFHeadersOffset.dataChunkLength-2,d,true);this.setFloatArrayToInt16(o,s,e);return i};e.prototype.setString=function(e,t,a){for(var r=0;r<a.length;r++){e.setUint8(t+r,a.charCodeAt(r))}};e.prototype.setFloatArrayToInt16=function(e,t,a){for(var r=0;r<a.length;r++,t+=2){var n=Math.max(-1,Math.min(1,a[r]));e.setInt16(t,n<0?n*32768:n*32767,true)}};e.prototype.downSampleAudioFrame=function(e,t,a){if(a===t||a>t){return e}var r=t/a;var n=Math.round(e.length/r);var s=new Float32Array(n);var i=0;var f=0;while(f<n){var h=Math.round((f+1)*r);var d=0;var o=0;while(i<h&&i<e.length){d+=e[i++];o++}s[f++]=d/o}return s};return e}();","var MaxBufferBytes=8192;var MaxChunkSizeInMs=250;var DefaultChunkSizeInMs=100;var DefaultTargetSampleRate=16e3;var AudioStreamEncodingProcessor=function(){function e(e){var r=new AudioWorkletProcessor;var s=r;s.chunkBytesThreshold=0;s.isFirstSample=true;s.audioBuffer=null;s.audioBufferOffset=0;s.streamEncoder=null;var t;var f=DefaultTargetSampleRate;var i=DefaultChunkSizeInMs;if(e&&e.processorOptions){t=e.processorOptions.sourceSampleRate;f=e.processorOptions.desiredSampleRate||f;i=e.processorOptions.chunkSizeInMs||i}i=Math.min(Math.max(i,DefaultChunkSizeInMs),MaxChunkSizeInMs);s.chunkBytesThreshold=Math.min(MaxBufferBytes,f/1e3*i*2);if(t){s.streamEncoder=new RiffPcmEncoder(t,f)}s.process=this.process.bind(s);return s}e.prototype.process=function(e,r,s){if(!this.audioBuffer){this.audioBuffer=new Uint8Array(MaxBufferBytes);this.audioBufferOffset=0}var t=e[0];var f=t&&t[0];if(!f||!this.streamEncoder){return true}var i=this.streamEncoder.encode(f,this.isFirstSample);if(!i){return true}this.isFirstSample=false;var a=new Uint8Array(i);if(a.length>MaxBufferBytes-this.audioBufferOffset){a=a.subarray(0,MaxBufferBytes-this.audioBufferOffset)}this.audioBuffer.set(a,this.audioBufferOffset);this.audioBufferOffset+=a.length;if(this.audioBufferOffset>=this.chunkBytesThreshold){this.port.postMessage(this.audioBuffer.slice(0,this.audioBufferOffset));this.audioBuffer=null}return true};return e}();","registerProcessor('teams-audiostream-processor', AudioStreamEncodingProcessor);"],n=new Blob(t,{type:"application/javascript"}),i=URL.createObjectURL(n);return e.mediaStreamSourceNode=e.audioCtx.createMediaStreamSource(e.mediaStream),e.audioCtx.audioWorklet.addModule(i).then(function(){URL.revokeObjectURL(i),e.mediaStreamSourceNode&&(e.audioWorkletNode=new s(e),e.mediaStreamSourceNode.connect(e.audioWorkletNode),e.audioWorkletNode.connect(e.audioCtx.destination))}).catch(function(e){}),!0},e}();t.PCMRecorder=a},1593:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(196),o=function(){function e(e,t){this.channelCount=1,this.actualSampleRate=e,this.desiredSampleRate=t}return e.prototype.encode=function(e,t){if(!e)return null;var n=2*(e=this.downSampleAudioFrame(e,this.actualSampleRate,this.desiredSampleRate)).length;if(!t){var o=new ArrayBuffer(n),r=new DataView(o);return this.setFloatArrayToInt16(r,0,e),o}var s=i.RIFFConstants.minHeaderLength,a=new ArrayBuffer(s+n),c=new DataView(a);return this.setString(c,i.RIFFHeadersOffset.riffHeaderId,i.RIFFConstants.riffChunkId),c.setUint32(i.RIFFHeadersOffset.fileSize,0,!0),this.setString(c,i.RIFFHeadersOffset.waveTag,"WAVEfmt "),c.setUint32(i.RIFFHeadersOffset.waveFormatChunkLength,16,!0),c.setUint16(i.RIFFHeadersOffset.formatTag,1,!0),c.setUint16(i.RIFFHeadersOffset.channelCount,this.channelCount,!0),c.setUint32(i.RIFFHeadersOffset.sampleRate,this.desiredSampleRate,!0),c.setUint32(i.RIFFHeadersOffset.avgBytesPerSec,this.desiredSampleRate*this.channelCount*2,!0),c.setUint16(i.RIFFHeadersOffset.blockAlign,2*this.channelCount,!0),c.setUint16(i.RIFFHeadersOffset.bitsPerSample,16,!0),this.setString(c,36,i.RIFFConstants.dataChunkId),c.setUint32(40,0,!0),this.setFloatArrayToInt16(c,s,e),a},e.prototype.setString=function(e,t,n){for(var i=0;i<n.length;i++)e.setUint8(t+i,n.charCodeAt(i))},e.prototype.setFloatArrayToInt16=function(e,t,n){for(var i=0;i<n.length;i++,t+=2){var o=Math.max(-1,Math.min(1,n[i]));e.setInt16(t,o<0?32768*o:32767*o,!0)}},e.prototype.downSampleAudioFrame=function(e,t,n){if(n===t||n>t)return e;for(var i=t/n,o=Math.round(e.length/i),r=new Float32Array(o),s=0,a=0;a<o;){for(var c=Math.round((a+1)*i),l=0,u=0;s<c&&s<e.length;)l+=e[s++],u++;r[a++]=l/u}return r},e}();t.RiffPcmEncoder=o},1594:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1595),o=function(){function e(){this.decoder=new i.RiffPcmDecoder}return e.prototype.playFromBuffer=function(e,t){var n=this;return e.audioCtx?new Promise(function(i,o){var r,s,a=0;try{for(var c=0;c<t.length;c++)if(0===c){if(!(s=n.decoder.decode(t[c],!0)))return o("audio decoding failed");if(!s.length)return i(!1);if(!(r=e.audioCtx.createBuffer(n.decoder.channelCount,n.decoder.totalAudioSamples,n.decoder.sampleRate)))return o("cannot create audio buffer for playback");s.length>n.decoder.totalAudioSamples&&(s=s.subarray(0,n.decoder.totalAudioSamples)),r.getChannelData(0).set(s,0),a=s.length}else a+=(s=n.decoder.decode(t[c],!1,r.getChannelData(0),a)).length}catch(e){return o(e)}e.audioBufferSourceNode=e.audioCtx.createBufferSource(),e.audioBufferSourceNode.addEventListener("ended",function(){i(!0)}),e.audioBufferSourceNode.buffer=r,e.audioBufferSourceNode.connect(e.audioCtx.destination),e.audioBufferSourceNode.start()}):Promise.resolve(!1)},e.prototype.playFromStream=function(e,t,n){return Promise.resolve(!1)},e.prototype.stop=function(e){e&&e.audioBufferSourceNode&&e.audioBufferSourceNode.stop()},e}();t.PCMPlayer=o},1595:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(196),o=function(){function e(){}return e.prototype.decode=function(e,t,n,o){var r=0;if(t){this.totalAudioSamples=0,this.hasNonAlignedBytes=!1;var s=new DataView(e);if(s.byteLength<i.RIFFConstants.minHeaderLength)return null;var a=this.getString(s,i.RIFFHeadersOffset.riffHeaderId,4);s.getUint32(i.RIFFHeadersOffset.fileSize,!0),this.getString(s,i.RIFFHeadersOffset.waveTag,8);var c=s.getUint32(i.RIFFHeadersOffset.waveFormatChunkLength,!0),l=i.RIFFHeadersOffset.waveFormatChunkLength+i.RIFFConstants.chunkLengthSize+c,u=l+i.RIFFConstants.chunkIdSize;r=u+i.RIFFConstants.chunkLengthSize,this.channelCount=s.getUint16(i.RIFFHeadersOffset.channelCount,!0),this.sampleRate=s.getUint32(i.RIFFHeadersOffset.sampleRate,!0);var d=s.getUint16(i.RIFFHeadersOffset.bitsPerSample,!0),p=this.getString(s,l,4),h=s.getUint32(u,!0);if(!h||h>26214400)return new Float32Array(0);if(a!==i.RIFFConstants.riffChunkId||p!==i.RIFFConstants.dataChunkId||16!==d)return null;this.bytesPerSample=d/8,this.totalAudioSamples=h/this.bytesPerSample}var g=new DataView(e,r),v=Math.floor(((this.hasNonAlignedBytes?1:0)+g.byteLength)/this.bytesPerSample);if(!v)return null;var S=!!n;n=n||new Float32Array(v);var f=o=o||0,m=this.hasNonAlignedBytes?1:0;if(this.hasNonAlignedBytes){this.hasNonAlignedBytes=!1;var C=new Uint8Array(this.bytesPerSample);C[0]=this.nonAlignedByte,C[1]=g.getUint8(0);var y=new DataView(C.buffer);this.setFloatArrayFromInt16(y,0,n,o++)}var A=this.setFloatArrayFromInt16(g,m,n,o);return A.sourceOffset<g.byteLength&&(this.hasNonAlignedBytes=!0,this.nonAlignedByte=g.getInt8(m)),S?n.subarray(f,A.targetOffset):n},e.prototype.setFloatArrayFromInt16=function(e,t,n,i){for(var o=e.byteLength,r=n.length;t<o-1&&i<r;){var s=e.getInt16(t,!0);n[i++]=s>=32768?s/32768:s/32767,t+=2}return{sourceOffset:t,targetOffset:i}},e.prototype.getString=function(e,t,n){var i="";if(t+n+e.byteOffset>e.byteLength)return i;for(var o=0;o<n;++o)i+=String.fromCharCode(e.getUint8(t+o));return i},e}();t.RiffPcmDecoder=o},1596:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),r=function(e){function t(t,n,i){var r=e.call(this,o.ClientSkillsId.communication)||this;return r.$rootScope=t,r.callingSupportService=n,r.platformDetectService=i,r}return i(t,e),t.$inject=["$rootScope","callingSupportService","platformDetectService"],t.prototype.initialize=function(){var e=this;return this.pstnCallingAllowedSubscription=this.callingSupportService.subscribe(function(){e.onCallingAggregatedSettingsUpdated(),e.triggerConfigUpdated()},teamspace.services.CallingSupportServiceEvents.Type_isPstnCallingAllowedChanged),this.callingAllowedSubscription=this.callingSupportService.subscribe(function(){e.onCallingAggregatedSettingsUpdated(),e.triggerConfigUpdated()},teamspace.services.CallingSupportServiceEvents.Type_isCallingAllowedChanged),this.$rootScope.$on("$destroy",function(){e.pstnCallingAllowedSubscription&&e.callingSupportService.unsubscribe(e.pstnCallingAllowedSubscription),e.callingAllowedSubscription&&e.callingSupportService.unsubscribe(e.callingAllowedSubscription)}),this.currentConfig={channelsSettings:{},preferences:{maxContactsForDisambig:3,preferredCallingChannel:"teams",preferredMessagingChannel:"teams"}},this.onCallingAggregatedSettingsUpdated(),Promise.resolve(!0)},t.prototype.deinitialize=function(){this.pstnCallingAllowedSubscription&&(this.callingSupportService.unsubscribe(this.pstnCallingAllowedSubscription),this.pstnCallingAllowedSubscription=void 0),this.callingAllowedSubscription&&(this.callingSupportService.unsubscribe(this.callingAllowedSubscription),this.callingAllowedSubscription=void 0),this.currentConfig=null},t.prototype.getConfig=function(){return this.currentConfig},t.prototype.onCallingAggregatedSettingsUpdated=function(){this.currentConfig.channelsSettings.teams={canSupplyContacts:!1,supportsCalling:!!this.callingSupportService.isCallingAllowed(),supportsCallingMultipleContacts:!1,supportsAddToCall:!0,supportsAddToCallMultipleContacts:!1,supportsHoldResume:!0,supportsTransferCall:!0,supportsFetchMessages:!1,supportsMarkMessages:!1,supportsSendMessage:!0,supportsMultipleCalls:!this.platformDetectService.isRigel(),permissionsSettings:{enableCallAContact:!!this.callingSupportService.isCallingAllowed(),enableCallANumber:!!this.callingSupportService.isPSTNCallingAllowed(),enableSendMessage:!0}}},t}(n(197).CortanaConfigProviderBase);t.CommunicationSkillConfigProvider=r,angular.module("teamspace.communicationSkillConfigProvider",["teamspace.callingSupportService"]).service("communicationSkillConfigProvider",r)},1597:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),r=function(e){function t(t,n,i,r,s,a){var c=e.call(this,o.ClientSkillsId.system)||this;return c.$rootScope=t,c.constants=n,c.loggingService=i,c.myUserPreferencesStore=r,c.platformDetectService=s,c.settingsService=a,c.logger=i.newLogger("SystemSkillConfigProvider"),c}return i(t,e),t.$inject=["$rootScope","constants","loggingService","myUserPreferencesStore","platformDetectService","settingsService"],t.prototype.initialize=function(){var e=this;return this.myUserPreferencesStore.waitForPreferenceStoreToInitialize().then(function(){return e.updateConfig(),e.preferencesStoreToken=e.myUserPreferencesStore.safeSubscribe(e.$rootScope,function(t,n){n&&_.find(n,function(e){return e===SkypeX.Services.MyUserPreferenceStorageKey.Locale})&&(e.updateConfig(),e.triggerConfigUpdated())},e.constants.MyUserPreferencesStore.Type_UserPreference),!0})},t.prototype.deinitialize=function(){this.preferencesStoreToken&&(this.myUserPreferencesStore.unsubscribe(this.preferencesStoreToken),this.preferencesStoreToken=void 0),this.currentConfig=null},t.prototype.getConfig=function(){return this.currentConfig},t.prototype.updateConfig=function(){this.logger.info("user locale updated {0}, force locale to {1}",this.myUserPreferencesStore.getUserPreferences().locale,"en-us");var e="en-us",t=-(new Date).getTimezoneOffset(),n=this.settingsService.valueFor(this.constants.settings.environment),i=this.settingsService.valueFor(this.constants.settings.names.cortanaConstants),o=this.platformDetectService.getClientVersion(),r=this.platformDetectService.getDesktopBuildVersion();r&&(o=o.concat("_",r)),this.currentConfig={sdk:null,language:e.toLowerCase(),region:"us",timezoneOffset:t,app:{name:i.appName,flavor:i.appFlavorPrefix+"_"+(n&&n.platformId),version:o},deviceId:this.loggingService.deviceId(),deviceName:i.deviceNamePrefix+"+"+this.platformDetectService.getDeviceType(),device:{manufacturer:i.deviceManufacturer,model:this.platformDetectService.getBrowser(),version:this.platformDetectService.getBrowserVersion()},os:{platform:this.platformDetectService.getDesktopOsArchitecture(),name:this.platformDetectService.getOS(),version:this.platformDetectService.getOSVersion()}}},t}(n(197).CortanaConfigProviderBase);t.SystemSkillConfigProvider=r,angular.module("teamspace.systemSkillConfigProvider",["skypeX.myUserPreferencesStore","teamspace.constants","teamspace.loggingService","teamspace.platformDetectService","teamspace.settingsService"]).service("systemSkillConfigProvider",r)},1598:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),r=n(1),s=function(e){function t(t,n,i,s,a,c,l,u,d,p,h,g,v,S){var f=e.call(this,o.TeamsActionsId.callingAction)||this;return f.addParticipantService=t,f.callingService=n,f.callingSupportService=i,f.callingNavigationService=s,f.callTogglingService=a,f.callTransferService=c,f.callingUserActionService=l,f.constants=u,f.conversationsService=d,f.peopleService=h,f.platformDetectService=g,f.pstnNumberService=v,f.callParkService=S,f.actionTypeToResultEventMap={},f.logger=p.newLogger("CallingActionHandler"),f.actionTypeToResultEventMap[r.ClientSkillsActions.addToCall]="addToCallActionResult",f.actionTypeToResultEventMap[r.ClientSkillsActions.endCall]="endCallActionResult",f.actionTypeToResultEventMap[r.ClientSkillsActions.holdCall]="holdCallActionResult",f.actionTypeToResultEventMap[r.ClientSkillsActions.makeCall]="makeCallActionResult",f.actionTypeToResultEventMap[r.ClientSkillsActions.resumeCall]="resumeCallActionResult",f.actionTypeToResultEventMap[r.ClientSkillsActions.transferCall]="transferCallActionResult",f}return i(t,e),t.$inject=["addParticipantService","callingService","callingSupportService","callingNavigationService","callTogglingService","callTransferService","callingUserActionService","constants","conversationsService","loggingService","peopleService","platformDetectService","pstnNumberService","callParkService"],t.prototype.handleAction=function(e){var t=e;if(!t||!t.type)return Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.EmptyResponse));if(this.logger.info("calling type: {0}",t.type),!this.callingSupportService.isSupportedEnvironment())return this.logger.info("Voice Skills: calling unsupported environment"),Promise.resolve(this.callingActionResult(t.type,o.TeamsCortanaActionStatus.NotSupported));var n=t.contacts&&t.contacts[0]?t.contacts[0]:null;switch(this.logger.info("Voice Skills: Requesting {0}",t.type),t.type){case r.ClientSkillsActions.makeCall:return this.handleMakeCallAction(n);case r.ClientSkillsActions.transferCall:return this.handleTransferCallAction(n,t.callId);case r.ClientSkillsActions.addToCall:return this.handleAddToCallAction(n,t.callId);case r.ClientSkillsActions.resumeCall:case r.ClientSkillsActions.holdCall:return this.handleHoldResumeCallAction(t.type===r.ClientSkillsActions.holdCall,t.callId);case r.ClientSkillsActions.muteCall:case r.ClientSkillsActions.unmuteCall:return this.handleMuteUnmuteCallAction(t.type===r.ClientSkillsActions.muteCall,t.callId);case r.ClientSkillsActions.endCall:return this.handleEndCallAction(t.callId);default:return Promise.resolve(this.callingActionResult(t.type,o.TeamsCortanaActionStatus.InvalidAction))}},t.prototype.getCallByIdOrCurrentCall=function(e){var t;return e&&(t=this.callingService.getCallByCallId(e)),t||this.callingService.getActiveCall()},t.prototype.isActionAllowed=function(e,t,n){switch(void 0===t&&(t=!1),e){case r.ClientSkillsActions.makeCall:return t?this.callingSupportService.isPSTNCallingAllowed():this.callingSupportService.isCallingAllowed();case r.ClientSkillsActions.addToCall:return t?this.callingSupportService.isAddingParticipantAllowed(n)&&n.isPstnAvailable:this.callingSupportService.isAddingParticipantAllowed(n);case r.ClientSkillsActions.holdCall:return this.callingSupportService.isHoldResumeAllowed(n);case r.ClientSkillsActions.resumeCall:return n&&4===n.state;case r.ClientSkillsActions.transferCall:return this.callingSupportService.isTransferAllowed(n);case r.ClientSkillsActions.endCall:return!0;default:return!1}},t.prototype.formatContactNumber=function(e){return this.pstnNumberService.parseAndFormatNumber(e,libphonenumber.PhoneNumberFormat.E164)},t.prototype.handleMakeCallAction=function(e){var t=this,n=r.ClientSkillsActions.makeCall;return e?this.platformDetectService.isRigel()||this.isActionAllowed(n,!!e.number)?e.number?this.callPstnNumber(this.formatContactNumber(e.number)):e.mri?this.callContact(e.mri):e.upn?this.getProfileByContactId(e.upn,!0).then(function(e){return t.callContact(e.mri)}).catch(function(e){return t.logger.warn("VoiceSkills: failed to get profile by contact id : {0}",e),t.callingActionResult(r.ClientSkillsActions.makeCall,o.TeamsCortanaActionStatus.Error,t.getErrorMessage(e))}):Promise.resolve(this.callingActionResult(r.ClientSkillsActions.makeCall,o.TeamsCortanaActionStatus.InvalidActionData)):Promise.resolve(this.callingActionResult(r.ClientSkillsActions.makeCall,o.TeamsCortanaActionStatus.NotSupported)):Promise.resolve(this.callingActionResult(r.ClientSkillsActions.makeCall,o.TeamsCortanaActionStatus.InvalidActionData))},t.prototype.handleHoldResumeCallAction=function(e,t){var n=this,i=e?r.ClientSkillsActions.holdCall:r.ClientSkillsActions.resumeCall,s=this.getCallByIdOrCurrentCall(t);return s?this.isActionAllowed(i,!1,s)?e&&4!==s.state||!e&&4===s.state?(e||this.platformDetectService.isRigel()||this.callingNavigationService.navigateToCallScreen(s),this.callParkService.toggleHold(s,this.constants.scenarios.calling.context.voiceSkills.holdResume).then(function(){return n.callingActionResult(i,o.TeamsCortanaActionStatus.Success)}).catch(function(e){return n.logger.warn("VoiceSkills: failed to hold/resume [call][callId:"+t+"] with [error:"+e+"]"),n.callingActionResult(i,o.TeamsCortanaActionStatus.Error,n.getErrorMessage(e))})):Promise.resolve(this.callingActionResult(i,o.TeamsCortanaActionStatus.Error)):Promise.resolve(this.callingActionResult(i,o.TeamsCortanaActionStatus.NotSupported)):Promise.resolve(this.callingActionResult(i,o.TeamsCortanaActionStatus.InvalidActionData))},t.prototype.handleMuteUnmuteCallAction=function(e,t){var n,i=this,s=e?r.ClientSkillsActions.muteCall:r.ClientSkillsActions.unmuteCall,a=this.getCallByIdOrCurrentCall(t);return a?this.callTogglingService.toggleMuteAudio(a,1,e?1:2,(n={},n[this.constants.counters.eventNames.context]=this.constants.scenarios.calling.context.voiceSkills.muteUnmute,n)).then(function(){return i.callingActionResult(s,o.TeamsCortanaActionStatus.Success)}).catch(function(e){return i.logger.warn("VoiceSkills: failed to mute/unmute call: "+t+" with error: "+e),i.callingActionResult(s,o.TeamsCortanaActionStatus.Error,i.getErrorMessage(e))}):Promise.resolve(this.callingActionResult(s,o.TeamsCortanaActionStatus.InvalidActionData))},t.prototype.handleEndCallAction=function(e){var t=this,n=this.getCallByIdOrCurrentCall(e);return n?this.callingService.leaveCall(n,this.constants.scenarios.calling.context.voiceSkills.endCall).then(function(){return t.callingActionResult(r.ClientSkillsActions.endCall,o.TeamsCortanaActionStatus.Success)}).catch(function(n){return t.logger.warn("VoiceSkills: failed to end call: "+e+" with error: "+n),t.callingActionResult(r.ClientSkillsActions.endCall,o.TeamsCortanaActionStatus.Error,t.getErrorMessage(n))}):Promise.resolve(this.callingActionResult(r.ClientSkillsActions.endCall,o.TeamsCortanaActionStatus.InvalidActionData))},t.prototype.handleTransferCallAction=function(e,t){var n=this,i=r.ClientSkillsActions.transferCall,s=this.getCallByIdOrCurrentCall(t);return s&&(e.mri||e.upn||e.number)?this.isActionAllowed(i,!1,s)?(e.number?this.getProfileByContactNumber(this.formatContactNumber(e.number)):this.getProfileByContactId(e.mri?e.mri:e.upn,!!e.mri)).then(function(e){return e&&e.mri?(n.callTransferService.transferCall(s,e),n.callingActionResult(i,o.TeamsCortanaActionStatus.Success)):(n.logger.error("failed to find call contact"),n.callingActionResult(i,o.TeamsCortanaActionStatus.UserNotFound))}).catch(function(e){return n.logger.warn("VoiceSkills: failed to transfer call: "+t+" with error: "+e),n.callingActionResult(i,o.TeamsCortanaActionStatus.Error,n.getErrorMessage(e))}):Promise.resolve(this.callingActionResult(i,o.TeamsCortanaActionStatus.NotSupported)):Promise.resolve(this.callingActionResult(i,o.TeamsCortanaActionStatus.InvalidActionData))},t.prototype.handleAddToCallAction=function(e,t){var n=this,i=r.ClientSkillsActions.addToCall,s=this.getCallByIdOrCurrentCall(t);return s&&(e.mri||e.upn||e.number)?this.isActionAllowed(i,!!e.number,s)?(e.number?this.getProfileByContactNumber(this.formatContactNumber(e.number)):this.getProfileByContactId(e.mri?e.mri:e.upn,!!e.mri)).then(function(e){return e&&e.mri?(n.addParticipantService.handleAddParticipant(s,e,n.constants.scenarios.calling.context.voiceSkills.addToCall),n.callingActionResult(i,o.TeamsCortanaActionStatus.Success)):(n.logger.error("failed to find call contact"),n.callingActionResult(i,o.TeamsCortanaActionStatus.UserNotFound))}).catch(function(e){return n.logger.warn("VoiceSkills: failed to add to call: "+t+" with error: "+e),n.callingActionResult(i,o.TeamsCortanaActionStatus.Error,n.getErrorMessage(e))}):Promise.resolve(this.callingActionResult(i,o.TeamsCortanaActionStatus.NotSupported)):Promise.resolve(this.callingActionResult(i,o.TeamsCortanaActionStatus.InvalidActionData))},t.prototype.callPstnNumber=function(e){var t=this,n={dialoutNumber:e,dtmfPortion:"",context:teamspace.services.CallTelemetryContext.VoiceSkillsPstnCall,withVideo:!1,muted:!1};return this.callingUserActionService.startPstnCall(n).then(function(){return t.callingActionResult(r.ClientSkillsActions.makeCall,o.TeamsCortanaActionStatus.Success)}).catch(function(e){return t.callingActionResult(r.ClientSkillsActions.makeCall,o.TeamsCortanaActionStatus.Error,t.getErrorMessage(e))})},t.prototype.callContact=function(e){var t=this;if(!e)return Promise.resolve(this.callingActionResult(r.ClientSkillsActions.makeCall,o.TeamsCortanaActionStatus.UserNotFound));var n={messageId:null,conversationId:this.conversationsService.getChatConversationWith(e).id,isChannelMeeting:!1,withVideo:!1,context:teamspace.services.CallTelemetryContext.VoiceSkillsCall};return this.callingUserActionService.placeCall(n).then(function(){return t.callingActionResult(r.ClientSkillsActions.makeCall,o.TeamsCortanaActionStatus.Success)}).catch(function(e){return t.callingActionResult(r.ClientSkillsActions.makeCall,o.TeamsCortanaActionStatus.Error,t.getErrorMessage(e))})},t.prototype.getProfileByContactId=function(e,t){var n=this;return void 0===t&&(t=!1),e?this.peopleService.getPeopleProfile(e,"callingActionHandler",t).then(function(e){return e&&e.mri?e:(n.logger.error("failed to find call contact by contactId"),null)}):null},t.prototype.getProfileByContactNumber=function(e){var t=this;if(!e)return null;var n={includePstn:!0};return this.peopleService.searchContacts(e,n).then(function(e){return e&&e.results&&e.results[0]?e.results[0]:(t.logger.error("failed to find call contact by pstn"),null)})},t.prototype.callingActionResult=function(e,t,n,i){return void 0===n&&(n=""),void 0===i&&(i=!0),{status:t,actionId:this.actionId,dismissOnAction:i,actionResponseData:this.getCallingResponseData(e,t===o.TeamsCortanaActionStatus.Success,n)}},t.prototype.getCallingResponseData=function(e,t,n){if(!e)return null;var i=this.actionTypeToResultEventMap[e];return i?{id:r.ClientSkillsId.communication,event:i,slots:{success:t,errorMessage:n||""}}:null},t}(o.TeamsCortanaActionHandlerBase);t.CallingActionHandler=s,angular.module("teamspace.callingActionHandler",["teamspace.addParticipantService","teamspace.callingService","teamspace.callingSupportService","teamspace.callingUserActionService","teamspace.callTogglingService","teamspace.callTransferService","teamspace.conversationsService","teamspace.loggingService","teamspace.peopleService","teamspace.pstnNumberService","teamspace.callParkService"]).service("callingActionHandler",s)},1599:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),r=function(e){function t(t,n,i,r,s){var a=e.call(this,o.TeamsActionsId.downloadFilesAction)||this;return a.$q=t,a.constants=n,a.downloadManagerService=i,a.filesActionService=r,a.logger=s.newLogger("DownloadFilesActionHandler"),a}return i(t,e),t.$inject=["$q","constants","downloadManagerService","filesActionService","loggingService"],t.prototype.handleAction=function(e){var t=this,n=e;if(!n||!n.files||0===n.files.length)return Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Error));n.files=n.files?n.files:[n.file];var i=_.map(n.files,function(e){return{downloadUrl:e.objectUrl,objectId:e.objectId,objectUrl:e.objectUrl,title:e.title,type:e.type}});return this.downloadManagerService.download(i,function(e){return t.$q.resolve({serviceName:t.constants.files.serviceName.recent,objectUrl:e.objectUrl,title:e.title})}).then(function(e){t.filesActionService.handleBatchResults(e,i,null,teamspace.services.EntityActionType.Download,t.constants.events.files.batchDownloadSuccess,t.constants.events.files.batchDownloadFailed,!1)}).catch(function(e){t.logger.error("download failed {0}",e)}),Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Success))},t}(o.TeamsCortanaActionHandlerBase);t.DownloadFilesActionHandler=r,angular.module("teamspace.downloadFilesActionHandler",["teamspace.downloadManagerService","teamspace.filesActionService","teamspace.loggingService"]).service("downloadFilesActionHandler",r)},1600:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),r=function(e){function t(t,n){var i=e.call(this,o.TeamsActionsId.openFileAction)||this;return i.constants=t,i.navigationService=n,i}return i(t,e),t.$inject=["constants","navigationService"],t.prototype.handleAction=function(e){var t=this,n=e;if(!n||!n.file)return Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Error));var i=n.file,r={documentViewerParams:{baseUrl:null,ctx:"cortana",fileId:i.objectId,fileType:i.type,objectUrl:i.objectUrl,serviceName:"teams",viewerAction:"view"},viewerState:this.constants.states.appDocumentViewer};return this.navigationService.navigateToFileViewer(r).then(function(e){return t.actionResult(e?o.TeamsCortanaActionStatus.Success:o.TeamsCortanaActionStatus.Error)})},t}(o.TeamsCortanaActionHandlerBase);t.FileActionHandler=r,angular.module("teamspace.fileActionHandler",["teamspace.navigationService"]).service("fileActionHandler",r)},1601:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),r=n(1),s=function(e){function t(t,n,i,r,s){var a=e.call(this,o.TeamsActionsId.meetingAction)||this;return a.callingUserActionService=t,a.conversationsService=n,a.callingDeepLinkService=i,a.constants=r,a.logger=s.newLogger("MeetingActionHandler"),a}return i(t,e),t.$inject=["callingUserActionService","conversationsService","callingDeepLinkService","constants","loggingService"],t.prototype.handleAction=function(e){var t=e;if(!t||!t.type)return Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.EmptyResponse));if(this.logger.info("meeting action type: {0}",t.type),t.type!==r.ClientSkillsActions.meeting.joinMeeting)return Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.InvalidAction));var n=t.skypeTeamsMeetingUrl,i=t.conversationId,s=i&&this.conversationsService.getCallingConversation(i);if(!s)return Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.InvalidActionData));var a=!s.isMeeting()||s.isPrivateMeeting()?teamspace.services.MeetingType.Chat:teamspace.services.MeetingType.Team;return this.handleJoinMeeting(i,n,a)},t.prototype.handleJoinMeeting=function(e,t,n){var i=this.callingDeepLinkService.getDeeplinkParamsFromUrl(t),s=t.contains("IsBroadcastMeeting"),a={conversationId:e,skypeTeamsMeetingUrl:t,meetingType:n,tenantId:i&&i.context&&i.context.Tid,isBroadcast:!!s},c={context:this.constants.scenarios.calling.context.voiceSkills.joinMeeting},l="",u=this.conversationsService.getConversation(e);if(u){var d=u.getMeetingInfo();l=d?d.iCalUid:""}return this.callingUserActionService.joinSkypeTeamMeeting(a,c),Promise.resolve(this.meetingActionResult(r.ClientSkillsActions.meeting.joinMeeting,o.TeamsCortanaActionStatus.Success,l))},t.prototype.meetingActionResult=function(e,t,n,i,r){return void 0===i&&(i=""),void 0===r&&(r=!0),{status:t,actionId:this.actionId,dismissOnAction:r,actionResponseData:this.getMeetingResponseData(e,t===o.TeamsCortanaActionStatus.Success,n,i)}},t.prototype.getMeetingResponseData=function(e,t,n,i){return e?{id:"meeting",event:"joinMeetingActionResult",slots:{success:t,errorMessage:i||"",iCalUid:n}}:null},t}(o.TeamsCortanaActionHandlerBase);t.MeetingActionHandler=s,angular.module("teamspace.meetingActionHandler",["teamspace.callingService","teamspace.callingUserActionService","teamspace.conversationsService","teamspace.callingDeepLinkService","teamspace.loggingService"]).service("meetingActionHandler",s)},1602:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),r=function(e){function t(t,n,i,r,s,a,c,l,u,d,p){var h=e.call(this,o.TeamsActionsId.navigation)||this;return h.constants=t,h.$q=n,h.$state=i,h.brbV2FeedbackService=r,h.conversationsService=s,h.dialogService=a,h.eventingService=c,h.navigationService=l,h.peopleService=u,h.shortcutService=d,h.teamActionDialogUtilityService=p,h}return i(t,e),t.$inject=["constants","$q","$state","brbV2FeedbackService","conversationsService","dialogService","eventingService","navigationService","peopleService","shortcutService","teamActionDialogUtilityService"],t.prototype.handleAction=function(e){var t=e;if(!t||!t.destination&&!t.channelId)return Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Error));if(t.channelId)return this.navigationService.navigateToChannel(t.channelId,"cortana"),Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Success,!0,null,"channel"));var n;switch(t.destination){case o.NavigationDestinations.recentFiles:n=this.navigationResultToActionResult(this.navigationService.navigateToRecentFiles());break;case o.NavigationDestinations.activity:n=this.navigationResultToActionResult(this.navigationService.navigateToActivityFeed());break;case o.NavigationDestinations.atMentions:n=this.navigationResultToActionResult(this.navigationService.navigateToMentionsState());break;case o.NavigationDestinations.calendar:n=this.navigationResultToActionResult(this.navigationService.navigateToCalendar());break;case o.NavigationDestinations.createTeam:this.teamActionDialogUtilityService.openCreateTeamDialog(),n=Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Success));break;case o.NavigationDestinations.downloads:n=this.navigationResultToActionResult(this.navigationService.navigateToDownloads());break;case o.NavigationDestinations.feedback:this.brbV2FeedbackService.openDialog(!1,void 0,this.constants.feedback.categories.cortana),n=Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Success));break;case o.NavigationDestinations.joinTeam:this.$state.go(this.constants.states.appDiscover),n=Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Success));break;case o.NavigationDestinations.myActivity:n=this.navigationResultToActionResult(this.navigationService.navigateToMyActivity());break;case o.NavigationDestinations.saved:n=this.navigationResultToActionResult(this.navigationService.navigateToDefaultMySavedState());break;case o.NavigationDestinations.unreadActivity:n=this.navigationResultToActionResult(this.navigationService.navigateToUnreadState());break;case o.NavigationDestinations.help:this.eventingService.$emit(this.constants.events.cortana.openEducationalPage),n=Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Success,!1));break;case o.NavigationDestinations.openSettings:this.dialogService.open(this.constants.dialogs.optionsSettingsDialog),n=Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Success));break;case o.NavigationDestinations.keyboardShortcuts:this.shortcutService.executeCommand(teamspace.services.CommandIdentifier.ShowShortcuts),n=Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Success));break;case o.NavigationDestinations.store:n=this.navigationResultToActionResult(this.navigationService.navigateToAppsView());break;case o.NavigationDestinations.otherPersonActivity:case o.NavigationDestinations.otherPersonChat:case o.NavigationDestinations.otherPersonOrganization:n=this.navigationResultToActionResult(this.handleOtherPersonNavigation(t));break;case o.NavigationDestinations.teamsApp:n=t.appId?this.navigationResultToActionResult(this.navigationService.navigateToUserAppId(t.appId,"cortana")):Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.InvalidActionData));break;default:n=Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Error))}return n.then(function(e){return e.actionInfo=t.destination,e})},t.prototype.navigationResultToActionResult=function(e){var t=this;return e?e.then(function(e){return e?t.actionResult(o.TeamsCortanaActionStatus.Success):t.actionResult(o.TeamsCortanaActionStatus.Error)}):Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Error))},t.prototype.handleOtherPersonNavigation=function(e){var t=this;return e.userPrincipalName?e.destination===o.NavigationDestinations.otherPersonActivity?this.navigationService.navigateToPerson(e.userPrincipalName,this.constants.peopleTab.panes.activity):e.destination===o.NavigationDestinations.otherPersonOrganization?this.navigationService.navigateToPerson(e.userPrincipalName,this.constants.peopleTab.panes.organization):e.destination===o.NavigationDestinations.otherPersonChat?this.peopleService.getPeopleProfile(e.userPrincipalName,"navigationActionHandler",!0).then(function(e){var n=e.mri,i=t.conversationsService.getChatConversationWith(n),o=i?i.id:null;if(o){var r={slug:o,middlePane:t.constants.messages.panes.conversations,ctx:t.constants.navigation.context.chat,navCtx:"cortana"};return t.navigationService.navigateDirectPromise(t.constants.states.appConversation,r)}return t.$q.resolve(null)}):this.$q.resolve(null):this.$q.resolve(null)},t}(o.TeamsCortanaActionHandlerBase);t.NavigationActionHandler=r,angular.module("teamspace.navigationActionHandler",["teamspace.brbV2FeedbackService","teamspace.conversationsService","teamspace.dialogService","teamspace.eventingService","teamspace.navigationService","teamspace.peopleService","teamspace.shortcutService","teamspace.teamActionDialogUtilityService"]).service("navigationActionHandler",r)},1603:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),r=n(1),s=function(e){function t(t,n,i,r,s,a,c){var l=e.call(this,o.TeamsActionsId.present)||this;return l.$state=t,l.callingService=n,l.callingNavigationService=i,l.constants=r,l.contentSharingService=s,l.eventingService=a,l.logger=c.newLogger("PresentActionHandler"),l}return i(t,e),t.$inject=["$state","callingService","callingNavigationService","constants","contentSharingService","eventingService","loggingService"],t.prototype.handleAction=function(e){var t=e;if(!t||!t.type)return Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.EmptyResponse));this.logger.info("Voice Skills: present action type: {0}",t.type);var n=this.getCallFromActionDetails(t);if(!n)return Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.InvalidAction));switch(t.type){case r.ClientSkillsActions.meeting.present:return this.callingNavigationService.navigateToCallScreen(n),this.presentDeck(t.deckName,t.deckUrl,t.attachmentInfo);case r.ClientSkillsActions.meeting.stopSharingDeck:return this.stopPresentingDeck(n.callId);case r.ClientSkillsActions.meeting.nextSlide:return this.goToNextSlide(n.callId);case r.ClientSkillsActions.meeting.previousSlide:return this.goToPreviousSlide(n.callId);case r.ClientSkillsActions.meeting.goToSlide:return this.goToSlide(n.callId,t.slideIndex);default:return Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.InvalidAction))}},t.prototype.getCallFromActionDetails=function(e){var t,n=e.conversationId||this.$state.params.conversationId;return e.callId||n?(e.callId&&(t=this.callingService.getCallByCallId(e.callId)),!t&&n&&(t=_.find(this.callingService.getActiveCalls(),function(e){return e.conversationId&&e.conversationId===n})),t||(this.logger.error("Voice Skills: No active call corresponding to the conversationId "+n),null)):null},t.prototype.presentDeck=function(e,t,n){var i=this;if(!t&&!n)return this.logger.info("Voice Skills: no deckUrl in the response to present the deck"),Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.InvalidParameters));var s={type:"ppt",id:n?n.attachmentId:void 0,name:e,url:n?void 0:t,siteUrl:void 0,contentBundleUrl:void 0,fileGetUrl:void 0,fileCommandsUrl:void 0,majorVersion:void 0,fileSize:void 0,source:"cortana",exchangeMeta:n?{type:n.type,eventId:n.eventId}:void 0,replaceFile:!0};return this.contentSharingService.startSharingContent(s).then(function(){i.logger.info("Voice Skills: presenting the deck")}).catch(function(e){e.code!==teamspace.services.ContentSharingErrorCode.Cancelled?i.logger.error("Content sharing stopped: sharing failed"):i.logger.info("Content sharing stopped: sharing cancelled.")}),Promise.resolve(this.presentActionResult(r.ClientSkillsActions.meeting.present,o.TeamsCortanaActionStatus.Success))},t.prototype.stopPresentingDeck=function(e){return this.logger.info("Voice Skills: stop presenting the current deck on callId "+e),this.eventingService.$emit(this.constants.events.calling.pptSharingOnHold,{callId:e}),Promise.resolve(this.presentActionResult(r.ClientSkillsActions.meeting.stopSharingDeck,o.TeamsCortanaActionStatus.Success))},t.prototype.goToNextSlide=function(e){return this.logger.info("Voice Skills: navigate to next slide for active presentation on callId "+e),this.eventingService.$emit(this.constants.events.calling.pptSharingNext,{callId:e}),Promise.resolve(this.presentActionResult(r.ClientSkillsActions.meeting.navigateDeck,o.TeamsCortanaActionStatus.Success))},t.prototype.goToPreviousSlide=function(e){return this.logger.info("Voice Skills: navigate to previous slide for active presentation on callId "+e),this.eventingService.$emit(this.constants.events.calling.pptSharingPrev,{callId:e}),Promise.resolve(this.presentActionResult(r.ClientSkillsActions.meeting.navigateDeck,o.TeamsCortanaActionStatus.Success))},t.prototype.goToSlide=function(e,t){return this.logger.info("Voice Skills: navigate to slide "+t+" for active presentation on callId "+e),this.eventingService.$emit(this.constants.events.calling.pptSharingGoTo,{callId:e,index:parseInt(t).toString()}),Promise.resolve(this.presentActionResult(r.ClientSkillsActions.meeting.navigateDeck,o.TeamsCortanaActionStatus.Success))},t.prototype.presentActionResult=function(e,t,n,i){return void 0===n&&(n=""),void 0===i&&(i=!0),{status:t,actionId:this.actionId,dismissOnAction:i,actionResponseData:this.getPresentResponseData(e,t===o.TeamsCortanaActionStatus.Success,n)}},t.prototype.getPresentResponseData=function(e,t,n){if(!e)return null;var i=e+"ActionResult";return{id:r.ClientSkillsId.meeting,event:i,slots:{success:t,errorMessage:n||""}}},t}(o.TeamsCortanaActionHandlerBase);t.PresentActionHandler=s,angular.module("teamspace.presentActionHandler",["teamspace.callingService","teamspace.callingNavigationService","teamspace.contentSharingService","teamspace.eventingService","teamspace.loggingService"]).service("presentActionHandler",s)},1604:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),r=function(e){function t(t,n){var i=e.call(this,o.TeamsActionsId.teamsMiscAction)||this;return i.constants=t,i.eventingService=n,i}return i(t,e),t.$inject=["constants","eventingService"],t.prototype.handleAction=function(e){var t=e;return t&&t.type?t.type===o.TeamsMiscActionType.Search&&t.query?(this.eventingService.$emit(this.constants.events.search.performSearch,{searchStr:t.query}),Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Success,!0,null,o.TeamsMiscActionType.Search))):t.type===o.TeamsMiscActionType.Dismiss?Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Success,!0,null,o.TeamsMiscActionType.Dismiss)):Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.InvalidActionData)):Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Error))},t}(o.TeamsCortanaActionHandlerBase);t.TeamsMiscActionHandler=r,angular.module("teamspace.teamsMiscActionHandler",["teamspace.eventingService"]).service("teamsMiscActionHandler",r)},1605:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),r=function(e){function t(t,n,i,r,s,a,c){var l=e.call(this,o.TeamsActionsId.sendMessageAction)||this;return l.$q=t,l.conversationsService=n,l.htmlSanitizer=i,l.messageService=s,l.peopleService=a,l.utilityService=c,l.logger=r.newLogger("SendMessageActionHandler"),l}return i(t,e),t.$inject=["$q","conversationsService","htmlSanitizer","loggingService","messageService","peopleService","utilityService"],t.prototype.handleAction=function(e){var t=this,n=e;if(this.logger.info("send message invoked"),!n)return this.logger.info("empty send message action"),Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Error));var i=n.mris&&n.mris.length>0,r=n.userPrincipalNames&&n.userPrincipalNames.length>0,s=n.conversationId;if(!r&&!s&&!i)return this.logger.info("missing missing upns, conversation, and mri"),Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Error));if(!n.message)return this.logger.info("message is missing"),Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Error));var a;if(n.conversationId)this.logger.info("invoking via conversation ID"),a=Promise.resolve(n.conversationId);else{this.logger.info("invoked with upn or mri");var c=Promise.resolve(null);r&&(c=this.peopleService.getAllShortPeopleProfile(n.userPrincipalNames,"sendMessageActionHandler",!0).then(function(e){return e&&e.length?_.map(e,function(e){return e.mri}):(t.logger.error("failed to find message contact by contactId"),null)})),a=c.then(function(e){e=e||[],n.mris&&(e=e.concat(n.mris));var i=t.conversationsService.getChatConversationWith(e);return i?i.id:""})}var l=this.utilityService.escapeHtml(n.message);return n.hyperlinks&&_.forEach(n.hyperlinks,function(e){l+="<br/><a href='"+e.href+"'>"+t.utilityService.escapeHtml(e.text)+"</a>"}),this.htmlSanitizer.sanitizeHtml(l),a.then(function(e){if(!e)return t.$q.reject("threadId is empty");var n=SkypeX.Services.Utilities.newClientMessageId();return t.messageService.createMessage({conversationId:e,replyChainId:null,messageSubject:null,messageBody:l,messagePreview:l,fileAttachments:null,extensions:null,mentions:null,inputExtensionAttachments:null,embeddedLinks:null,isHtml:!0,importance:null,clientId:n,externalId:null,draftObjectId:null,inlineImages:null})}).then(function(){return t.sendMessageActionResult(n.eventInfo,o.TeamsCortanaActionStatus.Success)}).catch(function(e){return t.logger.error(e),t.sendMessageActionResult(n.eventInfo,o.TeamsCortanaActionStatus.Error,e)})},t.prototype.sendMessageActionResult=function(e,t,n){return void 0===n&&(n=!0),{status:t,actionId:this.actionId,dismissOnAction:n,actionResponseData:this.getSendMessageResponseData(e,t===o.TeamsCortanaActionStatus.Success)}},t.prototype.getSendMessageResponseData=function(e,t,n){return e&&(e.id||e.event||e.domain||e.intent)?{id:e.id,event:e.event,slots:{success:t,errorMessage:n||""}}:null},t}(o.TeamsCortanaActionHandlerBase);t.SendMessageActionHandler=r,angular.module("teamspace.sendMessageActionHandler",["teamspace.conversationsService","teamspace.htmlSanitizer","teamspace.loggingService","teamspace.messageService","teamspace.peopleService","teamspace.utilityService"]).service("sendMessageActionHandler",r)},1606:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),r=function(e){function t(t,n){var i=e.call(this,o.TeamsActionsId.setStatus)||this;return i.presenceService=n,i.userStatusMap={available:SkypeX.Services.UserStatus.Online,away:SkypeX.Services.UserStatus.Away,beRightBack:SkypeX.Services.UserStatus.BeRightBack,busy:SkypeX.Services.UserStatus.Busy,doNotDisturb:SkypeX.Services.UserStatus.OutToLunch,outOfOffice:SkypeX.Services.UserStatus.OutOfOffice},i.logger=t.newLogger("SetStatusActionHandler"),i}return i(t,e),t.$inject=["loggingService","presenceService"],t.prototype.handleAction=function(e){var t=this,n=e;if(!n)return this.logger.error("null setStatusAction"),Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Error));var i=this.userStatusMap[n.userStatus];return i?(this.logger.info("setting user status to "+i),this.presenceService.setMyStatus(i,"handleAction()",!0,!0).then(function(){return t.actionResult(o.TeamsCortanaActionStatus.Success,!0,null,n.userStatus)}).catch(function(e){return t.logger.error(e),t.actionResult(o.TeamsCortanaActionStatus.Error)})):(this.logger.error("invalid user status passed in: "+n.userStatus),Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Error)))},t}(o.TeamsCortanaActionHandlerBase);t.SetStatusActionHandler=r,angular.module("teamspace.setStatusActionHandler",["skypeX.presenceService","teamspace.loggingService"]).service("setStatusActionHandler",r)},1607:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(6),r=function(e){function t(t,n,i,r,s,a){var c=e.call(this,o.TeamsActionsId.channelAction)||this;return c.channelService=t,c.peopleService=i,c.personalConversationService=r,c.teamMembershipService=s,c.teamMembershipPropertiesService=a,c.logger=n.newLogger("TeamChannelActionHandler"),c}return i(t,e),t.$inject=["channelService","loggingService","peopleService","personalConversationService","teamMembershipService","teamMembershipPropertiesService"],t.prototype.handleAction=function(e){var t=this,n=e;if(!n||!n.type)return Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Error));if(!n.channelId&&!n.teamId)return this.logger.error("no channel or team id received"),Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Error));var i=n.type,r=null;return i===o.TeamChannelActionType.favorite||i===o.TeamChannelActionType.unfavorite?r=this.favoriteAction(n.teamId,n.channelId,i===o.TeamChannelActionType.favorite):i===o.TeamChannelActionType.follow||i===o.TeamChannelActionType.unfollow?r=this.followAction(n.channelId,i===o.TeamChannelActionType.follow):i===o.TeamChannelActionType.addToTeam?r=this.addToTeam(n.teamId,n.userPrincipalNames):i===o.TeamChannelActionType.removeFromTeam&&(r=this.removeFromTeam(n.teamId,n.userPrincipalNames)),r?r.then(function(e){var n=t.actionResult(e?o.TeamsCortanaActionStatus.Success:o.TeamsCortanaActionStatus.Error);return n.actionInfo=i,n}):Promise.resolve(this.actionResult(o.TeamsCortanaActionStatus.Error))},t.prototype.addToTeam=function(e,t){var n=this;if(!e||!t||0===t.length)return this.logger.error("missing team id or user id for add to team action"),Promise.resolve(!1);var i=t[0];return new Promise(function(t,o){try{var r;n.peopleService.getAllShortPeopleProfile([i],"teamChannelActionHandler",!0).then(function(t){return t&&0!==t.length?(r=t[0],r.isOwner=!1,r.isOwnerSpecified=!1,r.role=teamspace.middletier.Role.Member,n.channelService.getTeamById(e)):(n.logger.error("cannot find user to add to team"),null)}).then(function(e){return e?n.teamMembershipPropertiesService.isAdmin(e.objectId)?n.teamMembershipService.addTeamUsers(e,[r]):(n.logger.error("user is not an admin for this team"),null):null}).then(function(e){!e||e.addedMembers&&1===e.addedMembers.length||n.logger.error("failed to add user to the team"),t(!0)}).catch(function(e){n.logger.error("add to team action failed"),t(!1)})}catch(e){o(e)}})},t.prototype.removeFromTeam=function(e,t){var n=this;if(!e||!t||0===t.length)return this.logger.error("missing team id or user id for remove from team action"),Promise.resolve(!1);var i=t[0];return new Promise(function(t,o){try{n.peopleService.getAllShortPeopleProfile([i],"teamChannelActionHandler",!0).then(function(e){return e&&0!==e.length?e[0].mri:(n.logger.error("cannot find user to remove from team"),null)}).then(function(t){return n.teamMembershipService.removeTeamUser(e,i,t)}).then(function(e){t(!0)}).catch(function(e){n.logger.error("remove from team action failed"),t(!1)})}catch(e){o(e)}})},t.prototype.followAction=function(e,t){var n=this;return e?new Promise(function(i,o){try{var r,s;n.channelService.getChannelById(e).then(function(e){if(r=e,(s=r.isFollowed!==t)&&t)return n.personalConversationService.toggleFavoriteSettingForChannel(r,!1,!0)}).then(function(){s&&n.personalConversationService.toggleFollowSettingForChannel(r),i(!0)}).catch(function(e){n.logger.error("failed to get channel for follow action"),i(!1)})}catch(e){o(e)}}):(this.logger.error("missing channel id for follow action"),Promise.resolve(!1))},t.prototype.favoriteAction=function(e,t,n){var i=this;return e&&t?e===t?(this.personalConversationService.toggleFavoriteSettingForTeam(e,n),Promise.resolve(!0)):new Promise(function(e,o){try{i.channelService.getChannelById(t).then(function(t){i.personalConversationService.toggleFavoriteSettingForChannel(t,!1,n),e(!0)}).catch(function(t){i.logger.error("failed to get channel for favorite action"),e(!1)})}catch(e){o(e)}}):(this.logger.error("missing team or channel id for favorite action"),Promise.resolve(!1))},t}(o.TeamsCortanaActionHandlerBase);t.TeamChannelActionHandler=r,angular.module("teamspace.teamChannelActionHandler",["teamspace.channelService","teamspace.loggingService","teamspace.peopleService","teamspace.personalConversationService","teamspace.teamMembershipService"]).service("teamChannelActionHandler",r)},1608:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=teamspace.services.CortanaDevToolsStorageKeys,o={MsaAuthHeaderName:"X-Search-DelegationRPSToken",AuthHeaderName:"Authorization",QosHeaderName:"X-Cortana-Quality",DebugQP:"testhooks",SetFlightQP:"setflight",AddFeaturesQP:"addfeaturesnoexpansion",DebugResponseOptions:"debugresponseoptions"},r=function(){function e(e,t,n,i){this.authenticationService=e,this.constants=t,this.settingsService=n,this.storageService=i,this.cortanaDebugConstants=n.valueFor(t.settings.names.cortanaDebugConstants)}return e.$inject=["authenticationService","constants","settingsService","storageService"],e.prototype.getToken=function(e){var t=this;return void 0===e&&(e=!0),new Promise(function(n,o){var r=t.settingsService.valueFor(t.constants.settings.names.cortanaConstants),s=t.settingsService.valueAsBoolean(t.constants.settings.names.enableCompliantCortana)?r.serviceResourceCpt:r.serviceResource;t.authenticationService.getAuthTokens([s]).then(function(r){if(t.isUsingMSA()){var s=t.storageService.get(i.cortanaMSAToken)||"",a=t.getTokenFromUrl(s);return a?n(a):o("invalid token")}var c=t.parseTokenExpiry(r);return t.storageService.set("ctokenexpiresat",c),n(e?t.getCredentialType()+" "+r:r)}).catch(function(e){return o(e)})})},e.prototype.getHeaderName=function(){return this.isUsingMSA()?o.MsaAuthHeaderName:o.AuthHeaderName},e.prototype.getCredentialType=function(){return this.isUsingMSA()?"":"Bearer"},e.prototype.getCortanaConnectedToken=function(){var e=this;return new Promise(function(t,n){e.authenticationService.getAuthTokens([e.settingsService.valueFor(e.constants.settings.names.cortanaConstants).connectedTokenResource]).then(function(e){return t(e)}).catch(function(e){return n(e)})})},e.prototype.getAdditionalParams=function(){var e=this.settingsService.valueAsBoolean(this.constants.settings.names.enableCompliantCortana),t=this.settingsService.valueFor(this.constants.settings.names.cortanaConstants),n={},r="true"===this.storageService.get(i.debugMode);r&&(n[o.DebugQP]="1",n[o.DebugResponseOptions]="requestbody,responsebody"),t.qualityOfService&&(n[o.QosHeaderName]=t.qualityOfService);var s=this.parseFlights(this.storageService.get(i.features));e&&s&&r&&(n[o.AddFeaturesQP]=s);var a=this.storageService.get(i.flight)||"";this.isUsingMSA()||(a=a.concat(",",t.defaultFlights));var c=this.parseFlights(a);if(c&&(n[o.SetFlightQP]=c),!this.cortanaDebugConstants||"true"!==this.storageService.get(i.enableRHOverride))return n;var l=this.parseUrl(this.storageService.get(i.reactiveHostEndpoint)),u=this.parseUrl(this.storageService.get(i.hrsEndpoint)),d={};if(d[o.DebugQP]="1",(l||u)&&(d[this.cortanaDebugConstants.augmentationQP]="",l&&(d[this.cortanaDebugConstants.augmentationQP]=d[this.cortanaDebugConstants.augmentationQP].concat("["+this.cortanaDebugConstants.rhAugmentationKey+' Endpoint="'+l.hostname+'" Port="'+(l.port||"80")+'"]')),u&&(d[this.cortanaDebugConstants.augmentationQP]=d[this.cortanaDebugConstants.augmentationQP].concat("["+this.cortanaDebugConstants.rhhrsAugmentationKey+' Endpoint="'+u.hostname+'" Port="'+(u.port||"80")+'"]'))),e)Object.assign(n,d);else{n[o.SetFlightQP]&&(d[o.SetFlightQP]=n[o.SetFlightQP]);var p=0,h=this.cortanaDebugConstants.cortanaAgentVip+this.cortanaDebugConstants.cortanaAgentEndpoint;_.forOwn(d,function(e,t){h+=(0==p++?"?":"&")+t+"="+e}),n[this.cortanaDebugConstants.overrideUrlQP]=h}return n},e.prototype.getTokenExpiry=function(){return this.storageService.get("ctokenexpiresat")||0},e.prototype.parseFlights=function(e){if(!e)return"";var t=new Set,n=[];return e.split(",").filter(function(e){return!!e}).forEach(function(e){e.startsWith("-")?t.add(e.substr(1)):n.push(e)}),n=n.filter(function(e){return!t.has(e)}),_.uniq(n).join(",")},e.prototype.parseTokenExpiry=function(e){var t=teamspace.services.UtilityServiceStatics.parseJwt(e);if(!t||!t.JWSPayload)return 0;try{var n=teamspace.services.UtilityServiceStatics.base64DecodeStringUrlSafe(t.JWSPayload);if(!n)return 0;var i=JSON.parse(n);return i.exp?1e3*i.exp:0}catch(e){return 0}},e.prototype.parseUrl=function(e){if(!e)return null;try{return new URL("https://"+e)}catch(e){return null}},e.prototype.getTokenFromUrl=function(e){var t=-1,n=e.indexOf("access_token=");return-1!==n&&(t=e.indexOf("&",n)),-1===n||-1===t?"":decodeURIComponent(e.substring(n+13,t))},e.prototype.isUsingMSA=function(){return"true"===this.storageService.get(i.useMSA)},e}();t.CortanaAuthService=r,angular.module("teamspace.cortanaAuthService",["teamspace.authenticationService","teamspace.settingsService","teamspace.storageService"]).service("cortanaAuthService",r)},1609:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),r=function(e){function t(t,n,i,r,s,a,c,l,u,d,p,h,g,v,S,f,m,C){var y=e.call(this,t)||this;return y.orchestrationService=t,y.$rootScope=n,y.authenticationService=i,y.callForwardingSettingsService=r,y.callingService=s,y.callingSupportService=a,y.channelService=c,y.constants=l,y.contentSharingService=u,y.conversationsService=d,y.eventingService=p,y.geoRoutingService=h,y.peopleSlugService=v,y.routeUtilityService=S,y.settingsService=f,y.tabService=m,y.platformDetectService=C,y.teamsClientContextVersion=2,y.logger=g.newLogger("CortanaClientContextService"),y.teamsToSkillCallStateMap=new Map,y.teamsToSkillCallStateMap.set(0,o.ICommCallState.idle),y.teamsToSkillCallStateMap.set(1,o.ICommCallState.calling),y.teamsToSkillCallStateMap.set(2,o.ICommCallState.calling),y.teamsToSkillCallStateMap.set(3,o.ICommCallState.inCall),y.teamsToSkillCallStateMap.set(4,o.ICommCallState.onHold),y.teamsToSkillCallStateMap.set(5,o.ICommCallState.inCall),y.teamsToSkillCallStateMap.set(6,o.ICommCallState.inCall),y.teamsToSkillCallStateMap.set(7,o.ICommCallState.idle),y.teamsToSkillCallStateMap.set(8,o.ICommCallState.idle),y.teamsToSkillCallTypeMap=new Map,y.teamsToSkillCallTypeMap.set(-1,o.ICommCallType.Unknown),y.teamsToSkillCallTypeMap.set(1,o.ICommCallType.P2P),y.teamsToSkillCallTypeMap.set(2,o.ICommCallType.Conference),y}return i(t,e),t.$inject=["orchestrationService","$rootScope","authenticationService","callForwardingSettingsService","callingService","callingSupportService","channelService","constants","contentSharingService","conversationsService","eventingService","geoRoutingService","loggingService","peopleSlugService","routeUtilityService","settingsService","tabService","platformDetectService"],t.prototype.initializeOnAppLaunchAndReinit=function(e){this.logger.info("initializeOnAppLaunchAndReinit: reason = {0}",e)},t.prototype.cleanupOnAppTeardown=function(e){this.logger.info("cleanupOnAppTeardown: reason = {0}",e),this.deinitialize(),this.mtEndpoint=null,this.mtImageEndpoint=null,this.profilePicUrlFormat=null,this.currentUser=null,this.isForwardingActive=!1,this.pptSharingSession=null,this.forwardingSettingsListener=null,this.frontOfRoomPptSlidesCountListener=null,this.sharingSessionCreatedSubscription=null,this.sharingSessionDisposedSubscription=null},t.prototype.mtmaTelemetryIdentifier=function(){return"CortanaClientContextService"},t.prototype.initialize=function(){var e=this;this.initializeCommunication(),this.subscribeContentSharingChanges();var t=this.settingsService.valueFor(this.constants.settings.names.middleTierConstants);return Promise.all([this.geoRoutingService.getServiceEndpoint(t.newEndpointAddress),this.geoRoutingService.getServiceEndpoint(t.newEndpointAddressImg),this.authenticationService.getUserInformation()]).then(function(t){return 3===t.length&&t[0]&&t[1]?t[2]&&t[2].profile?(e.mtEndpoint=t[0],e.mtImageEndpoint=t[1],e.profilePicUrlFormat=t[1]+e.constants.urls.cortana.profilePicPathFormat,e.currentUser={id:t[2].profile.upn,displayName:t[2].profile.name,firstName:t[2].profile.given_name,lastName:t[2].profile.family_name},!0):(e.logger.error("failed to get user information"),!1):(e.logger.error("failed to get service endpoint"),!1)}).catch(function(t){return e.logger.error("failed to get service endpoint"),!1})},t.prototype.deinitialize=function(){this.forwardingSettingsListener&&(this.forwardingSettingsListener(),this.forwardingSettingsListener=null),this.frontOfRoomPptSlidesCountListener&&(this.frontOfRoomPptSlidesCountListener(),this.frontOfRoomPptSlidesCountListener=null),this.sharingSessionCreatedSubscription&&(this.sharingSessionCreatedSubscription.dispose(),this.sharingSessionCreatedSubscription=null),this.sharingSessionDisposedSubscription&&(this.sharingSessionDisposedSubscription.dispose(),this.sharingSessionDisposedSubscription=null),this.mtEndpoint=null,this.mtImageEndpoint=null,this.profilePicUrlFormat=null,this.currentUser=null,this.isForwardingActive=!1,this.pptSharingSession=null},t.prototype.onCortanaConfigUpdated=function(e){},t.prototype.getClientContext=function(){var e=this.settingsService.getRing(),t={version:this.teamsClientContextVersion,mtEndpoint:this.mtEndpoint,mtImageEndpoint:this.mtImageEndpoint,profilePicUrlFormat:this.profilePicUrlFormat,teamsRing:e?e.id:"",user:this.currentUser},n={teamsContext:t,communicationContextState:this.getCommunicationState(),inMeetingPrivateContext:this.getPrivateInMeetingContext(),currentLocation:null},i=this.routeUtilityService.getRootRouteParams();this.setCurrentTeamAndChannel(t),this.setCurrentConversation(t,i);var o=this.tabService.getCurrentTab();return t.teamsPlatform={personalAppId:i.appId,tabId:o&&o.id},i.fileId&&i.fileType&&i.objectUrl&&(t.file={objectId:i.fileId,objectUrl:i.objectUrl,type:i.fileType}),n},t.prototype.setCurrentTeamAndChannel=function(e){var t=this.channelService.getCurrentTeamAndChannel();t&&(t.team&&(e.team={objectId:t.team.objectId,displayName:t.team.displayName}),t.channel&&(e.channel={objectId:t.channel.objectId,displayName:t.channel.displayName}))},t.prototype.setCurrentConversation=function(e,t){var n="",i=!1,o=t.peopleSlug||t.slug,r=o&&this.peopleSlugService.resolve(o),s=r&&r.conversation;if(s)i=!s.isBotBlocked,n=s.id;else{var a=e.channel&&e.channel.objectId||e.team&&e.team.objectId;if(!a)return;var c=this.conversationsService.getConversation(a);if(!c)return;i=!0,n=c.id}e.conversation={id:n,isPostingAllowed:i}},t.prototype.subscribeContentSharingChanges=function(){var e=this;this.sharingSessionCreatedSubscription=this.contentSharingService.onSharingSessionCreated(function(t){"ppt"===t.contentType&&(e.logger.info("New ppt Content sharing session created, updating VoiceSkills pptSession"),e.pptSharingSession=t)}),this.sharingSessionDisposedSubscription=this.contentSharingService.onSharingSessionDisposed(function(t){e.pptSharingSession&&e.pptSharingSession.id===t&&(e.logger.info("Existing pptSession ended updating VoiceSkills pptSession"),e.pptSharingSession=null)}),this.frontOfRoomPptSlidesCountListener=this.eventingService.$on(this.$rootScope,this.constants.events.rigel.service.eventTypes.frontOfRoomPptSlidesCount,function(t,n){e.platformDetectService.isRigel()&&e.pptSharingSession&&(e.pptSharingSession.slidesCount=n)})},t.prototype.initializeCommunication=function(){var e=this;return this.callForwardingSettingsService.getSettings().then(function(t){return e.updateForwardingSettings(t),e.forwardingSettingsListener=e.eventingService.$on(e.$rootScope,e.constants.events.calling.callForwardingSettingsChanged,function(t,n){n&&n.callForwardingSettings&&e.updateForwardingSettings(n.callForwardingSettings)}),!0}).catch(function(){return e.logger.error("failed to initialize communication data"),!1})},t.prototype.updateForwardingSettings=function(e){e&&(this.isForwardingActive=e.callForwardingSettings&&e.callForwardingSettings.isEnabled)},t.prototype.getCommunicationState=function(){var e=this,t={calls:[],forwardCallsActive:!!this.isForwardingActive},n=this.callingService.getAllCalls();return n&&(t.calls=n.map(function(t){var n=e.conversationsService.getCallingConversation(t.conversationId);return{callId:t.callId,channel:"teams",state:e.teamsToSkillCallStateMap.get(t.state)||o.ICommCallState.idle,iCalUid:n&&n.meetingInfo?n.meetingInfo.iCalUid:"",supportsAddContactToCall:e.callingSupportService.isAddingParticipantAllowed(t),supportsAddNumberToCall:e.callingSupportService.isAddingParticipantAllowed(t)&&t.isPstnAvailable,supportsHold:e.callingSupportService.isHoldResumeAllowed(t),supportsResume:4===t.state,supportsTransferCall:e.callingSupportService.isTransferAllowed(t),teamsData:{conversationId:t.conversationId,callType:e.teamsToSkillCallTypeMap.get(t.callType)||o.ICommCallType.Unknown}}})),t},t.prototype.getPrivateInMeetingContext=function(){var e={version:"1.0.0",presentations:[],settings:{channelsSettings:{}}},t=this.callingService.getActiveCalls();return t&&t[0]&&this.pptSharingSession&&(e.presentations.push({isUserPresentor:3===this.pptSharingSession.mode,deckUrl:this.pptSharingSession.contentDto.url,numberOfSlides:this.pptSharingSession.slidesCount,currentSlideIndex:this.pptSharingSession.slide.slideIndex,callId:t[0].callId}),3!==this.pptSharingSession.mode&&(this.platformDetectService.isRigel()?e.settings.channelsSettings.teams={supportPrivateNavigation:!1}:e.settings.channelsSettings.teams={supportPrivateNavigation:!this.settingsService.valueAsBoolean(this.constants.settings.names.disablePrivateViewingOfPptConsuming)||this.pptSharingSession.privateViewingEnabled})),e},t}(teamspace.services.MTMABase);t.CortanaClientContextService=r,angular.module("teamspace.cortanaClientContextService",["teamspace.constants","teamspace.callForwardingSettingsService","teamspace.callingService","teamspace.callingSupportService","teamspace.channelService","teamspace.conversationsService","teamspace.eventingService","teamspace.geoRoutingService","teamspace.loggingService","teamspace.peopleSlugService","teamspace.routeUtilityService","teamspace.settingsService","teamspace.tabService","teamspace.contentSharingService"]).service("cortanaClientContextService",r)},1610:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=function(e){function t(t,n,i,o){var r=e.call(this,t)||this;return r.orchestrationService=t,r.logger=i.newLogger("CortanaClientSkillsConfigService"),r.providers=[o,n],r.initializeOnAppLaunchAndReinit("launch"),r}return i(t,e),t.$inject=["orchestrationService","communicationSkillConfigProvider","loggingService","systemSkillConfigProvider"],t.prototype.initializeOnAppLaunchAndReinit=function(e){this.logger.info("initializeOnAppLaunchAndReinit: reason = {0}",e)},t.prototype.cleanupOnAppTeardown=function(e){this.logger.info("cleanupOnAppTeardown: reason = {0}",e),this.deinitialize()},t.prototype.mtmaTelemetryIdentifier=function(){return"CortanaClientSkillsConfigService"},t.prototype.initialize=function(){var e=this;return Promise.all(this.providers.map(function(e){return e.initialize()})).then(function(t){return t.every(function(e){return e})?(e.logger.info("{0} providers loaded and ready",e.providers.length),!0):(e.logger.error("failed to initialize config providers"),!1)})},t.prototype.deinitialize=function(){this.providers.forEach(function(e){e.clearCallback(),e.deinitialize()})},t.prototype.getConfigProviders=function(){return this.providers},t}(teamspace.services.MTMABase);t.CortanaClientSkillsConfigService=o,angular.module("teamspace.cortanaClientSkillsConfigService",["teamspace.loggingService","teamspace.communicationSkillConfigProvider","teamspace.systemSkillConfigProvider"]).service("cortanaClientSkillsConfigService",o)},1611:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1612);angular.module("teamspace.cortanaJSFactory",[]).factory("cortanaJSFactory",function(){return function(e,t,n){return new i.CortanaJS(e,t,n)}})},1612:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o,r=n(1613),s=n(1614),a=n(1615),c=n(1616),l=n(1617),u=n(1618),d=n(1619),p=n(1620),h=n(1621),g=n(31),v=n(75),S=n(1622),f=n(1623),m=n(1),C=n(198),y=n(1624),A=n(200),k=n(1625),b=n(49),I=3e4;!function(e){e[e.Agent=0]="Agent",e[e.End=1]="End",e[e.Listen=2]="Listen"}(o||(o={}));var T=function(e){function t(t,n,i){var o=e.call(this)||this;return o.cortanaJSConfig=n,o.logger=t.newLogger("CortanaJS"),o.cortanaSessions=new Map,o.clientSkillsManager=new f.ClientSkillsManager(o.logger,function(e,t,n){var i=o.getCortanaSessionByRequestId(e),r={cortanaJSSessionId:i&&i.sessionId,requestId:e,data:t,skillResponseData:n};o.trigger(C.CortanaJSEvents.clientSkillInvoked,r)}),o.cardSkillHandler=new s.CardSkillHandler,o.clientSkillsManager.registerSkillHandler(new u.SystemSkillHandler),o.clientSkillsManager.registerSkillHandler(new r.AgentSkillHandler),o.clientSkillsManager.registerSkillHandler(new l.LocationSkillHandler),o.clientSkillsManager.registerSkillHandler(new d.SpeechSkillHandler),o.clientSkillsManager.registerSkillHandler(o.cardSkillHandler),o.clientSkillsManager.registerSkillHandler(new h.TeamsSkillHandler),o.clientSkillsManager.registerSkillHandler(new a.CommunicationSkillHandler),o.clientSkillsManager.registerSkillHandler(new c.InMeetingSkillHandler),o.clientSkillsManager.registerSkillHandler(new p.SkypeSkillHandler),n.configProviders&&n.configProviders.forEach(function(e){o.clientSkillsManager.registerSkillConfigProvider(e)}),o.speechConnectionService=new k.SpeechConnectionService(n.speechServiceUrl,i,t.newLogger("SpeechConnectionService"),n.speechConnectTimeoutInMs||I),o.speechConnectionService.initialize(b.SpeechResultFormat.Simple,n.speechLocale,n.speechEnvironment,!!n.enableSubProtocolAuth),o.agentHelper=new S.AgentHelper,o.recognizer=new y.Recognizer(t.newLogger("Recognizer"),o.clientSkillsManager,o.speechConnectionService,n.isUsingAudioStream),o.recognizer.subscribe(function(e,t){return o.onCortanaResponded(t)},A.RecognitionEvents.cortanaResponded),o.recognizer.subscribe(function(e,t){return o.triggerRecognitionEvent(C.CortanaJSEvents.listeningStarted,t)},A.RecognitionEvents.listeningStarted),o.recognizer.subscribe(function(e,t){return o.triggerRecognitionEvent(C.CortanaJSEvents.recognitionEnded,t)},A.RecognitionEvents.recognitionEnded),o.recognizer.subscribe(function(e,t){return o.onRecognitionStarted(t)},A.RecognitionEvents.recognitionStarted),o.recognizer.subscribe(function(e,t){return o.triggerRecognitionEvent(C.CortanaJSEvents.speechPhrase,t)},A.RecognitionEvents.speechDetailedPhrase),o.recognizer.subscribe(function(e,t){return o.triggerRecognitionEvent(C.CortanaJSEvents.speechPhrase,t)},A.RecognitionEvents.speechSimplePhrase),o.recognizer.subscribe(function(e,t){return o.triggerRecognitionEvent(C.CortanaJSEvents.speechEndDetected,t)},A.RecognitionEvents.speechEndDetected),o.recognizer.subscribe(function(e,t){return o.triggerRecognitionEvent(C.CortanaJSEvents.speechHypothesis,t)},A.RecognitionEvents.speechHypothesis),o.recognizer.subscribe(function(e,t){return o.triggerRecognitionEvent(C.CortanaJSEvents.speechStartDetected,t)},A.RecognitionEvents.speechStartDetected),o.updateConfiguration(n),o}return i(t,e),t.prototype.startRecognizer=function(e,t){var n=e?this.agentHelper.createQueryEvent(e):null;return this.startRecognizerInternal(n,t)},t.prototype.submitAction=function(e,t,n){var i=this.agentHelper.createCardSubmitEvent(e,t);return this.startRecognizerInternal(i,n)},t.prototype.sendCustomEvent=function(e,t){return this.startRecognizerInternal(e,t)},t.prototype.triggerSkill=function(e,t,n,i,o){var r=this.agentHelper.createInvokeSkillEvent(e,t,n,i);return this.startRecognizerInternal(r,o)},t.prototype.stopRecognizer=function(e){var t=this.getActiveCortanaSession();t&&(t.isEnding=!0),this.recognizer.stop(!0)},t.prototype.stopListening=function(){this.recognizer.stop(!1,!0)},t.prototype.isIdle=function(){return!this.getActiveCortanaSession()},t.prototype.cancel=function(e){this.logger.info("cancel {0} request",e);var t=e===C.CancelState.Listening?this.agentHelper.createListenCanceledEvent():e===C.CancelState.Responding?this.agentHelper.createOutputCanceledEvent():this.agentHelper.createConversationResetEvent();return this.recognizer.recognize(null,t,!0).then(function(e){return!0}).catch(function(e){return!1})},t.prototype.ignoreListeningAction=function(){var e=this.getActiveCortanaSession();e&&(e.isIgnoringListen=!0)},t.prototype.setAudioSource=function(e){this.recognizer.setAudioSource(e)},t.prototype.resetConnection=function(){this.speechConnectionService.closeConnection()},t.prototype.verifyConnection=function(){var e=this;this.recognizer.verifyConnection().catch(function(t){e.logger.error("failed to verify connection")})},t.prototype.updateConfiguration=function(e){e&&(this.cortanaJSConfig.speechServiceUrl===e.speechServiceUrl&&this.cortanaJSConfig.speechEnvironment===e.speechEnvironment||this.speechConnectionService.updateServiceUrl(e.speechServiceUrl,e.speechEnvironment),this.cortanaJSConfig=e,this.clientSkillsManager.enableSkill(m.ClientSkillsId.card,e.isAdaptiveCardEnabled),this.clientSkillsManager.enableSkill(m.ClientSkillsId.speechRecognizer,!e.isFollowUpDisabled),this.clientSkillsManager.enableSkill(m.ClientSkillsId.location,e.isLocationEnabled))},t.prototype.createCortanaSession=function(){var e={sessionId:g.CortanaUtilities.createNoDashGuid(),sessionEvents:[],clientSkillsPromise:null,cortanaResponse:null,currentRequestId:null,prevRecognitionEventTimestamp:Date.now()};return this.cortanaSessions.set(e.sessionId,e),e},t.prototype.getCortanaSession=function(e){return e&&this.cortanaSessions.has(e)?this.cortanaSessions.get(e):null},t.prototype.getCortanaSessionByRequestId=function(e){if(!e)return null;for(var t=this.cortanaSessions.values(),n=t.next();n&&!n.done;){if(n.value.currentRequestId===e)return n.value;n=t.next()}return null},t.prototype.removeCortanaSession=function(e){this.logger.info("ending session {0}",e);var t=this.getCortanaSession(e);return!!t&&(t.sessionEvents&&t.sessionEvents.length&&this.logger.info("removing session with pending events"),this.cortanaSessions.delete(e),!0)},t.prototype.getActiveCortanaSession=function(){var e=this.cortanaSessions.values();return e&&e.next().value},t.prototype.startRecognizerInternal=function(e,t){var n=this;t&&this.clientSkillsManager.setSkillsContext(t);var i=this.getActiveCortanaSession();i&&this.removeCortanaSession(i.sessionId),(i=this.createCortanaSession()).isInitialTextQuery=e&&e.event===m.ClientSkillsEvents.text,i.isInitialUxQuery=e&&e.event==m.ClientSkillsEvents.submit,i.isIgnoringListen=i.isInitialUxQuery,i.sessionEvents.push({eventType:e?o.Agent:o.Listen,agentEvent:e});var r=!0,s=function(){if(!i.sessionEvents.length)return i.isEnding=!0,Promise.resolve(!0);var e=i.sessionEvents.splice(0,1)[0];return i.isEnding||e.eventType===o.End||!r&&e.eventType===o.Listen&&i.isIgnoringListen?(i.isEnding=!0,Promise.resolve(!0)):(r=!1,i.cortanaResponse=null,i.currentRequestId=g.CortanaUtilities.createNoDashGuid(),n.recognizer.recognize(i.currentRequestId,e.eventType===o.Agent?e.agentEvent:null).then(function(e){return i.clientSkillsPromise?i.clientSkillsPromise:null}).then(function(e){return i.clientSkillsPromise=null,s()}))};return s().then(function(e){return n.removeCortanaSession(i.sessionId),e}).catch(function(e){return n.logger.error("recognize failed"),n.removeCortanaSession(i.sessionId),!1})},t.prototype.triggerRecognitionEvent=function(e,t){if(t){var n,i,o=this.getCortanaSessionByRequestId(t.requestId);o?(n=o.sessionId,i=t.eventTime-o.prevRecognitionEventTimestamp,o.prevRecognitionEventTimestamp=t.eventTime):this.logger.error("not able to find session from request id");var r={cortanaJSSessionId:n,requestId:t.requestId,elapsedTime:i,serviceTag:t.serviceTag,connectionId:t.connectionId,isRequestCanceled:t.isRequestCanceled,data:t.result||null};this.trigger(e,r)}else this.logger.error("no recognition event")},t.prototype.onRecognitionStarted=function(e){this.recognizer.getActiveRequest(e.requestId)?this.triggerRecognitionEvent(C.CortanaJSEvents.recognitionStarted,e):this.logger.error("onRecognitionStarted: request not found or canceled")},t.prototype.onCortanaResponded=function(e){if(this.recognizer.getActiveRequest(e.requestId)){var t=this.getCortanaSessionByRequestId(e.requestId);if(t){t.cortanaResponse=e.result;var n=this.clientSkillsManager.handleResponse(e.requestId,e.result);t.clientSkillsPromise=Promise.all(n).then(function(e){return e?(e.forEach(function(e){e&&(e.shouldListen?t.sessionEvents.push({eventType:o.Listen}):e.shouldSendEvent&&e.agentEvent&&t.sessionEvents.push({eventType:o.Agent,agentEvent:e.agentEvent}))}),e):e});var i=this.checkTeamsJsonPayload(e.result),r=null,s=this.cardSkillHandler.getAdaptiveCards(e.result);s&&s.length>0&&!i&&(r=s.map(function(e){return{cardId:e.id,adaptiveCard:e.adaptive}})),e.result.adaptiveResponses=r,this.triggerRecognitionEvent(C.CortanaJSEvents.cortanaResponded,e)}else this.logger.error("onCortanaResponded: no active session found")}else this.logger.error("onCortanaResponded: request not found or canceled")},t.prototype.checkTeamsJsonPayload=function(e){var t="";if(!e||!e.skills||0===e.skills.length)return t;var n=e.skills.find(function(e){return e.id===m.ClientSkillsId.card});if(!n||!n.cards||0===n.cards.length||!n.cards[0].adaptive)return t;var i=n.cards[0].adaptive.body;if(!i||i.length<2)return t;if(_.find(i,function(e){return"textblock"===_.toLower(e.type)&&"extralarge"===_.toLower(e.size)&&"teams"===_.toLower(e.text)})){var o=_.find(i,function(e){return"textblock"===_.toLower(e.type)&&"small"===_.toLower(e.size)&&e.isSubtle});o&&(t=o.text)}return t},t}(v.EventSource);t.CortanaJS=T},1613:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=function(){function e(){this.skillId=i.ClientSkillsId.agent,this.contextId=""}return e.prototype.handleSkill=function(e){var t=this;if(e.action!==i.ClientSkillsActions.callback)return Promise.resolve(null);var n=e;return new Promise(function(e,o){setTimeout(function(){return e({shouldListen:!1,shouldSendEvent:!0,agentEvent:{id:t.skillId,event:i.ClientSkillsActions.callback,cookie:n.cookie}})},n.interval||250)})},e.prototype.updateConfig=function(e){},e.prototype.getContext=function(){return null},e.prototype.setContext=function(e){},e}();t.AgentSkillHandler=o},1614:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=function(){function e(){this.skillId=i.ClientSkillsId.card,this.contextId="card"}return e.prototype.handleSkill=function(e){return Promise.resolve(null)},e.prototype.updateConfig=function(e){this.cardContext=new i.CardContext("Adaptive")},e.prototype.getContext=function(){return this.cardContext},e.prototype.setContext=function(e){},e.prototype.getAdaptiveCards=function(e){var t=e&&e.skills&&e.skills.find(function(e){return e.id===i.ClientSkillsId.card});return t&&t.cards&&t.cards.filter(function(e){return!!e.adaptive})},e.prototype.getAdaptiveCardInputs=function(e){var t=[];if(!e||!e.body)return t;var n=[];for(n=n.concat(e.body);0!==n.length;){for(var i=n.length,o=0;o<i;++o){var r=n[o];r&&(r.columns?n=n.concat(r.columns):r.items?n=n.concat(r.items):r.type&&r.type.toLowerCase().startsWith("input.")&&t.push(r))}n.splice(0,i)}return t},e}();t.CardSkillHandler=o},1615:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=function(){function e(){this.skillId=i.ClientSkillsId.communication,this.contextId="communication"}return e.prototype.handleSkill=function(e){return Promise.resolve({allowCallback:!0})},e.prototype.updateConfig=function(e){this.communicationContext=new i.CommunicationContext,this.communicationContext.settings=e},e.prototype.getContext=function(){return this.communicationContext},e.prototype.setContext=function(e){e&&(this.communicationContext.state=e.communicationContextState)},e}();t.CommunicationSkillHandler=o},1616:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=function(){function e(){this.skillId=i.ClientSkillsId.meeting,this.contextId="private"}return e.prototype.handleSkill=function(e){return Promise.resolve({allowCallback:!0})},e.prototype.updateConfig=function(e){},e.prototype.getContext=function(){return this.inMeetingPrivateContext},e.prototype.setContext=function(e){this.inMeetingPrivateContext=new i.InMeetingPrivateContext(e.inMeetingPrivateContext)},e}();t.InMeetingSkillHandler=o},1617:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=function(){function e(){this.skillId=i.ClientSkillsId.location,this.contextId="location"}return e.prototype.handleSkill=function(e){return Promise.resolve(null)},e.prototype.updateConfig=function(e){},e.prototype.getContext=function(){return this.locationContext},e.prototype.setContext=function(e){e.currentLocation&&e.currentLocation.coords?(this.locationContext=new i.LocationContext(e.currentLocation.coords.latitude,e.currentLocation.coords.longitude,e.currentLocation.coords.accuracy),this.locationContext.state.timestamp=new Date(e.currentLocation.timestamp).toISOString()):this.locationContext=null},e}();t.LocationSkillHandler=o},1618:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=function(){function e(){this.skillId=i.ClientSkillsId.system,this.contextId="system"}return e.prototype.handleSkill=function(e){return Promise.resolve(null)},e.prototype.updateConfig=function(e){e&&(this.systemContext=new i.SystemContext(e.language,e.region,e.timezoneOffset,e.deviceId,e.deviceName,e.os,e.device,e.app))},e.prototype.getContext=function(){return this.systemContext},e.prototype.setContext=function(e){e.clientTag&&(this.systemContext.state={clientTag:btoa(e.clientTag)})},e}();t.SystemSkillHandler=o},1619:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=function(){function e(){this.skillId=i.ClientSkillsId.speechRecognizer,this.contextId="speech"}return e.prototype.handleSkill=function(e){return Promise.resolve({shouldListen:!0})},e.prototype.updateConfig=function(e){this.speechContext=new i.SpeechContext},e.prototype.getContext=function(){return this.speechContext},e.prototype.setContext=function(e){},e}();t.SpeechSkillHandler=o},1620:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=function(){function e(){this.skillId=i.ClientSkillsId.skype,this.contextId="skype"}return e.prototype.handleSkill=function(e){return Promise.resolve({allowCallback:!0})},e.prototype.updateConfig=function(e){},e.prototype.getContext=function(){return null},e.prototype.setContext=function(e){},e}();t.SkypeSkillHandler=o},1621:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=function(){function e(){this.skillId=i.ClientSkillsId.teams,this.contextId="private"}return e.prototype.handleSkill=function(e){return Promise.resolve({allowCallback:!0})},e.prototype.updateConfig=function(e){},e.prototype.getContext=function(){return this.teamsPrivateContext},e.prototype.setContext=function(e){this.teamsPrivateContext=new i.TeamsPrivateContext(e.teamsContext)},e}();t.TeamsSkillHandler=o},1622:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=function(){function e(){}return e.prototype.createQueryEvent=function(e){return{id:i.ClientSkillsId.text,event:i.ClientSkillsEvents.text,input:e}},e.prototype.createListenCanceledEvent=function(){return{id:i.ClientSkillsId.speech,event:i.ClientSkillsEvents.listenCanceled}},e.prototype.createOutputCanceledEvent=function(){return{id:i.ClientSkillsId.speech,event:i.ClientSkillsEvents.speechOutputCanceled}},e.prototype.createConversationResetEvent=function(){return{id:i.ClientSkillsId.system,event:i.ClientSkillsEvents.conversationReset}},e.prototype.createCardSubmitEvent=function(e,t){return{id:i.ClientSkillsId.card,event:i.ClientSkillsEvents.submit,cardId:e,inputs:t}},e.prototype.createTcpTestEvent=function(e,t){return{id:i.ClientSkillsId.test,event:i.ClientSkillsEvents.tcp,domain:e,intent:t}},e.prototype.createInvokeSkillEvent=function(e,t,n,o){var r=o||i.ClientSkillsId.private;return r.startsWith(i.ClientSkillsId.private)||(r=i.ClientSkillsId.private),{id:r,event:i.ClientSkillsEvents.invokeSkill,domain:e,intent:t,slots:n}},e}();t.AgentHelper=o},1623:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){this.logger=e,this.invokeSkillCallback=t,this.skillHandlers=new Map}return e.prototype.registerSkillHandler=function(e){var t=this.getSkillHandler(e.skillId);t&&t.handler?this.logger.warn("duplicate registration of {0} skill",e.skillId):((t=t||{}).handler=e,t.isActive=!0,e.updateConfig(null),this.skillHandlers.set(e.skillId,t))},e.prototype.registerSkillConfigProvider=function(e){var t=this,n=this.getSkillHandler(e.skillId);n&&n.configProvider?this.logger.warn("duplicate registration of {0} config provider",e.skillId):((n=n||{}).configProvider=e,e.registerCallback(function(e){return t.onConfigProviderUpdate(e)}),this.skillHandlers.set(e.skillId,n),this.onConfigProviderUpdate(e.skillId))},e.prototype.enableSkill=function(e,t){void 0===t&&(t=!0);var n=this.getSkillHandler(e);n&&(n.isActive=t)},e.prototype.getSkillsContext=function(){var e={};return this.skillHandlers.forEach(function(t){if(t.isActive&&t.handler.contextId){var n=t.handler.getContext();n&&(e[t.handler.contextId]?_.assign(e[t.handler.contextId],n):e[t.handler.contextId]=n)}}),e},e.prototype.setSkillsContext=function(e){this.skillHandlers.forEach(function(t){t.isActive&&t.handler.setContext(e)})},e.prototype.handleResponse=function(e,t){var n=this,i=t&&t.skills||[];if(0===i.length)return[Promise.resolve(null)];var o=[],r=function(t){var i=n.getSkillHandler(t&&t.id);if(!i)return n.logger.info("client skill handler not found: {0}",t?t.id:""),Promise.resolve(null);if(!i.isActive)return n.logger.info("client skill inactive: {0}",t.id),Promise.resolve(null);n.logger.info("invoking {0} client skill",t.id);try{return i.handler.handleSkill(t).then(function(i){return n.invokeSkillCallback&&i&&i.allowCallback&&n.invokeSkillCallback(e,t,i.skillResponseData),i}).catch(function(e){return n.logger.error("error invoking skill: {0}",t.id),null})}catch(e){n.logger.error("handleSkill exception: {0}",t.id)}return Promise.resolve(null)};return i.forEach(function(e){o.push(r(e))}),o},e.prototype.getSkillHandler=function(e){return e&&this.skillHandlers.has(e)?this.skillHandlers.get(e):null},e.prototype.onConfigProviderUpdate=function(e){var t=this.getSkillHandler(e);t&&t.handler&&t.isActive&&t.handler.updateConfig(t.configProvider.getConfig())},e}();t.ClientSkillsManager=i},1624:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o,r=n(199),s=n(31),a=n(75),c=n(193),l=n(200),u=n(49),d=[82,73,70,70,0,0,0,0,87,65,86,69,102,109,116,32,16,0,0,0,1,0,1,0,128,62,0,0,0,125,0,0,2,0,16,0,100,97,116,97,0,0,0,0];!function(e){e.PlaybackError="PlaybackError"}(o||(o={}));var p=function(e){function t(t,n,i,o){var r=e.call(this)||this;return r.logger=t,r.clientSkillsManager=n,r.speechConnectionService=i,r.isUsingAudioStream=o,r.requests=new Map,r.messageHandlers=new Map,r.messageHandlers.set("turn.start",function(e,t){return r.turnStartMessageHandler(e.requestId,t)}),r.messageHandlers.set("turn.end",function(e,t){return r.turnEndMessageHandler(e.requestId)}),r.messageHandlers.set("speech.startdetected",function(e,t){return r.speechStartedMessageHandler(e.requestId,t)}),r.messageHandlers.set("speech.enddetected",function(e,t){return r.speechEndedMessageHandler(e.requestId,t)}),r.messageHandlers.set("speech.hypothesis",function(e,t){return r.speechHypothesisMessageHandler(e.requestId,t)}),r.messageHandlers.set("speech.phrase",function(e,t){return r.speechPhraseMessageHandler(e.requestId,t)}),r.messageHandlers.set("response",function(e,t){return r.agentResponseMessageHandler(e.requestId,t)}),r.messageHandlers.set("audio",function(e,t){return r.audioResponseMessageHandler(e)}),t.info("isUsingAudioStream: {0}",o),r}return i(t,e),t.prototype.recognize=function(e,t,n){var i=this;if(this.requests.size>0)return this.logger.error("outstanding request exists, try again later"),Promise.resolve(null);var o={requestId:e||s.CortanaUtilities.createNoDashGuid(),connectionId:"",serviceTag:"",status:null,isRequestCompleted:!1,isCanceled:!1,isSuppressingEvents:n,requestCompleteCallback:null,isAgentEvent:!!t,turnStartTimeoutTimer:0,latestCortanaResponse:null,audioBuffers:null,messagesTimestamp:new Map,counters:{}};return this.requests.set(o.requestId,o),new Promise(function(e,n){o.requestCompleteCallback=e;try{i.establishConnection(!1).then(function(e){if(o.connectionId=i.speechConnectionService.id,e!==u.ConnectStatus.Success)throw e===u.ConnectStatus.TokenFetchError?o.status=r.RecognitionCompletionStatus.AuthTokenFetchError:e===u.ConnectStatus.Timeout?o.status=r.RecognitionCompletionStatus.ConnectTimeout:o.status=r.RecognitionCompletionStatus.ConnectError,new Error("connection error");if(!o.isAgentEvent&&!i.audioSource)throw o.status=r.RecognitionCompletionStatus.AudioSourceError,new Error("no audio source");if(o.isCanceled)throw o.status=r.RecognitionCompletionStatus.Canceled,new Error("connected, request canceled");return o.isAgentEvent?Promise.resolve(!0):i.audioSource.acquireAudioInputStream()}).then(function(e){if(o.isCanceled)throw o.status=r.RecognitionCompletionStatus.Canceled,new Error("request canceled");if(o.isAgentEvent)return i.sendAgentMessage(o.requestId,t);if(!e)throw o.status=r.RecognitionCompletionStatus.AudioSourceError,new Error("failed to acquire audio input stream");var n=!1;return i.currentConnectionId!==i.speechConnectionService.id&&(i.currentConnectionId=i.speechConnectionService.id,n=!0),o.turnStartTimeoutTimer=setTimeout(function(){i.logger.error("timeout waiting for turn.start message"),o.status=r.RecognitionCompletionStatus.SpeechReadyTimeout,i.speechConnectionService.closeConnection()},15e3),i.sendAgentContext(o.requestId,n)}).then(function(e){o.isAgentEvent||i.sendEmptyAudioPCM(o.requestId)}).catch(function(e){return i.logger.error("recognize error: {0}",e&&e.message||JSON.stringify(e)),i.completeRequest(o.requestId,o.status||r.RecognitionCompletionStatus.UnknownError,e),!1})}catch(e){i.completeRequest(o.requestId,r.RecognitionCompletionStatus.ConnectError,e&&e.message)}})},t.prototype.stop=function(e,t){this.audioSource&&(this.audioSource.stopListening(),this.audioSourceStream=null,t||this.audioSource.stopPlaying()),this.requests.forEach(function(t){t.isCanceled=e})},t.prototype.setAudioSource=function(e){this.audioSource=e},t.prototype.getActiveRequest=function(e){var t=e&&this.requests.get(e);return e?t&&t.isCanceled?null:t:(this.requests.forEach(function(e){e.isCanceled||(t=e)}),t)},t.prototype.verifyConnection=function(){return this.establishConnection(!0).then(function(e){return e===u.ConnectStatus.Success})},t.prototype.getRequest=function(e){return e&&this.requests.has(e)?this.requests.get(e):(this.logger.warn("failed to find request"),null)},t.prototype.onEvent=function(e,t){var n=this.getRequest(e);n&&(n.isSuppressingEvents||n.isCanceled&&t.eventName!==l.RecognitionEvents.recognitionEnded)?this.logger.info("request canceled or suppressed, not sending event {0}",t.eventName):this.trigger(t.eventName,t)},t.prototype.completeAllRequests=function(e,t,n){var i=this;this.requests.forEach(function(o){n&&o.connectionId!==n||i.completeRequest(o.requestId,o.status||e,t)})},t.prototype.completeRequest=function(e,t,n){var i=this.getRequest(e);i&&(this.clearTurnStartTimer(i),this.audioSource&&(this.audioSource.stopListening(),this.audioSourceStream=null),this.onEvent(i.requestId,new l.RecognitionEndedEvent(i.requestId,i.serviceTag,t,n||"",i.connectionId,i.counters,i.isCanceled,i.audioResponseElapsedTime,i.audioResponsePayloadSize)),i.requestCompleteCallback(i.isCanceled||i.isSuppressingEvents?null:i.latestCortanaResponse||null),i.messagesTimestamp.clear(),this.requests.delete(e))},t.prototype.startListening=function(e){var t=this;return this.audioSource?this.audioSource.startListening().then(function(n){if(!n)throw Error("streamReader null");return t.audioSourceStream=n,t.onEvent(e,new l.ListeningStartedEvent(e)),t.sendAudio(e)}).catch(function(n){return t.logger.error("error start listening: {0}",n&&n.message||JSON.stringify(n)),t.completeRequest(e,r.RecognitionCompletionStatus.AudioSourceError,n),!1}):(this.logger.error("error start listening: no audio source"),this.completeRequest(e,r.RecognitionCompletionStatus.AudioSourceError),Promise.resolve(!1))},t.prototype.establishConnection=function(e){var t=this,n=this.speechConnectionService.getConnectionState(!0);return!this.connectionRequestPromise||n!==u.ConnectionState.Connected&&n!==u.ConnectionState.Connecting?(this.connectionRequestPromise=this.speechConnectionService.openConnection(e).then(function(e){if(e!==u.ConnectStatus.Success)return e;var n=t.speechConnectionService.id;return t.receiveMessage().then(function(){t.logger.info("exiting receiveMessage: {0}",n),t.completeAllRequests(r.RecognitionCompletionStatus.Success,null,n),t.speechConnectionService.getConnectionState()===u.ConnectionState.Connected&&t.speechConnectionService.closeConnection()}),u.ConnectStatus.Success}).catch(function(e){return t.logger.error("failed to establish connection: {0}",e&&e.message||JSON.stringify(e)),u.ConnectStatus.Error}),this.connectionRequestPromise):this.connectionRequestPromise},t.prototype.receiveMessage=function(){var e=this;return this.speechConnectionService.readMessage().then(function(t){var n;if(t.contentType&&t.contentType.startsWith("application/json"))try{n=JSON.parse(t.textPayload)}catch(t){return e.logger.warn("ignore message: error parsing JSON message from Cortana"),!0}var i=e.getRequest(t.requestId);if(i){i.messagesTimestamp.has(t.path)?i.messagesTimestamp.get(t.path).push(t.messageTimestamp):i.messagesTimestamp.set(t.path,[t.messageTimestamp]);var o=t.path.toLowerCase();if(e.messageHandlers.has(o))return e.messageHandlers.get(o)(t,n||t.textPayload);e.logger.info("unhandled path: {0}",o)}else e.logger.info("received invalid requestId: {0}",t.requestId);return!0}).then(function(t){return!t||e.receiveMessage()}).catch(function(t){"disposed"!==t&&e.logger.error("receiveMessage error: {0}",t&&t.message||JSON.stringify(t))})},t.prototype.sendAgentContext=function(e,t){var n,i=this,o=this.clientSkillsManager.getSkillsContext();if(t){var r=this.getSpeechConfig(o);r&&(n=this.speechConnectionService.sendTextMessage("speech.config",e,"application/json",JSON.stringify(r)))}n||(n=Promise.resolve(!0));var s={context:o},a=JSON.stringify(s);return this.logger.info("context payload size: {0}",a.length),n.then(function(){return i.speechConnectionService.sendTextMessage("speech.agent.context",e,"application/json",a)})},t.prototype.sendAgentMessage=function(e,t){var n={context:this.clientSkillsManager.getSkillsContext(),event:t};return this.speechConnectionService.sendTextMessage("agent",e,"application/json",JSON.stringify(n))},t.prototype.sendTelemetryData=function(e,t){return this.speechConnectionService.sendTextMessage("telemetry",e,"application/json",t)},t.prototype.sendEmptyAudio=function(e){return this.speechConnectionService.sendBinaryMessage("audio",e,"audio/x-wav",null)},t.prototype.sendEmptyAudioPCM=function(e){var t=new Uint8Array(d.length);return t.set(d,0),this.speechConnectionService.sendBinaryMessage("audio",e,"audio/x-wav",t.buffer)},t.prototype.getSpeechConfig=function(e){if(!e||!this.audioSource)return null;var t=e.system,n=this.audioSource.getAudioInputMediaDeviceInfo();return n&&t&&t.settings&&t.settings.app?(this.logger.info("using audio input stream from: {0} [{1}]",n.model,n.type||""),{context:{os:t.settings.os,device:t.settings.device,audio:{source:{model:n.model,type:n.type,manufacturer:n.manufacturer,connectivity:n.connectivity}},application:{name:t.settings.app.name,version:t.settings.app.version}},scenario:r.SpeechConfigScenarios.cortana}):null},t.prototype.sendAudio=function(e){var t=this,n=function(){return t.audioSourceStream?t.audioSourceStream.read().then(function(n){if(!t.audioSourceStream)return t.sendEmptyAudio(e).then(function(){return!1});var i=n.isEnd?null:n.buffer;return n.isEnd?t.sendEmptyAudio(e).then(function(){return!1}):t.speechConnectionService.sendBinaryMessage("audio",e,"audio/x-wav",i)}).then(function(e){if(!e)return!0;n()}).catch(function(e){if(t.audioSourceStream)throw e;return!0}):t.sendEmptyAudio(e)};return n()},t.prototype.turnStartMessageHandler=function(e,t){var n=this.getRequest(e);if(!n)return Promise.resolve(!0);if(this.clearTurnStartTimer(n),t&&t.context&&t.context.serviceTag&&(n.serviceTag=t.context.serviceTag),this.onEvent(e,new l.RecognitionStartedEvent(e,n.serviceTag,n.connectionId)),n.isAgentEvent)this.onEvent(e,new l.SpeechEndDetectedEvent(e,{}));else{if(n.isCanceled||n.isSuppressingEvents)return this.logger.info("turn.start received, but not start listening due to canceled request"),this.sendEmptyAudio(e).then(function(){return!0});this.startListening(e)}return Promise.resolve(!0)},t.prototype.turnEndMessageHandler=function(e){var t={ReceivedMessages:[],Metrics:[]},n=this.getRequest(e);return n&&n.messagesTimestamp.forEach(function(e,n){var i={};i[n]=e,t.ReceivedMessages=t.ReceivedMessages.concat(i)}),this.completeRequest(e,r.RecognitionCompletionStatus.Success),this.sendTelemetryData(e,JSON.stringify(t)).then(function(){return!0})},t.prototype.speechStartedMessageHandler=function(e,t){return this.onEvent(e,new l.SpeechStartDetectedEvent(e,t)),Promise.resolve(!0)},t.prototype.speechEndedMessageHandler=function(e,t){return this.audioSource&&(this.audioSource.stopListening(),this.audioSourceStream=null),this.onEvent(e,new l.SpeechEndDetectedEvent(e,t)),Promise.resolve(!0)},t.prototype.speechHypothesisMessageHandler=function(e,t){return this.onEvent(e,new l.SpeechHypothesisEvent(e,t)),Promise.resolve(!0)},t.prototype.speechPhraseMessageHandler=function(e,t){return"NBest"in t?this.onEvent(e,new l.SpeechDetailedPhraseEvent(e,t)):this.onEvent(e,new l.SpeechSimplePhraseEvent(e,t)),Promise.resolve(!0)},t.prototype.agentResponseMessageHandler=function(e,t){var n=this.getRequest(e);return n?(n.latestCortanaResponse=t,this.onEvent(e,new l.CortanaResponseEvent(e,n.serviceTag,n.connectionId,t)),Promise.resolve(!0)):Promise.resolve(!0)},t.prototype.audioResponseMessageHandler=function(e){if(e.messageType!==u.MessageType.Binary)return Promise.resolve(!0);var t=this.getRequest(e.requestId);if(!t)return Promise.resolve(!0);var n=!!e.contentType&&!!e.binaryPayload&&!t.audioBuffers,i=!n&&!e.binaryPayload,o=t.isCanceled||t.isSuppressingEvents||!this.audioSource;return this.isUsingAudioStream?this.processAudioResponseFromStream(t,e.binaryPayload,o,n,i):this.processAudioResponseFromBuffer(t,e.binaryPayload,o,n,i)},t.prototype.processAudioResponseFromBuffer=function(e,t,n,i,r){return i?(e.audioResponseStartTime=Date.now(),e.audioResponsePayloadSize=t.byteLength,e.audioBuffers=[t],Promise.resolve(!0)):e.audioBuffers?r?(e.audioResponseElapsedTime=Date.now()-e.audioResponseStartTime,n?(this.logger.info("request canceled, suppressed or no audio device"),e.audioBuffers=null,Promise.resolve(!0)):(e.audioResponsePromise=this.audioSource.playFromBuffer(e.audioBuffers).then(function(t){return t||(e.counters[o.PlaybackError]=(e.counters[o.PlaybackError]||0)+1),e.audioBuffers=null,e.audioResponsePromise=null,t}),e.audioResponsePromise)):(e.audioResponsePayloadSize+=t.byteLength,e.audioBuffers=e.audioBuffers.concat(t),Promise.resolve(!0)):Promise.resolve(!0)},t.prototype.processAudioResponseFromStream=function(e,t,n,i,o){return i&&!n?(e.audioResponseStartTime=Date.now(),e.audioResponsePayloadSize=t.byteLength,e.audioStream=new c.Stream("response"),e.audioStream.write(t),e.audioResponsePromise=this.audioSource.playFromStream(e.audioStream).then(function(t){return e.audioResponsePromise=null,t}),Promise.resolve(!0)):!e.audioStream||e.audioStream&&e.audioStream.isClosed?Promise.resolve(!0):n?(this.logger.info("request canceled, suppressed or no audio device"),e.audioStream.close(),e.audioStream=null,Promise.resolve(!0)):o?(e.audioResponseElapsedTime=Date.now()-e.audioResponseStartTime,e.audioStream.close(),e.audioStream=null,e.audioResponsePromise):(e.audioResponsePayloadSize+=t.byteLength,e.audioStream.write(t),Promise.resolve(!0))},t.prototype.clearTurnStartTimer=function(e){e.turnStartTimeoutTimer>0&&(clearTimeout(e.turnStartTimeoutTimer),e.turnStartTimeoutTimer=0)},t}(a.EventSource);t.Recognizer=p},1625:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(49),r=n(31),s=n(194),a=n(75),c=n(1626),l={connectionId:"X-ConnectionId",connectionIdSub:"ConnectionId",environment:"environment",format:"format",language:"language",outputFormat:"X-Output-AudioCodec",outputFormatSub:"OutputAudioCodec",trafficType:"traffictype"},u=function(e){function t(t,n,i,r){var s=e.call(this)||this;return s.speechServiceUrl=t,s.cortanaAuthProvider=n,s.logger=i,s.connectTimeoutInMs=r,s.newline="\r\n",s.audioOutputFormat="riff-16khz-16bit-mono-pcm",s.connectionState=o.ConnectionState.None,s.connectTimer=0,s}return i(t,e),t.prototype.getConnectionState=function(e){if(this.connectionState===o.ConnectionState.Connected){var t=!1,n=0,i=this.cortanaAuthProvider.getTokenExpiry();return e&&i&&(t=(n=i-Date.now())<=24e4),this.websocketClient&&this.websocketClient.readyState===this.websocketClient.OPEN&&!t?this.connectionState:(t?(this.logger.info("token about to be expired in {0}, force close",n),this.websocketClient.close(1e3,"closeConnection")):this.logger.error("close event not received yet, force cleanup"),this.connectionState=o.ConnectionState.Disconnected,this.cleanupConnection(!0),this.connectionState)}return this.connectionState},t.prototype.initialize=function(e,t,n,i){return this.websocketClient&&this.closeConnection(),this.connectionState=o.ConnectionState.None,this.resultFormat=o.SpeechResultFormat[e].toString().toLowerCase(),this.language=t,this.environment=n,this.enableSubProtocolAuth=i,Promise.resolve(!0)},t.prototype.openConnection=function(e){var t=this;if(this.websocketClient)return this.logger.error("active websocket client exists"),Promise.resolve(o.ConnectStatus.Error);if(this.connectionState===o.ConnectionState.Connecting)return this.logger.error("connecting"),Promise.resolve(o.ConnectStatus.Error);e&&!this.canResumeConnection()&&(e=!1),e||(this.id=r.CortanaUtilities.createNoDashGuid(),this.cleanupConnection(!0),this.receivingMessageQueue=new s.Queue,this.sendMessageQueue=new s.Queue);var n=this.cortanaAuthProvider.getAdditionalParams(),i=new Map;if(i.set(l.format,this.resultFormat),i.set(l.language,this.language),i.set(this.enableSubProtocolAuth?l.connectionIdSub:l.connectionId,this.id),i.set(this.enableSubProtocolAuth?l.outputFormatSub:l.outputFormat,this.audioOutputFormat),i.set(l.environment,this.environment),n)for(var a in n)n[a]&&i.set(a,n[a]);return this.connectionState=o.ConnectionState.Connecting,this.cortanaAuthProvider.getToken().then(function(e){var n;return t.enableSubProtocolAuth?(e=encodeURIComponent(e),n="api.cortana.ai#"+t.cortanaAuthProvider.getHeaderName()+"#"+e):i.set(t.cortanaAuthProvider.getHeaderName(),e),t.createWebsocketClient(i,n)}).catch(function(e){return t.connectionState=o.ConnectionState.Disconnected,t.logger.error("authentication error: {0}",e&&e.message||JSON.stringify(e)),o.ConnectStatus.TokenFetchError})},t.prototype.closeConnection=function(){this.websocketClient&&this.connectionState===o.ConnectionState.Connected&&(this.websocketClient.close(1e3,"closeConnection"),this.connectionState=o.ConnectionState.Disconnected,this.cleanupConnection(!0))},t.prototype.sendTextMessage=function(e,t,n,i,r){return this.sendMessage(new c.SpeechMessage(o.MessageType.Text,e,t,n,i,r))},t.prototype.sendBinaryMessage=function(e,t,n,i,r){return this.sendMessage(new c.SpeechMessage(o.MessageType.Binary,e,t,n,i,r))},t.prototype.readMessage=function(){var e=this;return this.ensureWebsocketConnection().then(function(t){return t&&e.connectionState===o.ConnectionState.Connected?e.receivingMessageQueue.dequeue():Promise.reject("cannot read message on non-connected state")})},t.prototype.updateServiceUrl=function(e,t){this.speechServiceUrl=e||this.speechServiceUrl,this.environment=t||this.environment},t.prototype.sendMessage=function(e){var t=this;return this.ensureWebsocketConnection().then(function(n){if(!n||t.connectionState!==o.ConnectionState.Connected)throw new Error("cannot send message on non-connected state");return t.sendMessageQueue.enqueueFromPromise(t.toWebsocketMessage(e)),!0})},t.prototype.onWebsocketOpen=function(e,t){this.clearConnectTimer(),this.logger.info("connection opened: {0}",this.id),this.connectionState=o.ConnectionState.Connected,this.trigger(o.SpeechConnectionEvents.connectionEstablished,{connectionId:this.id}),t(o.ConnectStatus.Success)},t.prototype.onWebsocketClose=function(e,t){this.logger.info("connection closed {0}: {1}",e.code,e.reason);var n=this.connectionState===o.ConnectionState.Connecting;if(this.connectionState=o.ConnectionState.Disconnected,this.cleanupConnection(!1),this.trigger(o.SpeechConnectionEvents.connectionClosed,{connectionId:this.id,statusCode:e.code,message:e.reason}),n)return t(o.ConnectStatus.Error)},t.prototype.onWebsocketError=function(e,t){this.logger.error("connection error"),this.trigger(o.SpeechConnectionEvents.connectionError,{connectionId:this.id}),this.connectionState===o.ConnectionState.Connecting&&(this.connectionState=o.ConnectionState.Disconnected,this.cleanupConnection(!0),t(o.ConnectStatus.Error))},t.prototype.onWebsocketMessage=function(e){var t=this;if(this.connectionState===o.ConnectionState.Connected){var n;n=e.data instanceof Blob?new Promise(function(n,i){var r=new FileReader;r.onload=function(e){t.toSpeechMessage({messageType:o.MessageType.Binary,payload:r.result}).then(function(e){return n(e)})},r.onerror=function(e){i("error reading binary message")},r.readAsArrayBuffer(e.data)}):this.toSpeechMessage({messageType:o.MessageType.Text,payload:e.data}),this.receivingMessageQueue.enqueueFromPromise(n)}},t.prototype.canResumeConnection=function(){return!(!this.id||!this.receivingMessageQueue||this.receivingMessageQueue.isDisposed()||!this.sendMessageQueue||this.sendMessageQueue.isDisposed())},t.prototype.ensureWebsocketConnection=function(){return this.connectionState===o.ConnectionState.Disconnected&&this.canResumeConnection()?this.openConnection(!0).then(function(e){return e===o.ConnectStatus.Success}):this.connectionState!==o.ConnectionState.Connected?(this.logger.error("connection not available: {0}",this.canResumeConnection()),Promise.resolve(!1)):Promise.resolve(!0)},t.prototype.createWebsocketClient=function(e,t){var n=this;return new Promise(function(i,r){n.connectTimer=setTimeout(function(){n.logger.error("connect timeout"),n.websocketClient&&n.websocketClient.readyState===n.websocketClient.OPEN||(n.connectionState=o.ConnectionState.Disconnected,n.websocketClient&&n.websocketClient.close(),n.cleanupConnection(!0),i(o.ConnectStatus.Timeout))},n.connectTimeoutInMs);var s=n.getWebsocketUri(e);n.websocketClient=new WebSocket(s,t),n.processSendQueue(),n.websocketClient.onopen=function(e){return n.onWebsocketOpen(e,i)},n.websocketClient.onerror=function(e){return n.onWebsocketError(e,i)},n.websocketClient.onclose=function(e){return n.onWebsocketClose(e,i)},n.websocketClient.onmessage=function(e){return n.onWebsocketMessage(e)}})},t.prototype.sendRawMessage=function(e){if(!this.websocketClient)return this.logger.debug("connection closed, message not sent"),!1;try{return this.websocketClient.send(e.payload),!0}catch(e){throw Error(e.toString())}},t.prototype.processSendQueue=function(){var e=this,t=function(){return e.sendMessageQueue.dequeue().then(function(n){if(e.sendRawMessage(n))return t()})};t().then(function(){e.logger.info("ending send queue loop")}).catch(function(t){e.logger.info("ending send queue loop via dequeue error")})},t.prototype.clearConnectTimer=function(){this.connectTimer&&(clearTimeout(this.connectTimer),this.connectTimer=0)},t.prototype.cleanupConnection=function(e){this.clearConnectTimer(),this.websocketClient&&(this.websocketClient.onopen=null,this.websocketClient.onerror=null,this.websocketClient.onclose=null,this.websocketClient.onmessage=null,this.websocketClient=null);var t=this.receivingMessageQueue?this.receivingMessageQueue.length():0,n=this.sendMessageQueue?this.sendMessageQueue.length():0;(e||0===t&&0===n)&&(e=!0),e&&this.receivingMessageQueue&&(this.receivingMessageQueue.drainAndDispose(null),this.receivingMessageQueue=null),e&&this.sendMessageQueue&&(this.sendMessageQueue.drainAndDispose(null),this.sendMessageQueue=null),this.logger.info("cleanup connection with {0} unread messages {1} unsent messages. drain: {2}",t,n,e)},t.prototype.toWebsocketMessage=function(e){var t=this;return new Promise(function(n,i){try{if(e.messageType===o.MessageType.Text){c=t.makeHeaders(e)+t.newline+(e.textPayload||"");n({messageType:o.MessageType.Text,payload:c})}else if(e.messageType===o.MessageType.Binary){var r=t.makeHeaders(e),s=e.binaryPayload,a=r.length,c=new ArrayBuffer(2+a+(s?s.byteLength:0)),l=new DataView(c);l.setInt16(0,a);for(var u=0;u<a;u++)l.setInt8(u+2,r.charCodeAt(u));if(s){var d=new Int8Array(s);new Int8Array(c).set(d,2+a)}n({messageType:o.MessageType.Binary,payload:c})}}catch(e){i(e)}})},t.prototype.toSpeechMessage=function(e){var t=this;return new Promise(function(n,i){try{if(e.messageType===o.MessageType.Text){var r=e.payload||"",s=void 0,a=null;if(r){var l=r.split("\r\n\r\n");l&&l.length>0&&(s=t.parseHeaders(l[0]),a=l.length>1?l[1]:null)}n(new c.SpeechMessage(e.messageType,null,null,null,a,s))}else if(e.messageType===o.MessageType.Binary){var u=e.payload||null,s=void 0,a=null;if(!u||u.byteLength<2)throw new Error("invalid binary message format");var d=new DataView(u),p=d.getInt16(0);if(u.byteLength<p+2)throw new Error("invalid binary message format: header content missing");for(var h="",g=0;g<p;g++)h+=String.fromCharCode(d.getInt8(g+2));s=t.parseHeaders(h),u.byteLength>p+2&&(a=u.slice(2+p)),n(new c.SpeechMessage(e.messageType,null,null,null,a,s))}}catch(e){i(e)}})},t.prototype.makeHeaders=function(e){var t=this,n="";return e.headers&&e.headers.forEach(function(e,i){n+=i+": "+e+t.newline}),n},t.prototype.parseHeaders=function(e){var t=new Map;if(!e)return t;for(var n=0,i=e.match(/[^\r\n]+/g);n<i.length;n++){var o=i[n];if(o){var r=o.indexOf(":"),s=r>0?o.substr(0,r).trim().toLowerCase():o,a=r>0&&o.length>r+1?o.substr(r+1).trim():"";t.set(s,a)}}return t},t.prototype.getWebsocketUri=function(e){var t="";return e&&e.size>0&&e.forEach(function(e,n){t+=t?"&":"?",t+=n+"="+encodeURIComponent(e)}),this.speechServiceUrl+t},t}(a.EventSource);t.SpeechConnectionService=u},1626:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(49),o={path:"path",contentType:"content-type",requestId:"x-requestid",requestTimestamp:"x-timestamp"},r=function(){function e(e,t,n,i,r,s){var a=this;this.messageType=e,this.payload=r,this.headers=new Map,s&&s.forEach(function(e,t){a.headers.set(t,e)}),this.headers.set(o.path,t||this.headers.get(o.path)),this.headers.set(o.requestId,n||this.headers.get(o.requestId)),this.headers.set(o.contentType,i||this.headers.get(o.contentType)),this.headers.set(o.requestTimestamp,(new Date).toISOString())}return Object.defineProperty(e.prototype,"path",{get:function(){return this.headers.has(o.path)?this.headers.get(o.path):""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"requestId",{get:function(){return this.headers.has(o.requestId)?this.headers.get(o.requestId):""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"contentType",{get:function(){return this.headers.has(o.contentType)?this.headers.get(o.contentType):""},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"messageTimestamp",{get:function(){return this.headers.get(o.requestTimestamp)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textPayload",{get:function(){return this.messageType===i.MessageType.Binary?"":this.payload},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"binaryPayload",{get:function(){return this.messageType===i.MessageType.Text?null:this.payload},enumerable:!0,configurable:!0}),e}();t.SpeechMessage=r},1627:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,o=teamspace.services.TeamsCallState,r=teamspace.services.SfBState;!function(e){e.Running="running",e.Stopped="stopped"}(i||(i={}));var s=function(){function e(e,t,n,i,o,r,s,a,c,l){this.$rootScope=e,this.$state=t,this.$window=n,this.constants=i,this.electronSafeIpcService=o,this.platformDetectService=s,this.rigelCallHandler=a,this.rigelServiceHandler=c,this.settingsService=l,this.logger=r.newLogger("CortanaSdkService")}return e.$inject=["$rootScope","$state","$window","constants","electronSafeIpcService","loggingService","platformDetectService","rigelCallHandler","rigelServiceHandler","settingsService"],e.prototype.startCortanaSdk=function(){if(this.platformDetectService.isRigel()&&this.$window.desktopSettings&&this.$window.desktopSettings[this.constants.events.rigel.desktopSettings.enableRigelCortanaSdk]){this.logger.info("Starting CortanaSdk..."),this.initializeMainIpc();var e=this.settingsService.valueFor(this.constants.settings.names.cortanaConstants);this.electronSafeIpcService.send(this.constants.events.rigel.cortanaSdk.startCortana,e)}},e.prototype.stopCortanaSdk=function(){this.logger.info("Stopping CortanaSdk..."),this.electronSafeIpcService.send(this.constants.events.rigel.cortanaSdk.stopCortana),this.deinitializeMainIpc()},e.prototype.initializeMainIpc=function(){var e=this;this.logger.info("initializeMainIpc"),this.electronSafeIpcService.on(this.constants.events.rigel.cortanaSdk.keywordState,function(t,n){return e.onKeywordState(n[0])})},e.prototype.deinitializeMainIpc=function(){this.logger.info("deinitializeMainIpc"),this.electronSafeIpcService.removeAllListeners(this.constants.events.rigel.cortanaSdk.keywordState)},e.prototype.onKeywordState=function(e){if(e.state===i.Stopped){var t=this.rigelServiceHandler.sfbState,n=this.rigelCallHandler.getCurrentTeamsState();if(this.logger.info("Keyword state event received, teamsCallState = "+o[n]+", sfbState = "+r[t]),t!==r.Idle)return void this.logger.info("Ignoring keyword state event");this.$state.is(this.constants.states.rigelConsoleCortana)||n!==o.Idle?this.$rootScope.$broadcast(this.constants.events.rigel.cortana.showCortana,{isCancel:!1}):this.electronSafeIpcService.send(this.constants.events.rigel.service.callback,{type:this.constants.events.rigel.service.eventTypes.openRigelCortana,data:void 0})}},e}();t.CortanaSdkService=s,angular.module("teamspace.cortanaSdkService",["teamspace.constants","teamspace.electronSafeIpcService","teamspace.loggingService","teamspace.platformDetectService","teamspace.rigelCallHandler","teamspace.rigelServiceHandler"]).service("cortanaSdkService",s)},1628:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(199),r=n(198),s=n(6),a=teamspace.services.RecognitionState,c=teamspace.services.CortanaDevToolsStorageKeys,l={cortanaEvent:"cortanaEvent",privateEvent:"privateEvent",speechQuery:"speechQuery",submitAction:"submitAction",textQuery:"textQuery"},u=function(e){function t(t,n,i,o,r,s,c,l,u,d,p,h,g,v,S,f,m,C,y,A,k){var b=e.call(this)||this;b.$interval=t,b.$q=n,b.$rootScope=i,b.$timeout=o,b.appStateService=r,b.audioMediaDeviceService=s,b.constants=c,b.cortanaAuthService=l,b.cortanaClientContextService=u,b.cortanaClientSkillsConfigService=d,b.cortanaConfigurationService=p,b.cortanaJSFactory=h,b.cortanaSdkService=g,b.eventingService=S,b.loggingService=f,b.myUserPreferencesStore=m,b.settingsService=y,b.storageService=A,b.teamsActionService=k,b.recognitionState=a.Initializing,b.cortanaJS=null,b.logger=f.newLogger("CortanaService"),C.registerForMtma(b);var I=new teamspace.services.DataManagerOptions("cortanaBingAuth",function(e){return e.TraceId});return I.isTransient=!0,I.useTeamspaceTokens=!1,b.bingAuthDataManager=v.registerManager(I),b.initializeOnAppLaunchAndReinit("launch"),i.$on("$destroy",function(){b.tokenWarmUpStartPromise&&o.cancel(b.tokenWarmUpStartPromise),b.tokenWarmUpPromise&&t.cancel(b.tokenWarmUpPromise)}),b}return i(t,e),t.$inject=["$interval","$q","$rootScope","$timeout","appStateService","audioMediaDeviceService","constants","cortanaAuthService","cortanaClientContextService","cortanaClientSkillsConfigService","cortanaConfigurationService","cortanaJSFactory","cortanaSdkService","dataManagerService","eventingService","loggingService","myUserPreferencesStore","orchestrationService","settingsService","storageService","teamsActionService"],t.prototype.initializeOnAppLaunchAndReinit=function(e){var t=this;this.logger.info("initializeOnAppLaunchAndReinit: reason = {0}",e),this.cortanaConfigurationService.isCortanaEnabled().then(function(e){t.isCortanaEnabled=e,e&&(t.initializePromise=t.initializeCortana(),t.configurationUpdateSubscription=t.cortanaConfigurationService.safeSubscribe(t.$rootScope,function(){return t.onConfigurationUpdated()},teamspace.services.CortanaConfigurationServiceEvents.configurationUpdated))}).catch(function(e){t.logger.error("isCortanaEnabled() failed")})},t.prototype.cleanupOnAppTeardown=function(e){this.logger.info("cleanupOnAppTeardown: reason = {0}",e),this.configurationUpdateSubscription&&(this.cortanaConfigurationService.unsubscribe(this.configurationUpdateSubscription),this.configurationUpdateSubscription=void 0),this.deinitializeCortana(),this.initializePromise=null,this.recognitionState=a.Initializing,this.cortanaJS=null,this.isCortanaEnabled=!1,this.initializeId=null,this.cortanaJSConfig=null,this.stopRequestPromise=null,this.isPushingAuthToken=!1,this.releaseSettingsListener=null,this.releaseAppStateListener=null,this.currentWarmUpState=void 0,this.tokenWarmUpStartPromise=null,this.tokenWarmUpPromise=null,this.enableRHOverride=!1,this.enableAudioWorklet=!1,this.enableSpeechMode=!1,this.activeQuery=null},t.prototype.mtmaTelemetryIdentifier=function(){return"CortanaService"},t.prototype.startRecognizer=function(){return this.toNgPromise(this.queryCortanaInternal({queryType:l.speechQuery}))},t.prototype.queryCortana=function(e){return e?this.toNgPromise(this.queryCortanaInternal({queryType:l.textQuery,queryString:e})):(this.logger.error("invalid parameters for queryCortana"),this.$q.resolve(!1))},t.prototype.submitAction=function(e){var t=this;return e&&e.id?this.toNgPromise(this.ensureRequestReady().then(function(){return t.queryCortanaInternal({queryType:l.submitAction,actionData:e})})):(this.logger.error("invalid parameters for submitAction"),this.$q.resolve(!1))},t.prototype.triggerSkill=function(e,t,n){var i=this;return e&&t?this.toNgPromise(this.ensureRequestReady().then(function(){return i.queryCortanaInternal({queryType:l.privateEvent,privateEvent:{id:"",event:"",domain:e,intent:t,slots:n}})})):(this.logger.error("invalid parameters for triggerSkill"),this.$q.resolve(!1))},t.prototype.stopRecognizer=function(e){var t=this;if(!this.isCortanaEnabled||!this.cortanaJS)return this.$q.resolve(!1);if(this.stopRequestPromise)return this.logger.info("stopping request exists"),this.toNgPromise(this.stopRequestPromise);var n=this.recognitionState;this.logger.info("stopping request: {0} state: {1}",e,n),this.markRequestMarker(this.constants.scenarios.cortana.query.marks.stopRequested,{cortanaServiceState:n,isCancelIntent:e});var i=this.ensureRequestReady(e);return this.stopRequestPromise=(e?i.then(function(){switch(n){case a.Listening:return t.cortanaJS.cancel(r.CancelState.Listening);case a.Responding:return t.cortanaJS.cancel(r.CancelState.Responding)}return t.cortanaJS.cancel(r.CancelState.Other)}):i).then(function(){return t.stopRequestPromise=null}),this.toNgPromise(this.stopRequestPromise)},t.prototype.stopListening=function(e){this.isCortanaEnabled&&this.cortanaJS&&(e&&this.cortanaJS.ignoreListeningAction(),this.cortanaJS.stopListening())},t.prototype.isStoppingRequest=function(){return!!this.stopRequestPromise},t.prototype.queryCortanaInternal=function(e){var t=this;if(!this.isCortanaEnabled||!this.cortanaJS)return Promise.resolve(!1);if(this.isStoppingRequest())return this.logger.info("not starting query due to stop request"),this.loggingService.newScenario(this.constants.scenarios.cortana.notStart).stop({cortanaServiceState:this.recognitionState}),Promise.resolve(!1);if(!this.ensureRequestReadySync(!1))return this.logger.info("Cortana busy"),this.loggingService.newScenario(this.constants.scenarios.cortana.busy).stop({cortanaServiceState:this.recognitionState}),Promise.resolve(!1);this.pushCortanaConnectedToken(),this.cortanaJS.setAudioSource(this.audioMediaDeviceService.getAudioMediaDevice());var n=this.settingsService.valueAsBoolean(this.constants.settings.names.enableCortanaActionResponse),i=function(e){t.activeQuery.requestQueryData=e;var o=null,r=t.getClientContext();switch(e.queryType){case l.submitAction:o=t.cortanaJS.submitAction(e.actionData.id,e.actionData.inputs,r);break;case l.privateEvent:o=t.cortanaJS.triggerSkill(e.privateEvent.domain,e.privateEvent.intent,e.privateEvent.slots,e.privateEvent.id,r);break;case l.cortanaEvent:o=t.cortanaJS.sendCustomEvent(e.customEvent,r);break;default:o=t.cortanaJS.startRecognizer(e.queryString,r)}return o.then(function(e){return t.trackRequest(),t.activeQuery&&t.activeQuery.actionPromises&&0!==t.activeQuery.actionPromises.length?(t.isStoppingRequest()&&t.cancelActions(),t.updateRecognitionState(a.ExecutingAction),Promise.all(t.activeQuery.actionPromises.map(function(e){return e.actionPromise})).catch(function(e){return null})):Promise.resolve([])}).then(function(o){if(o&&!!o.find(function(e){return e&&e.status===s.TeamsCortanaActionStatus.SysCancel})||!t.activeQuery)return t.logger.info("resolved via SysCancel"),!1;var r=t.getQueryDataFromActionResults(o),a=o&&!!o.find(function(e){return e&&e.dismissOnAction})||e.dismissOnNoResponse&&!t.activeQuery.hasTextResponse;return n&&r&&!t.isStoppingRequest()?(t.activeQuery.actionPromises=null,t.markRequestMarker(t.constants.scenarios.cortana.query.marks.actionresponse,t.getQueryAgentInfo(r)),i(r)):(a&&(t.logger.info("dismiss Cortana canvas"),t.triggerEvent(teamspace.services.CortanaServiceEvents.dismiss,!0)),!0)})};return this.activeQuery=this.startNewQuery(e),this.activeQuery.requestPromise=i(e).then(function(e){return t.cleanupQuery(!1),e}).catch(function(e){return t.logger.error("queryCortanaInternal error: {0}",e&&e.message||e||""),t.activeQuery&&(t.activeQuery.requestEventData.lastTurnStatus=o.RecognitionCompletionStatus.UnknownError),t.cleanupQuery(!1),!1}),this.activeQuery.requestPromise},t.prototype.getQueryDataFromActionResults=function(e){var t=e&&e.find(function(e){return e&&!!e.actionResponseData&&(!!e.actionResponseData.domain&&!!e.actionResponseData.intent||!!e.actionResponseData.id&&!!e.actionResponseData.event)});if(!t)return null;var n=null;if(t.actionResponseData.id&&t.actionResponseData.event){var i={id:t.actionResponseData.id,event:t.actionResponseData.event};t.actionResponseData.slots&&_.forOwn(t.actionResponseData.slots,function(e,t){i[t]=e}),n={queryType:l.cortanaEvent,customEvent:i}}else n={queryType:l.privateEvent,privateEvent:{id:t.actionResponseData.id,event:"",domain:t.actionResponseData.domain,intent:t.actionResponseData.intent,slots:t.actionResponseData.slots}};return n.dismissOnNoResponse=!!e.find(function(e){return e&&e.dismissOnAction}),n},t.prototype.startTokenWarmUpTask=function(){var e=this,t=this.settingsService.valueFor(this.constants.settings.names.cortanaConstants);t.warmUpStartDelay?this.tokenWarmUpStartPromise=this.$timeout(function(){e.tokenWarmUpStartPromise=null,e.tokenWarmUpTask(),e.releaseAppStateListener=e.eventingService.$on(e.$rootScope,e.constants.events.appState.changed,function(t,n){n&&n.newState&&(!e.tokenWarmUpPromise||!e.appStateService.isConnected||e.currentWarmUpState===teamspace.services.ApplicationState.Interactive&&n.newState!==teamspace.services.ApplicationState.Interactive||e.currentWarmUpState!==teamspace.services.ApplicationState.Interactive&&n.newState===teamspace.services.ApplicationState.Interactive)&&e.tokenWarmUpTask()})},t.warmUpStartDelay):this.logger.info("disable warm up task")},t.prototype.stopTokenWarmUpTask=function(){this.tokenWarmUpStartPromise&&(this.$timeout.cancel(this.tokenWarmUpStartPromise),this.tokenWarmUpStartPromise=null),this.tokenWarmUpPromise&&(this.$interval.cancel(this.tokenWarmUpPromise),this.tokenWarmUpPromise=null)},t.prototype.tokenWarmUpTask=function(){var e=this,t=function(){e.cortanaAuthService.getToken().catch(function(){return e.logger.info("warm up failed")})},n=function(){e.cortanaJS&&e.cortanaJS.verifyConnection()};if(this.stopTokenWarmUpTask(),this.cortanaJS){var i=this.settingsService.valueFor(this.constants.settings.names.cortanaConstants),o=i.verifyConnectionInSeconds||1e3,r=i.warmUpIntervalInSeconds||1e3;this.currentWarmUpState=this.appStateService.current,this.currentWarmUpState===teamspace.services.ApplicationState.Interactive?this.tokenWarmUpPromise=this.$interval(function(){return n()},1e3*o):this.appStateService.isConnected&&(this.tokenWarmUpPromise=this.$interval(function(){return t()},1e3*r)),this.logger.info("warm up task enabled {0} in {1} state",!!this.tokenWarmUpPromise,this.currentWarmUpState)}else this.logger.info("tokenWarmUpTask CortanaJS not available")},t.prototype.pushCortanaConnectedToken=function(){var e=this,t=this.settingsService.valueFor(this.constants.settings.names.cortanaConstants);if(this.isPushingAuthToken||this.cortanaAuthService.getHeaderName().startsWith("X-")||this.cortanaJSConfig.enableSubProtocolAuth)return this.logger.info("skip pushing token"),Promise.resolve(!0);var n=this.storageService.get(this.constants.storageServiceKeys.cortanaConnectedExpiry);if(!!(n&&Date.now()<Number(n)))return Promise.resolve(!0);this.isPushingAuthToken=!0;var i=this.loggingService.newScenario(this.constants.scenarios.cortana.pdpAuthentication);return Promise.all([this.cortanaAuthService.getToken(),this.cortanaAuthService.getCortanaConnectedToken()]).then(function(n){var o={};o[e.constants.headers.accept]=e.constants.headers.jsonContent,o[e.constants.headers.tokens.authorization]=n[0];var r=new teamspace.services.DataManagerRequestOptions;r.additionalHeaders=o;var s={scrubbedUrl:t.bingAuthUrl,url:t.bingAuthUrl.replace("{providerId}",t.bingAuthProviderId).replace("{assertionToken}",n[1]),method:"GET"};return e.bingAuthDataManager.invoke(s,r).then(function(n){n&&!n.IsError&&e.storageService.set(e.constants.storageServiceKeys.cortanaConnectedExpiry,Date.now()+(t.connectedTokenRefreshDays||7)*e.constants.timeInMiliseconds.day);var o=!n||n.IsError,r=o&&n?n.TraceId:null;i.stop({isError:o,traceId:r})}).catch(function(t){var n=t&&t.status||0,o=t&&t.response&&t.Message||"";e.logger.error("bingAuthDataManager failed with {0}",n),i.fail({failedSource:"invoke",isError:!0,responseStatus:n,responseMsg:o})}).finally(function(){e.isPushingAuthToken=!1}),!0}).catch(function(t){return e.logger.error("failed to push Cortana connected service token"),e.isPushingAuthToken=!1,i.fail({failedSource:"others",isError:!0}),!1})},t.prototype.cancelActions=function(){var e=this,t=!1;return this.activeQuery&&this.activeQuery.actionPromises&&this.activeQuery.actionPromises.length?(this.logger.info("cancel waiting for active actions"),this.activeQuery.actionPromises.forEach(function(n){if(n){var i=e.teamsActionService.cancelActionPromise(n.actionExecutionId);i&&(e.logger.error("stale actions detected: {0}",n.actionId),e.markRequestMarker(e.constants.scenarios.cortana.query.marks.action,{actionId:n.actionId,actionStatus:s.TeamsCortanaActionStatus.SysCancel})),t=t||i}}),t):t},t.prototype.ensureRequestReadySync=function(e){return!(this.activeQuery&&this.activeQuery.requestPromise)&&this.recognitionState===a.Idle||(this.cortanaJS.isIdle()&&this.recognitionState===a.ExecutingAction?(this.cancelActions(),this.cleanupQuery(!1),!0):!!e&&(this.cortanaJS.stopRecognizer(),this.cortanaJS.resetConnection(),this.cleanupQuery(!1),!0))},t.prototype.ensureRequestReady=function(e){return this.cortanaJS.stopRecognizer(),(e||this.recognitionState===a.ExecutingAction)&&this.cancelActions(),this.activeQuery&&this.activeQuery.requestPromise?this.activeQuery.requestPromise:Promise.resolve(!0)},t.prototype.cleanupQuery=function(e){if(this.activeQuery){if(this.activeQuery.requestMarker){var t=this.activeQuery.requestMarker,n=this.activeQuery.requestEventData;n.cortanaTokenExpiresAt=this.cortanaAuthService.getTokenExpiry(),this.activeQuery.requestAudioMetrics&&this.activeQuery.requestAudioMetrics.length>0&&(n.cortanaAudioMetrics=JSON.stringify(this.activeQuery.requestAudioMetrics)),this.activeQuery.requestCounters&&(n.recognitionCounters=JSON.stringify(this.activeQuery.requestCounters)),e?(this.logger.error("previous requestMarker detected"),t.fail(n)):n.lastTurnStatus!==o.RecognitionCompletionStatus.Success&&n.lastTurnStatus!==o.RecognitionCompletionStatus.Canceled&&n.lastTurnStatus!==o.RecognitionCompletionStatus.AudioSourceError?t.fail(n):t.stop(n),this.activeQuery.requestMarker=null}this.activeQuery.requestEventData=null,this.activeQuery.requestAudioMetrics=null,this.activeQuery.requestCounters=null,this.activeQuery.currentSessionId="",this.activeQuery.hasTextResponse=!1,this.activeQuery.requestPromise=null,this.activeQuery.actionPromises=null,this.updateRecognitionState(a.Idle),this.activeQuery=null}},t.prototype.startNewQuery=function(e){return this.cleanupQuery(!0),this.activeQuery={requestMarker:this.loggingService.newScenario(this.constants.scenarios.cortana.query.scenarioName),requestQueryData:e,requestEventData:{queryType:e.queryType,querySessionId:"",cortanaServiceTag:"",speechConnectionId:"",maxResponseTime:-1,startLatency:-1,isCompliant:!!this.cortanaJSConfig.enableSubProtocolAuth},currentSessionId:"",requestAudioMetrics:[],requestCounters:{}},this.activeQuery},t.prototype.markRequestMarker=function(e,t){this.activeQuery&&this.activeQuery.requestMarker&&(t=t||{},this.activeQuery.requestMarker.mark(e,Object.assign(t,this.activeQuery.requestEventData)))},t.prototype.getQueryAgentInfo=function(e){var t="",n="";switch(e.queryType){case l.submitAction:t=e.actionData.id;break;case l.privateEvent:t=e.privateEvent.id,n=e.privateEvent.domain.concat("-",e.privateEvent.intent);break;case l.cortanaEvent:t=e.customEvent.id,n=e.customEvent.event}return{agentId:t,agentEvent:n}},t.prototype.trackRequest=function(){var e=this.activeQuery&&this.activeQuery.requestEventData&&this.activeQuery.requestEventData.cortanaServiceTag;e&&(this.enableRHOverride&&(e="local:".concat(e)),this.storageService.set(c.lastTraceId,e.toLowerCase()))},t.prototype.toNgPromise=function(e){return this.$q(function(t,n){e.then(function(e){return t(e)}).catch(function(e){return n(e)})})},t.prototype.getClientContext=function(){var e=this.cortanaClientContextService.getClientContext();return e.clientTag=this.loggingService.sessionId,e},t.prototype.getCortanaResult=function(e){var t=e&&e.view||null,n=t&&t.displayText||"",i=null,o=e&&e.adaptiveResponses,r=o&&o.length>0;return!r&&t&&t.card&&(i=t.card.botFramework),{serviceTag:e&&e.context&&e.context.serviceTag,displayText:n,botFramework:i,adaptiveResponses:r?o:null}},t.prototype.initializeCortana=function(){var e=this;if(!this.isCortanaEnabled)return this.logger.error("something went wrong!"),Promise.resolve(!1);if(this.initializeId)return this.logger.error("initializeCortana called again without deinitialize"),Promise.resolve(!1);this.logger.log("using Teams Cortana SDK");var t=this.loggingService.newScenario(this.constants.scenarios.cortana.init);return this.initializeId=t.id,Promise.all([this.cortanaClientSkillsConfigService.initialize(),this.cortanaClientContextService.initialize()]).then(function(n){return _.every(n,function(e){return e})?e.initializeId===t.id&&e.initializePromise?(e.updateCortanaSettings(),e.releaseSettingsListener=e.eventingService.$on(e.$rootScope,e.constants.events.cortana.settingsUpdated,function(){return e.updateCortanaSettings()}),e.cortanaJS=e.cortanaJSFactory(e.loggingService,e.cortanaJSConfig,e.cortanaAuthService),e.cortanaJS.subscribe(function(t,n){return e.onRecognitionStarted(n)},r.CortanaJSEvents.recognitionStarted),e.cortanaJS.subscribe(function(t,n){return e.updateRecognitionState(a.Listening)},r.CortanaJSEvents.listeningStarted),e.cortanaJS.subscribe(function(t,n){return e.updateRecognitionState(a.Thinking)},r.CortanaJSEvents.speechEndDetected),e.cortanaJS.subscribe(function(t,n){return e.onSpeechHypothesis(n)},r.CortanaJSEvents.speechHypothesis),e.cortanaJS.subscribe(function(t,n){return e.onSpeechPhrase(n)},r.CortanaJSEvents.speechPhrase),e.cortanaJS.subscribe(function(t,n){return e.onRecognitionEnded(n)},r.CortanaJSEvents.recognitionEnded),e.cortanaJS.subscribe(function(t,n){return e.onCortanaResponse(n)},r.CortanaJSEvents.cortanaResponded),e.cortanaJS.subscribe(function(t,n){return e.onClientSkillInvoked(n)},r.CortanaJSEvents.clientSkillInvoked),e.updateTeamsActionsSettings(),t.stop({isUsingNative:!1,audioWorkletEnabled:e.enableAudioWorklet}),e.updateRecognitionState(a.Idle),e.startTokenWarmUpTask(),e.cortanaSdkService.startCortanaSdk(),!0):(t.fail({failedSource:"canceled"}),e.logger.error("initialization canceled"),!1):(t.fail({failedSource:"dependent"}),e.logger.error("failed to initialize config provider or context service"),!1)}).catch(function(n){return t.fail({failedSource:"exception"}),e.logger.error("failed to initialize Cortana"),!1})},t.prototype.deinitializeCortana=function(){this.logger.info("deinitializeCortana"),this.initializeId=null,this.recognitionState=a.Initializing,this.isPushingAuthToken=!1,this.releaseSettingsListener&&(this.releaseSettingsListener(),this.releaseSettingsListener=null),this.releaseAppStateListener&&(this.releaseAppStateListener(),this.releaseAppStateListener=null),this.stopTokenWarmUpTask(),this.cancelActions(),this.cleanupQuery(!1),this.cortanaJS&&(this.cortanaJS.stopRecognizer(),this.cortanaJS.resetConnection(),this.cortanaJS.clearSubscriptions(),this.cortanaJS=null),this.cortanaSdkService.stopCortanaSdk(),this.cortanaClientSkillsConfigService.deinitialize(),this.cortanaClientContextService.deinitialize()},t.prototype.onConfigurationUpdated=function(){var e=this;this.logger.info("onConfigurationUpdated"),this.cortanaConfigurationService.isCortanaEnabled().then(function(t){if(t&&e.isCortanaEnabled===t)return e.updateTeamsActionsSettings(),void e.updateCortanaSettings();e.isCortanaEnabled=t,t?e.initializePromise=e.initializeCortana():e.deinitializeCortana()}).catch(function(t){e.logger.error("onConfigurationUpdated: failed to get configuration")})},t.prototype.updateTeamsActionsSettings=function(){var e=this,t=new Set,n=this.settingsService.valueFor(this.constants.settings.names.cortanaConstants);n&&n.disabledActions&&n.disabledActions.forEach(function(e){return t.add(e)}),this.teamsActionService.getRegisteredActions().forEach(function(n){e.teamsActionService.enableAction(n,!t.has(n))})},t.prototype.updateCortanaSettings=function(){if(this.isCortanaEnabled){var e=this.myUserPreferencesStore.getUserPreferences().locale;this.logger.info("user locale {0}, force locale to {1}",e,t.forceLocale);var n=this.settingsService.valueAsBoolean(this.constants.settings.names.enableCompliantCortana),i=this.settingsService.valueFor(this.constants.settings.names.cortanaConstants),o=this.getSettingsAsBoolean(this.constants.storageServiceKeys.cortanaUseLocation),r=this.getSettingsAsBoolean(c.useClassicCard),s=this.getSettingsAsBoolean(c.disableFollowUpListening);this.enableRHOverride=this.getSettingsAsBoolean(c.enableRHOverride),this.enableAudioWorklet=this.getSettingsAsBoolean(c.enableAW2),this.enableSpeechMode=this.getSettingsAsBoolean(c.enableSM),this.audioMediaDeviceService.setAudioProperties(this.enableAudioWorklet,this.enableSpeechMode),this.cortanaJSConfig={speechServiceUrl:n?i.serviceUrlCpt:i.serviceUrl,speechLocale:t.forceLocale,speechEnvironment:i.environment,isLocationEnabled:o,isAdaptiveCardEnabled:!r,isFollowUpDisabled:s,isUsingAudioStream:this.getSettingsAsBoolean(c.useAudioStream),configProviders:this.cortanaClientSkillsConfigService.getConfigProviders(),enableSubProtocolAuth:n},this.cortanaClientContextService.onCortanaConfigUpdated(this.cortanaJSConfig),this.cortanaJS&&(this.cortanaJS.updateConfiguration(this.cortanaJSConfig),this.cortanaJS.resetConnection())}},t.prototype.triggerEvent=function(e,t,n){var i=this,o={data:n};t?this.$rootScope.$applyAsync(function(){i.trigger(e,SkypeX.Services.ObservableBase.Key_All,o)}):this.trigger(e,SkypeX.Services.ObservableBase.Key_All,o)},t.prototype.onSpeechHypothesis=function(e){if(this.activeQuery){var t=e.data;t&&t.Text&&this.triggerEvent(teamspace.services.CortanaServiceEvents.intermediateResult,!0,t.Text)}},t.prototype.onSpeechPhrase=function(e){if(this.activeQuery){var t=e.data;if(t){if(this.logger.info("speech recognition result: {0}",t.RecognitionStatus),t.RecognitionStatus!==o.RecognitionStatus.Success)return void this.triggerEvent(teamspace.services.CortanaServiceEvents.recognizedPhrase,!0,"");var n=t.DisplayText;if(!n){var i=e.data;i.NBest&&i.NBest.length>0&&(n=i.NBest[0].Display)}this.triggerEvent(teamspace.services.CortanaServiceEvents.recognizedPhrase,!0,n)}}},t.prototype.onRecognitionStarted=function(e){if(this.activeQuery){var t=this.activeQuery.currentSessionId===e.cortanaJSSessionId;this.activeQuery.currentSessionId=e.cortanaJSSessionId,this.activeQuery.requestEventData.querySessionId||(this.activeQuery.requestEventData.querySessionId=e.cortanaJSSessionId),this.activeQuery.requestEventData.cortanaServiceTag=e.serviceTag,this.activeQuery.requestEventData.speechConnectionId=e.connectionId,this.activeQuery.requestEventData.startLatency<0&&(this.activeQuery.requestEventData.startLatency=e.elapsedTime),t||this.markRequestMarker(this.constants.scenarios.cortana.query.marks.started,this.getQueryAgentInfo(this.activeQuery.requestQueryData))}},t.prototype.onRecognitionEnded=function(e){if(this.activeQuery){var t=e.data;if(t){if(this.activeQuery.requestAudioMetrics&&t.audioResponsePayloadSize&&(this.activeQuery.requestAudioMetrics=this.activeQuery.requestAudioMetrics.concat({elapsedTime:t.audioResponseElapsedTime,payloadSize:t.audioResponsePayloadSize})),t.counters)for(var n in t.counters)this.activeQuery.requestCounters[n]=(this.activeQuery.requestCounters[n]||0)+t.counters[n];this.activeQuery.requestEventData&&(this.activeQuery.requestEventData.speechConnectionId=e.connectionId,this.activeQuery.requestEventData.lastTurnStatus=t.status);var i={status:teamspace.services.TurnEndedStatus.Success};t.status!==o.RecognitionCompletionStatus.Success&&(this.appStateService.isConnected?t.status===o.RecognitionCompletionStatus.ConnectError||t.status===o.RecognitionCompletionStatus.ConnectTimeout?i.status=teamspace.services.TurnEndedStatus.ConnectError:t.status===o.RecognitionCompletionStatus.AudioSourceError?i.status=teamspace.services.TurnEndedStatus.AudioSourceError:i.status=teamspace.services.TurnEndedStatus.Error:i.status=teamspace.services.TurnEndedStatus.AppOffline,this.logger.warn("recognition ended with status {0}",t.status),this.markRequestMarker(this.constants.scenarios.cortana.query.marks.recognitionError)),e.isRequestCanceled?this.logger.info("request canceled, not sending event"):this.triggerEvent(teamspace.services.CortanaServiceEvents.turnEnded,!0,i)}}},t.prototype.onCortanaResponse=function(e){if(this.activeQuery){this.updateRecognitionState(a.Responding);var t=e.data,n=this.getCortanaResult(t);this.activeQuery.hasTextResponse=!!n&&!!n.displayText,this.activeQuery.requestEventData.maxResponseTime=Math.max(this.activeQuery.requestEventData.maxResponseTime,e.elapsedTime),this.markRequestMarker(this.constants.scenarios.cortana.query.marks.responding,{cortanaResponseTime:e.elapsedTime,isSilentResponse:!this.activeQuery.hasTextResponse}),n&&(n.serviceTag&&this.logger.info("Cortana responded: {0}",n.serviceTag),this.triggerEvent(teamspace.services.CortanaServiceEvents.response,!0,n))}},t.prototype.updateRecognitionState=function(e){this.recognitionState!==e&&(this.logger.info("changing state from {0} to {1}",this.recognitionState,e),this.recognitionState=e,this.triggerEvent(teamspace.services.CortanaServiceEvents.stateChanged,!0,this.recognitionState))},t.prototype.onClientSkillInvoked=function(e){var t=this;if(this.activeQuery&&e&&e.data){var n=e.data.id,i=e.data.action;this.markRequestMarker(this.constants.scenarios.cortana.query.marks.clientskill,{skillId:n,skillAction:i});var o=this.teamsActionService.handleClientSkill(e.data,e.skillResponseData);o&&(o.actionPromise.then(function(e){return e&&e.actionId&&e.status!==s.TeamsCortanaActionStatus.SysCancel&&(t.logger.info("client skill handled status: {0} Teams actionId: {1} actionInfo: {2}",e.status,e.actionId,e.actionInfo),t.markRequestMarker(t.constants.scenarios.cortana.query.marks.action,{actionId:e.actionId,actionInfo:e.actionInfo,actionStatus:e.status,actionDismissOnAction:!!e.dismissOnAction,skillId:n,skillAction:i})),e}).catch(function(e){t.logger.error("action failed: {0}",o.actionId),t.markRequestMarker(t.constants.scenarios.cortana.query.marks.action,{actionId:o.actionId,actionStatus:s.TeamsCortanaActionStatus.Error,actionError:e,skillId:n,skillAction:i})}),this.activeQuery.actionPromises?this.activeQuery.actionPromises=this.activeQuery.actionPromises.concat(o):this.activeQuery.actionPromises=[o])}},t.prototype.getSettingsAsBoolean=function(e,t){var n=this.storageService.get(e);return void 0===t||void 0!==n&&null!==n?"true"===n:(this.storageService.set(e,t),t)},t.forceLocale="en-us",t}(SkypeX.Services.ObservableBase);t.CortanaService=u,angular.module("teamspace.cortanaJSService",["skypeX.myUserPreferencesStore","teamspace.appState","teamspace.audioMediaDeviceService","teamspace.constants","teamspace.cortanaAuthService","teamspace.cortanaClientContextService","teamspace.cortanaClientSkillsConfigService","teamspace.cortanaConfigurationService","teamspace.cortanaJSFactory","teamspace.cortanaSdkService","teamspace.dataManagerService","teamspace.eventingService","teamspace.loggingService","teamspace.orchestrationService","teamspace.settingsService","teamspace.storageService","teamspace.teamsActionService"]).service("cortanaJSService",u)},1629:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1),o=n(6),r=function(){function e(e,t,n,o,r,s,a,c,l,u,d,p,h,g){this.constants=t,this.loggingService=r,this.utilityService=g,this.logger=r.newLogger("TeamsActionService"),this.teamsActionHandlers=new Map,this.teamsActionAdapters=new Map,this.activeActions=new Map,this.registerActionHandler(e),this.registerActionHandler(n),this.registerActionHandler(o),this.registerActionHandler(s),this.registerActionHandler(a),this.registerActionHandler(c),this.registerActionHandler(l),this.registerActionHandler(u),this.registerActionHandler(d),this.registerActionHandler(p),this.registerActionHandler(h),this.teamsActionAdapters.set(this.getTeamsActionAdapterKey(i.ClientSkillsId.communication),this.communicationClientSkillAdapter.bind(this)),this.teamsActionAdapters.set(this.getTeamsActionAdapterKey(i.ClientSkillsId.meeting),this.meetingActionClientSkillAdapter.bind(this)),this.teamsActionAdapters.set(this.getTeamsActionAdapterKey(i.ClientSkillsId.communication,i.ClientSkillsActions.sendMessage),this.sendMessageClientSkillAdapter.bind(this)),this.teamsActionAdapters.set(this.getTeamsActionAdapterKey(i.ClientSkillsId.teams,i.ClientSkillsActions.teamsResponse),this.teamsResponseClientSkillAdapter.bind(this)),this.teamsActionAdapters.set(this.getTeamsActionAdapterKey(i.ClientSkillsId.teams),this.teamsActionClientSkillAdapter.bind(this)),this.teamsActionAdapters.set(this.getTeamsActionAdapterKey(i.ClientSkillsId.skype,i.ClientSkillsActions.meeting.joinMeeting),this.skypeActionClientSkillAdapter.bind(this))}return e.$inject=["callingActionHandler","constants","downloadFilesActionHandler","fileActionHandler","loggingService","meetingActionHandler","navigationActionHandler","presentActionHandler","teamsMiscActionHandler","sendMessageActionHandler","setStatusActionHandler","takeNoteActionHandler","teamChannelActionHandler","utilityService"],e.prototype.registerActionHandler=function(e){this.teamsActionHandlers.has(e.actionId)?this.logger.warn("duplicate registration of teams action handler {0}",e.actionId):this.teamsActionHandlers.set(e.actionId,{handler:e,isActive:!0})},e.prototype.enableAction=function(e,t){void 0===t&&(t=!0);var n=this.getActionHandler(e);n&&(n.isActive=t)},e.prototype.getRegisteredActions=function(){var e=[];return this.teamsActionHandlers.forEach(function(t,n){e=e.concat(n)}),e},e.prototype.cancelActionPromise=function(e){var t=this.activeActions.get(e);if(!t)return!1;var n=!0;return t.actionState===o.ActionThreadState.Waiting&&(n=!1,this.logger.info("canceling action: {0}",t.actionId)),t.isCanceled=!0,this.resolveAction(t,this.getActionResult(o.TeamsCortanaActionStatus.SysCancel,t.actionId)),n},e.prototype.invokeAction=function(e,t,n){var i=this;if(t||(t=this.loggingService.newScenario(this.constants.scenarios.cortana.action.actionScenarioName),n={}),!e)return this.logger.info("null action"),t.fail(n),null;n.actionId=e.actionId;var r=this.createActionThread(e.actionId,t,n),s=this.getActionHandler(e.actionId);if(!s||!s.isActive)return this.logger.info("action handler inactive or not found: {0}",e.actionId),this.resolveAction(r,this.getActionResult(o.TeamsCortanaActionStatus.Inactive,e.actionId)),r;e.actionDelay=0;var a=e.actionDelay?new Promise(function(t){return setTimeout(t,1e3*e.actionDelay)}):Promise.resolve();return r.actionState=o.ActionThreadState.Waiting,a.then(function(){if(r.isCanceled)i.logger.info("action canceled: {0} [{1}]",r.actionId,r.actionState);else{i.logger.info("invoking action: {0}",e.actionId),t.mark(i.constants.scenarios.cortana.action.marks.invokingAction,Object.assign({},n)),r.actionState=o.ActionThreadState.Running;try{s.handler.handleAction(e).then(function(e){i.resolveAction(r,e)}).catch(function(t){i.resolveAction(r,i.getActionResult(o.TeamsCortanaActionStatus.Error,e.actionId),t)})}catch(t){i.logger.error("handleAction exception"),i.resolveAction(r,i.getActionResult(o.TeamsCortanaActionStatus.Error,e.actionId))}}}).catch(function(){i.logger.error("delay exception"),i.resolveAction(r,i.getActionResult(o.TeamsCortanaActionStatus.Error,e.actionId))}),r},e.prototype.handleClientSkill=function(e,t){if(!e||!e.id)return null;var n=this.loggingService.newScenario(this.constants.scenarios.cortana.action.skillScenarioName),i={skillId:e.id,skillAction:e.action},o=this.getTeamsActionAdapterKey(e.id,e.action);this.teamsActionAdapters.has(o)||(o=this.getTeamsActionAdapterKey(e.id));var r=this.teamsActionAdapters.get(o),s=r&&r(e,t);return i.actionId=s&&s.actionId,this.invokeAction(s,n,i)},e.prototype.createActionThread=function(e,t,n){var i={actionId:e,actionState:o.ActionThreadState.None,actionExecutionId:this.utilityService.generateUUIDNormalized(),actionScenario:t,actionScenarioData:n||{},actionPromise:null,actionResolve:null,actionReject:null};return i.actionPromise=new Promise(function(e,t){i.actionResolve=e,i.actionReject=t}),this.activeActions.set(i.actionExecutionId,i),i},e.prototype.resolveAction=function(e,t,n){e&&(t&&(t.actionInfo=this.scrubActionInfo(t.actionInfo),e.actionScenarioData.actionInfo=t.actionInfo,e.actionScenarioData.actionStatus=t.status),n?(e.actionScenarioData.actionError=n,e.actionScenario.fail(e.actionScenarioData),e.actionReject(n)):(e.actionScenario.stop(e.actionScenarioData),e.actionResolve(t)),e.actionScenarioData=null,e.actionState=o.ActionThreadState.Completed,this.activeActions.delete(e.actionExecutionId))},e.prototype.scrubActionInfo=function(e){if(!e)return"";var t="";try{JSON.parse(e)}catch(n){t=e}return t},e.prototype.getActionHandler=function(e){return e&&this.teamsActionHandlers.has(e)?this.teamsActionHandlers.get(e):null},e.prototype.getActionResult=function(e,t){return{status:e,actionId:t||"<service>"}},e.prototype.getTeamsActionAdapterKey=function(e,t){return t?e+"::"+t:e},e.prototype.teamsResponseClientSkillAdapter=function(e,t){var n=e;if(!n.response)return this.logger.error("empty response"),null;try{var i=JSON.parse(n.response);if(!i.action||!i.action.actionId||"string"!=typeof i.action.actionId)return this.logger.error("invalid Teams action payload"),null;if(i.action.actionId===o.TeamsActionsId.search){var r=i.action;r.actionId=o.TeamsActionsId.teamsMiscAction,r.type=o.TeamsMiscActionType.Search}return i.action}catch(e){this.logger.error("failed to parse action payload")}return null},e.prototype.teamsActionClientSkillAdapter=function(e,t){if(!e.action)return this.logger.error("unknown action"),null;var n=null;switch(e.action){case i.ClientSkillsActions.setStatus:var r=e;n={actionId:o.TeamsActionsId.setStatus,userStatus:r.userStatus};break;case i.ClientSkillsActions.dismissCortana:n={actionId:o.TeamsActionsId.teamsMiscAction,type:o.TeamsMiscActionType.Dismiss};break;default:this.logger.error("invalid Teams action")}return n},e.prototype.skypeActionClientSkillAdapter=function(e,t){var n=e;switch(n.action){case i.ClientSkillsActions.meeting.joinMeeting:return{actionId:o.TeamsActionsId.meetingAction,type:n.action,skypeTeamsMeetingUrl:n.skypeTeamsMeetingUrl,conversationId:n.skypeTeamsProperties?this.parseCid(n.skypeTeamsProperties):null}}},e.prototype.parseCid=function(e){return JSON.parse(e).cid},e.prototype.meetingActionClientSkillAdapter=function(e,t){var n=e;switch(n.action){case i.ClientSkillsActions.meeting.present:case i.ClientSkillsActions.meeting.stopSharingDeck:case i.ClientSkillsActions.meeting.navigateDeck:return"next"===n.navigationType?n.action=i.ClientSkillsActions.meeting.nextSlide:"previous"===n.navigationType?n.action=i.ClientSkillsActions.meeting.previousSlide:"slideNumber"===n.navigationType&&(n.action=i.ClientSkillsActions.meeting.goToSlide),{actionId:o.TeamsActionsId.present,type:n.action,conversationId:n.meetingId?n.meetingId.conversationId:null,deckName:n.deckName,deckUrl:n.deckUrl,fileType:n.fileType,slideIndex:n.slideNumber,callId:n.callId,attachmentInfo:n.attachmentInfo?{eventId:n.attachmentInfo.eventId,attachmentId:n.attachmentInfo.attachmentId,type:n.attachmentInfo["@odata.type"]}:null};case i.ClientSkillsActions.meeting.takeNote:return{actionId:o.TeamsActionsId.takeNote,noteBody:n.noteBody}}},e.prototype.communicationClientSkillAdapter=function(e,t){var n,r,s,a;switch(e.action){case i.ClientSkillsActions.addToCall:case i.ClientSkillsActions.makeCall:var c=e;if(!_.isEmpty(c.addresses)){var l=_.first(c.addresses);n=l.type.toUpperCase()===i.CommAddressTypes.upn?l.value:"",r=l.type.toUpperCase()===i.CommAddressTypes.number?l.value:"",a=l.type.toUpperCase()===i.CommAddressTypes.mri?l.value:""}break;case i.ClientSkillsActions.transferCall:var u=e;n=u.address&&u.address.type.toUpperCase()===i.CommAddressTypes.upn&&u.address.value,r=u.address&&u.address.type.toUpperCase()===i.CommAddressTypes.number&&u.address.value,a=u.address&&u.address.type.toUpperCase()===i.CommAddressTypes.mri&&u.address.value;break;case i.ClientSkillsActions.endCall:case i.ClientSkillsActions.resumeCall:case i.ClientSkillsActions.holdCall:s=e.callId}return{actionId:o.TeamsActionsId.callingAction,type:e.action,contacts:[{upn:n,number:r,mri:a}],callId:s}},e.prototype.sendMessageClientSkillAdapter=function(e,t){var n=e,r=_.groupBy(n.addresses,function(e){return e.type.toUpperCase()}),s=_.map(r[i.CommAddressTypes.mri],function(e){return e.value}),a=_.map(r[i.CommAddressTypes.upn],function(e){return e.value}),c=_.map(r[i.CommAddressTypes.conversationId],function(e){return e.value}),l=c.length?c[0]:null;return{actionId:o.TeamsActionsId.sendMessageAction,conversationId:l,mris:s,userPrincipalNames:a,message:n.message,eventInfo:{id:i.ClientSkillsId.communication,event:"sendMessageActionResult"}}},e}();t.TeamsActionService=r,angular.module("teamspace.teamsActionService",["teamspace.callingActionHandler","teamspace.constants","teamspace.downloadFilesActionHandler","teamspace.fileActionHandler","teamspace.loggingService","teamspace.meetingActionHandler","teamspace.navigationActionHandler","teamspace.presentActionHandler","teamspace.teamsMiscActionHandler","teamspace.sendMessageActionHandler","teamspace.setStatusActionHandler","teamspace.teamChannelActionHandler","teamspace.takeNoteActionHandler","teamspace.utilityService"]).service("teamsActionService",r)},193:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(31),o=n(194),r=function(){function e(e,t,n){this.isClosed=!1,this.readerQueue=t,this.onClose=n,this.streamId=e}return e.prototype.read=function(){var e=this;return this.isClosed?Promise.reject("StreamReader closed"):this.readerQueue.dequeue().then(function(t){return t.isEnd&&e.readerQueue.dispose("End of stream reached"),t})},e.prototype.close=function(){this.isClosed||(this.isClosed=!0,this.readerQueue.dispose("StreamReader closed"),this.onClose())},e}();t.StreamReader=r;var s=function(){function e(e){this.readerIdCounter=1,this.isEnded=!1,this.id=e||i.CortanaUtilities.createNoDashGuid(),this.streambuffer=[],this.readerQueues=new Map}return Object.defineProperty(e.prototype,"isClosed",{get:function(){return this.isEnded},enumerable:!0,configurable:!0}),e.prototype.write=function(e){this.throwIfClosed(),this.writeStreamChunk({buffer:e,isEnd:!1})},e.prototype.getReader=function(){var e=this,t=this.readerIdCounter++,n=new o.Queue;return this.readerQueues.set(t,n),this.streambuffer.forEach(function(e){n.enqueue(e)}),new r(this.id,n,function(){e.readerQueues.delete(t)})},e.prototype.close=function(){this.isEnded||(this.writeStreamChunk({buffer:null,isEnd:!0}),this.isEnded=!0)},e.prototype.writeStreamChunk=function(e){this.throwIfClosed(),this.streambuffer.push(e),this.readerQueues.forEach(function(t){if(!t.isDisposed())try{t.enqueue(e)}catch(e){}})},e.prototype.throwIfClosed=function(){if(this.isEnded)throw new Error("stream closed")},e}();t.Stream=s},194:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i;!function(e){e[e.Dequeue=0]="Dequeue",e[e.Peek=1]="Peek"}(i||(i={}));var o=function(){function e(e){var t=this;this.isDrainInProgress=!1,this.isDisposing=!1,this.disposeReason=null,this.list=[],this.readers=[],e&&e.forEach(function(e){t.list=t.list.concat(Promise.resolve(e))})}return e.prototype.enqueue=function(e){this.throwIfDispose(),this.enqueueFromPromise(Promise.resolve(e))},e.prototype.enqueueFromPromise=function(e){this.throwIfDispose(),this.list=this.list.concat(e),this.drain()},e.prototype.dequeue=function(){return this.addReaderRequest(i.Dequeue)},e.prototype.peek=function(){return this.addReaderRequest(i.Peek)},e.prototype.length=function(){return this.throwIfDispose(),this.list.length},e.prototype.isDisposed=function(){return!this.readers},e.prototype.drainAndDispose=function(e,t){var n=this;return this.isDisposed()||this.isDisposing?Promise.resolve(!0):(this.disposeReason=t,this.isDisposing=!0,this.readers.forEach(function(e){e.reject("disposed")}),this.readers=null,Promise.all(this.list).then(function(t){return e&&t.forEach(function(t){e(t)}),n.list=null,!0}))},e.prototype.dispose=function(e){this.drainAndDispose(null,e)},e.prototype.addReaderRequest=function(e){var t=this;return this.throwIfDispose(),new Promise(function(n,i){t.readers=t.readers.concat({type:e,resolve:n,reject:i}),t.drain()})},e.prototype.drain=function(){if(!this.isDrainInProgress&&!this.isDisposing){this.isDrainInProgress=!0;for(var e=this;this.list.length>0&&this.readers.length>0&&!this.isDisposing;)!function(){var t=e.readers.splice(0,1)[0];t.type===i.Peek?e.list[0].then(function(e){t.resolve(e)}):e.list.splice(0,1)[0].then(function(e){t.resolve(e)})}();this.isDrainInProgress=!1}},e.prototype.throwIfDispose=function(){if(this.isDisposed())throw new Error(this.disposeReason);if(this.isDisposing)throw new Error("disposing queue")},e}();t.Queue=o},195:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SystemMediaDeviceKind={audioInput:"audioinput",audioOutput:"audiooutput",videoInput:"videoinput"}},196:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RIFFConstants={chunkIdSize:4,chunkLengthSize:4,minHeaderLength:44,riffChunkId:"RIFF",dataChunkId:"data"},t.RIFFHeadersOffset={riffHeaderId:0,fileSize:4,waveTag:8,waveFormatChunkLength:16,formatTag:20,channelCount:22,sampleRate:24,avgBytesPerSec:28,blockAlign:32,bitsPerSample:34,cbSize:36}},197:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e){this.skillId=e,this.providerCallback=null}return e.prototype.registerCallback=function(e){this.providerCallback=e},e.prototype.clearCallback=function(){this.providerCallback=null},e.prototype.triggerConfigUpdated=function(){this.providerCallback&&this.providerCallback(this.skillId)},e}();t.CortanaConfigProviderBase=i},198:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CortanaJSEvents={listeningStarted:"listeningStarted",recognitionStarted:"recognitionStarted",recognitionEnded:"recognitionEnded",speechStartDetected:"speechStartDetected",speechEndDetected:"speechEndDetected",speechHypothesis:"speechHypothesis",speechPhrase:"speechPhrase",cortanaResponded:"cortanaResponded",clientSkillInvoked:"clientSkillInvoked"};!function(e){e[e.Listening=0]="Listening",e[e.Responding=1]="Responding",e[e.Other=2]="Other"}(t.CancelState||(t.CancelState={}))},199:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RecognitionStatus={Success:"Success",NoMatch:"NoMatch",InitialSilenceTimeout:"InitialSilenceTimeout",BabbleTimeout:"BabbleTimeout",Error:"Error",EndOfDictation:"EndOfDictation"};!function(e){e[e.Success=0]="Success",e[e.AudioSourceError=1]="AudioSourceError",e[e.AudioSourceTimeout=2]="AudioSourceTimeout",e[e.AuthTokenFetchError=3]="AuthTokenFetchError",e[e.ConnectTimeout=4]="ConnectTimeout",e[e.ConnectError=5]="ConnectError",e[e.UnknownError=6]="UnknownError",e[e.Canceled=7]="Canceled",e[e.SpeechReadyTimeout=8]="SpeechReadyTimeout"}(t.RecognitionCompletionStatus||(t.RecognitionCompletionStatus={})),t.SpeechConfigScenarios={cortana:"Cortana",transcription:"Transcription",dictation:"Dictation"}},200:function(e,t,n){"use strict";var i=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(t,"__esModule",{value:!0});var o=n(31);t.RecognitionEvents={listeningStarted:"ListeningStartedEvent",recognitionStarted:"RecognitionStartedEvent",speechStartDetected:"SpeechStartDetectedEvent",speechHypothesis:"SpeechHypothesisEvent",speechEndDetected:"SpeechEndDetectedEvent",speechSimplePhrase:"SpeechSimplePhraseEvent",speechDetailedPhrase:"SpeechDetailedPhraseEvent",recognitionEnded:"RecognitionEndedEvent",cortanaResponded:"CortanaResponseEvent"};var r=function(){return function(e,t,n,i,r){this.eventName=e,this.requestId=t,this.serviceTag=n,this.connectionId=i,this.isRequestCanceled=r,this.eventId=o.CortanaUtilities.createNoDashGuid(),this.eventTime=Date.now()}}();t.SpeechRecognitionEvent=r;var s=function(e){function t(t,n,i,o,r,s){var a=e.call(this,t,n,o,r,s)||this;return a.result=i,a}return i(t,e),t}(r);t.SpeechRecognitionResultEvent=s;var a=function(e){function n(n){return e.call(this,t.RecognitionEvents.listeningStarted,n)||this}return i(n,e),n}(r);t.ListeningStartedEvent=a;var c=function(e){function n(n,i,o){return e.call(this,t.RecognitionEvents.recognitionStarted,n,i,o)||this}return i(n,e),n}(r);t.RecognitionStartedEvent=c;var l=function(e){function n(n,i,o,r,s,a,c,l,u){return e.call(this,t.RecognitionEvents.recognitionEnded,n,{status:o,error:r,audioResponseElapsedTime:l,audioResponsePayloadSize:u,counters:a},i,s,c)||this}return i(n,e),n}(s);t.RecognitionEndedEvent=l;var u=function(e){function n(n,i){return e.call(this,t.RecognitionEvents.speechStartDetected,n,i)||this}return i(n,e),n}(s);t.SpeechStartDetectedEvent=u;var d=function(e){function n(n,i){return e.call(this,t.RecognitionEvents.speechEndDetected,n,i)||this}return i(n,e),n}(s);t.SpeechEndDetectedEvent=d;var p=function(e){function n(n,i){return e.call(this,t.RecognitionEvents.speechHypothesis,n,i)||this}return i(n,e),n}(s);t.SpeechHypothesisEvent=p;var h=function(e){function n(n,i){return e.call(this,t.RecognitionEvents.speechSimplePhrase,n,i)||this}return i(n,e),n}(s);t.SpeechSimplePhraseEvent=h;var g=function(e){function n(n,i){return e.call(this,t.RecognitionEvents.speechDetailedPhrase,n,i)||this}return i(n,e),n}(s);t.SpeechDetailedPhraseEvent=g;var v=function(e){function n(n,i,o,r){return e.call(this,t.RecognitionEvents.cortanaResponded,n,r,i,o)||this}return i(n,e),n}(s);t.CortanaResponseEvent=v},31:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){}return e.createGuid=function(){var t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(e.xyRegExp,function(e){var n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?n:3&n|8).toString(16)})},e.createNoDashGuid=function(){return e.createGuid().replace(e.dashRegExp,"")},e.xyRegExp=new RegExp("[xy]","g"),e.dashRegExp=new RegExp("-","g"),e}();t.CortanaUtilities=i},49:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});!function(e){e[e.Simple=0]="Simple",e[e.Detailed=1]="Detailed"}(t.SpeechResultFormat||(t.SpeechResultFormat={}));!function(e){e[e.None=0]="None",e[e.Connected=1]="Connected",e[e.Connecting=2]="Connecting",e[e.Disconnected=3]="Disconnected"}(t.ConnectionState||(t.ConnectionState={}));!function(e){e[e.Text=0]="Text",e[e.Binary=1]="Binary"}(t.MessageType||(t.MessageType={}));!function(e){e[e.Success=0]="Success",e[e.Error=1]="Error",e[e.Timeout=2]="Timeout",e[e.TokenFetchError=3]="TokenFetchError"}(t.ConnectStatus||(t.ConnectStatus={})),t.SpeechConnectionEvents={connectionEstablished:"ConnectionEstablishedEvent",connectionClosed:"ConnectionClosedEvent",connectionError:"ConnectionErrorEvent"}},75:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this.subscriptions=new Map,this.subTokenNum=1,this.subsByNum={}}return e.prototype.subscribe=function(e,t){this.subscriptions.has(t)?this.subscriptions.get(t).push(e):this.subscriptions.set(t,[e]);var n=this.subTokenNum++;return this.subsByNum[n]={key:t,callback:e},n},e.prototype.unsubscribe=function(e){if(this.subsByNum[e]){var t=this.subsByNum[e].key,n=this.subsByNum[e].callback;if(delete this.subsByNum[e],this.subscriptions.has(t))for(var i=this.subscriptions.get(t),o=0;o<i.length;o++)i[o]===n&&(i.splice(o,1),0===i.length&&this.subscriptions.delete(t))}},e.prototype.clearSubscriptions=function(){this.subscriptions.clear(),this.subsByNum={},this.subTokenNum=1},e.prototype.trigger=function(e,t){if(this.subscriptions.has(e)){var n=[];this.subscriptions.get(e).forEach(function(e){n=n.concat(e)});var i=[];n.forEach(function(n){try{n(e,t)}catch(e){i.push(e)}}),i.forEach(function(e){return console.log(e)})}},e}();t.EventSource=i}},[1588]);
//# sourceMappingURL=https://statics.teams.microsoft.com/hashedjs/lazy-ng1-mod-cortana-services.min.js-dcfe91b5.map